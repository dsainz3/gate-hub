# =========================
# HUSKERS SCRIPTS (drop-in)
# =========================
# Expectation:
# configuration.yaml -> script: !include scripts.yaml

# --- Theater Show (Start) ---
huskers_theater_show_start:
  alias: 'Huskers: Theater Show (Start)'
  mode: restart
  variables:
    snapshot_id: huskers_theater_pre_show
    watch_scripts: []
  sequence:
    - variables:
        running_scripts: >-
          {{ watch_scripts | select('truthy')
             | select('in', states | map(attribute='entity_id') | list)
             | select('equalto','on', attribute='state') | list }}
    - service: input_text.set_value
      target:
        entity_id: input_text.huskers_theater_prev_scripts
      data:
        value: >-
          {{ running_scripts | join(',') }}

    # Snapshot current theater lights
    - service: scene.create
      data:
        scene_id: '{{ snapshot_id }}'
        snapshot_entities:
          - light.light_theater_left
          - light.light_theater_right

    # Instant start: Left=Scarlet, Right=Cream (no transition)
    - parallel:
        - service: light.turn_on
          target:
            entity_id: light.light_theater_left
          data:
            brightness: 255
            hs_color: [355, 90]
        - service: light.turn_on
          target:
            entity_id: light.light_theater_right
          data:
            brightness: 255
            hs_color: [48, 12]

    # Rotate every 3 seconds until stopped
    - repeat:
        while: '{{ true }}'
        sequence:
          - delay: '00:00:03'
          - parallel:
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_left
                data:
                  brightness: 255
                  hs_color: [48, 12]
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_right
                data:
                  brightness: 255
                  hs_color: [355, 90]
          - delay: '00:00:03'
          - parallel:
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_left
                data:
                  brightness: 255
                  hs_color: [355, 90]
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_right
                data:
                  brightness: 255
                  hs_color: [48, 12]

# --- Theater Show (Stop) ---
huskers_theater_show_stop:
  alias: 'Huskers: Theater Show (Stop)'
  mode: single
  variables:
    snapshot_id: huskers_theater_pre_show
  sequence:
    - service: script.turn_off
      target:
        entity_id: script.huskers_theater_show_start
    - choose:
        - conditions: "{{ states('scene.' ~ snapshot_id) != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: 'scene.{{ snapshot_id }}'
              data:
                transition: 1
            - delay: '00:00:01'
            - service: scene.delete
              data:
                entity_id: 'scene.{{ snapshot_id }}'
      default: []
    - variables:
        prev: "{{ states('input_text.huskers_theater_prev_scripts') | trim }}"
        prev_list: >-
          {% set parts = prev.split(',') if prev else [] %}
          {{ parts | select('trim') | select('length') | list }}
    - choose:
        - conditions: '{{ prev_list | length > 0 }}'
          sequence:
            - repeat:
                for_each: '{{ prev_list }}'
                sequence:
                  - service: script.turn_on
                    target:
                      entity_id: '{{ repeat.item }}'
    - service: input_text.set_value
      target:
        entity_id: input_text.huskers_theater_prev_scripts
      data:
        value: ''

huskers_exterior_show_start:
  alias: 'Huskers: Exterior Show (Start)'
  mode: restart
  variables:
    snap_id: huskers_exterior_pre_show
  sequence:
    - service: scene.create
      data:
        scene_id: '{{ snap_id }}'
        snapshot_entities:
          - light.light_front_left
          - light.light_front_right
          - light.garage_l
          - light.garage_c
          - light.garage_r

    # Instant start: FL/GL/GR=scarlet, FR/GC=cream
    - parallel:
        # Front Left
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.light_front_left',
                    'supported_color_modes') or [])
                       or 'xy' in (state_attr('light.light_front_left',
                    'supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.light_front_left',
                    'supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.light_front_left }
                  data: { brightness: 255, hs_color: [355, 90] }
          default:
            - service: light.turn_on
              target: { entity_id: light.light_front_left }
              data: { brightness: 255 }
        # Front Right
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.light_front_right',
                    'supported_color_modes') or [])
                       or 'xy' in (state_attr('light.light_front_right',
                    'supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.light_front_right',
                    'supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.light_front_right }
                  data: { brightness: 255, hs_color: [48, 12] }
          default:
            - service: light.turn_on
              target: { entity_id: light.light_front_right }
              data: { brightness: 128 }
        # Garage L
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.garage_l',
                    'supported_color_modes') or [])
                       or 'xy' in (state_attr('light.garage_l',
                    'supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.garage_l',
                    'supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.garage_l }
                  data: { brightness: 255, hs_color: [355, 90] }
          default:
            - service: light.turn_on
              target: { entity_id: light.garage_l }
              data: { brightness: 255 }
        # Garage C
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.garage_c',
                    'supported_color_modes') or [])
                       or 'xy' in (state_attr('light.garage_c',
                    'supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.garage_c',
                    'supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.garage_c }
                  data: { brightness: 255, hs_color: [48, 12] }
          default:
            - service: light.turn_on
              target: { entity_id: light.garage_c }
              data: { brightness: 128 }
        # Garage R
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.garage_r',
                    'supported_color_modes') or [])
                       or 'xy' in (state_attr('light.garage_r',
                    'supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.garage_r',
                    'supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.garage_r }
                  data: { brightness: 255, hs_color: [355, 90] }
          default:
            - service: light.turn_on
              target: { entity_id: light.garage_r }
              data: { brightness: 255 }

    # Alternate every 3s until stopped
    - repeat:
        while: '{{ true }}'
        sequence:
          - delay: '00:00:03'
          # Invert: FL/GL/GR=cream, FR/GC=scarlet
          - parallel:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_left',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.light_front_left',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.light_front_left',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.light_front_left }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.light_front_left }
                    data: { brightness: 128 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_right',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.light_front_right',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.light_front_right',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.light_front_right }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.light_front_right }
                    data: { brightness: 255 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_l',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_l',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_l',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_l }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_l }
                    data: { brightness: 128 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_c',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_c',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_c',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_c }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_c }
                    data: { brightness: 255 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_r',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_r',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_r',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_r }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_r }
                    data: { brightness: 128 }
          - delay: '00:00:03'
          # Back to original mapping
          - parallel:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_left',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.light_front_left',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.light_front_left',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.light_front_left }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.light_front_left }
                    data: { brightness: 255 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_right',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.light_front_right',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.light_front_right',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.light_front_right }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.light_front_right }
                    data: { brightness: 128 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_l',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_l',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_l',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_l }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_l }
                    data: { brightness: 255 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_c',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_c',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_c',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_c }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_c }
                    data: { brightness: 128 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_r',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_r',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_r',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_r }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_r }
                    data: { brightness: 255 }

# --- Exterior Show (Stop) ---
huskers_exterior_show_stop:
  alias: 'Huskers: Exterior Show (Stop)'
  mode: single
  sequence:
    - service: light.turn_off
      target:
        entity_id:
          - light.light_front_left
          - light.light_front_right
          - light.garage_l
          - light.garage_c
          - light.garage_r

# --- Bursts ---
huskers_touchdown_burst:
  alias: 'Huskers: Theater Touchdown Burst'
  mode: restart
  sequence:
    - service: light.turn_on
      target:
        entity_id:
          - light.light_theater_left
          - light.light_theater_right
      data: { flash: short }

huskers_exterior_touchdown_burst:
  alias: 'Huskers: Exterior Touchdown Burst'
  mode: restart
  sequence:
    - service: light.turn_on
      target:
        entity_id:
          - light.light_front_left
          - light.light_front_right
          - light.garage_l
          - light.garage_c
          - light.garage_r
      data: { flash: short }

# --- Test helper ---
huskers_test_score_update:
  alias: 'Huskers: ðŸ§ª Simulate Score + Burst'
  mode: single
  sequence:
    - service: input_text.set_value
      target:
        entity_id: input_text.huskers_last_score
      data: { value: 'NU TD (test)' }
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_touchdown_burst
          - script.huskers_exterior_touchdown_burst

# --- Game-day LED (snapshot + effect + restore) ---
huskers_led_gameday_start:
  alias: 'Huskers: Game-Day LED (Start)'
  mode: single
  sequence:
    - service: scene.create
      data:
        scene_id: huskers_outdoor_pre_gameday
        snapshot_entities:
          - light.permanent_outdoor_lights
    - service: light.turn_on
      target: { entity_id: light.permanent_outdoor_lights }
      data: { effect: LED_Huskers }

huskers_led_stop:
  alias: 'Huskers: Stop LED Effect (Restore Previous)'
  mode: single
  variables: { snapshot_id: huskers_outdoor_pre_gameday }
  sequence:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states('scene.' ~ snapshot_id) != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              target: { entity_id: 'scene.{{ snapshot_id }}' }
              data: { transition: 1 }
            - delay: '00:00:01'
            - service: scene.delete
              data: { entity_id: 'scene.{{ snapshot_id }}' }
      default: []

huskers_td_burst_bpm_theater:
  alias: 'Huskers: TD Burst BPM (Theater)'
  mode: restart
  variables:
    bpm_val: >-
      {{ states('input_number.huskers_hail_varsity_bpm') | int(120) }}
    beat_s: '{{ (60 / bpm_val) | float }}'
    pulse_ratio: 0.2
    pulse_s: '{{ (beat_s * pulse_ratio) | float }}'
    rest_s: '{{ (beat_s * (1 - pulse_ratio)) | float }}'
    beats: 8
    snap_id: huskers_theater_burst_pre
  sequence:
    - service: scene.create
      data:
        scene_id: '{{ snap_id }}'
        snapshot_entities:
          - light.light_theater_left
          - light.light_theater_right
    - repeat:
        count: '{{ beats }}'
        sequence:
          - parallel:
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_left
                data:
                  brightness: 255
                  hs_color: [0, 0]
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_right
                data:
                  brightness: 255
                  hs_color: [0, 0]
          - delay: '{{ pulse_s }}'
          - service: scene.turn_on
            target:
              entity_id: 'scene.{{ snap_id }}'
          - delay: '{{ rest_s }}'
    - choose:
        - conditions: "{{ states('scene.' ~ snap_id) != 'unknown' }}"
          sequence:
            - service: scene.delete
              data:
                entity_id: 'scene.{{ snap_id }}'

huskers_td_burst_bpm_exterior:
  alias: 'Huskers: TD Burst BPM (Exterior)'
  mode: restart
  variables:
    bpm_val: >-
      {{ states('input_number.huskers_hail_varsity_bpm') | int(120) }}
    beat_s: '{{ (60 / bpm_val) | float }}'
    pulse_ratio: 0.2
    pulse_s: '{{ (beat_s * pulse_ratio) | float }}'
    rest_s: '{{ (beat_s * (1 - pulse_ratio)) | float }}'
    beats: 8
    snap_id: huskers_exterior_burst_pre
  sequence:
    - service: scene.create
      data:
        scene_id: '{{ snap_id }}'
        snapshot_entities:
          - light.light_front_left
          - light.light_front_right
          - light.garage_l
          - light.garage_c
          - light.garage_r
    - repeat:
        count: '{{ beats }}'
        sequence:
          - parallel:
              # FL
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_left',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.light_front_left',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.light_front_left',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: light.light_front_left
                        data: { brightness: 255, hs_color: [0, 0] }
                default:
                  - service: light.turn_on
                    target:
                      entity_id: light.light_front_left
                    data: { brightness: 255 }
              # FR
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_right',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.light_front_right',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.light_front_right',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: light.light_front_right
                        data: { brightness: 255, hs_color: [0, 0] }
                default:
                  - service: light.turn_on
                    target:
                      entity_id: light.light_front_right
                    data: { brightness: 255 }
              # GL
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_l',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_l',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_l',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_l }
                        data: { brightness: 255, hs_color: [0, 0] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_l }
                    data: { brightness: 255 }
              # GC
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_c',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_c',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_c',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_c }
                        data: { brightness: 255, hs_color: [0, 0] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_c }
                    data: { brightness: 255 }
              # GR
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_r',
                          'supported_color_modes') or [])
                             or 'xy' in (state_attr(
                          'light.garage_r',
                          'supported_color_modes') or [])
                             or 'rgb' in (state_attr(
                          'light.garage_r',
                          'supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_r }
                        data: { brightness: 255, hs_color: [0, 0] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_r }
                    data: { brightness: 255 }
          - delay: '{{ pulse_s }}'
          - service: scene.turn_on
            target:
              entity_id: 'scene.{{ snap_id }}'
          - delay: '{{ rest_s }}'
    - choose:
        - conditions: "{{ states('scene.' ~ snap_id) != 'unknown' }}"
          sequence:
            - service: scene.delete
              data:
                entity_id: 'scene.{{ snap_id }}'
