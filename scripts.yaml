# =========================
# HUSKERS SCRIPTS (drop-in)
# =========================
# Expectation:
# configuration.yaml -> script: !include scripts.yaml

# --- Theater Show (Start) ---
huskers_theater_show_start:
  alias: 'Huskers: Theater Show (Start)'
  mode: restart
  variables:
    snapshot_id: huskers_theater_pre_show
    watch_scripts: []
  sequence:
    - variables:
        running_scripts: >-
          {{ watch_scripts | select('truthy')
             | select('in', states | map(attribute='entity_id') | list)
             | select('equalto','on', attribute='state') | list }}
    - service: input_text.set_value
      target:
        entity_id: input_text.huskers_theater_prev_scripts
      data:
        value: >-
          {{ running_scripts | join(',') }}
    - service: scene.create
      data:
        scene_id: '{{ snapshot_id }}'
        snapshot_entities:
          - light.light_theater_left
          - light.light_theater_right
    - parallel:
        - service: light.turn_on
          target:
            entity_id: light.light_theater_left
          data:
            brightness: 255
            hs_color: [355, 90]
        - service: light.turn_on
          target:
            entity_id: light.light_theater_right
          data:
            brightness: 255
            hs_color: [48, 12]
    - repeat:
        while: '{{ true }}'
        sequence:
          - delay: '00:00:03'
          - parallel:
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_left
                data:
                  brightness: 255
                  hs_color: [48, 12]
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_right
                data:
                  brightness: 255
                  hs_color: [355, 90]
          - delay: '00:00:03'
          - parallel:
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_left
                data:
                  brightness: 255
                  hs_color: [355, 90]
              - service: light.turn_on
                target:
                  entity_id: light.light_theater_right
                data:
                  brightness: 255
                  hs_color: [48, 12]

# --- Theater Show (Stop) ---
huskers_theater_show_stop:
  alias: 'Huskers: Theater Show (Stop)'
  mode: single
  variables:
    snapshot_id: huskers_theater_pre_show
  sequence:
    - service: script.turn_off
      target:
        entity_id: script.huskers_theater_show_start
    - choose:
        - conditions: "{{ states('scene.' ~ snapshot_id) != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: 'scene.{{ snapshot_id }}'
              data:
                transition: 1
            - delay: '00:00:01'
            - service: scene.delete
              data:
                entity_id: 'scene.{{ snapshot_id }}'
      default: []
    - variables:
        prev: "{{ states('input_text.huskers_theater_prev_scripts') | trim }}"
        prev_list: >-
          {% set parts = prev.split(',') if prev else [] %}
          {{ parts | select('trim') | select('length') | list }}
    - choose:
        - conditions: '{{ prev_list | length > 0 }}'
          sequence:
            - repeat:
                for_each: '{{ prev_list }}'
                sequence:
                  - service: script.turn_on
                    target:
                      entity_id: '{{ repeat.item }}'
    - service: input_text.set_value
      target:
        entity_id: input_text.huskers_theater_prev_scripts
      data:
        value: ''

# --- Exterior Show (Start) ---
huskers_exterior_show_start:
  alias: 'Huskers: Exterior Show (Start)'
  mode: restart
  variables:
    snap_id: huskers_exterior_pre_show
  sequence:
    - service: scene.create
      data:
        scene_id: '{{ snap_id }}'
        snapshot_entities:
          - light.light_front_left
          - light.light_front_right
          - light.garage_left
          - light.garage_center
          - light.garage_right
    # Instant start: FL/GL/GR=scarlet, FR/GC=cream
    - parallel:
        # Front Left
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.light_front_left','supported_color_modes') or [])
                       or 'xy' in (state_attr('light.light_front_left','supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.light_front_left','supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.light_front_left }
                  data: { brightness: 255, hs_color: [355, 90] }
          default:
            - service: light.turn_on
              target: { entity_id: light.light_front_left }
              data: { brightness: 255 }
        # Front Right
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.light_front_right','supported_color_modes') or [])
                       or 'xy' in (state_attr('light.light_front_right','supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.light_front_right','supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.light_front_right }
                  data: { brightness: 255, hs_color: [48, 12] }
          default:
            - service: light.turn_on
              target: { entity_id: light.light_front_right }
              data: { brightness: 128 }
        # Garage L
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.garage_left','supported_color_modes') or [])
                       or 'xy' in (state_attr('light.garage_left','supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.garage_left','supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.garage_left }
                  data: { brightness: 255, hs_color: [355, 90] }
          default:
            - service: light.turn_on
              target: { entity_id: light.garage_left }
              data: { brightness: 255 }
        # Garage C
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.garage_center','supported_color_modes') or [])
                       or 'xy' in (state_attr('light.garage_center','supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.garage_center','supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.garage_center }
                  data: { brightness: 255, hs_color: [48, 12] }
          default:
            - service: light.turn_on
              target: { entity_id: light.garage_center }
              data: { brightness: 128 }
        # Garage R
        - choose:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'hs' in (state_attr('light.garage_right','supported_color_modes') or [])
                       or 'xy' in (state_attr('light.garage_right','supported_color_modes') or [])
                       or 'rgb' in (state_attr('light.garage_right','supported_color_modes') or []) }}
              sequence:
                - service: light.turn_on
                  target: { entity_id: light.garage_right }
                  data: { brightness: 255, hs_color: [355, 90] }
          default:
            - service: light.turn_on
              target: { entity_id: light.garage_right }
              data: { brightness: 255 }
    # Alternate every 3s until stopped
    - repeat:
        while: '{{ true }}'
        sequence:
          - delay: '00:00:03'
          # Invert: FL/GL/GR=cream, FR/GC=scarlet
          - parallel:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_left','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.light_front_left','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.light_front_left','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.light_front_left }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.light_front_left }
                    data: { brightness: 128 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_right','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.light_front_right','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.light_front_right','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.light_front_right }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.light_front_right }
                    data: { brightness: 255 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_left','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.garage_left','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.garage_left','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_left }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_left }
                    data: { brightness: 128 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_center','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.garage_center','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.garage_center','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_center }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_center }
                    data: { brightness: 255 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_right','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.garage_right','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.garage_right','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_right }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_right }
                    data: { brightness: 128 }
          - delay: '00:00:03'
          # Back to original mapping
          - parallel:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_left','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.light_front_left','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.light_front_left','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.light_front_left }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.light_front_left }
                    data: { brightness: 255 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.light_front_right','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.light_front_right','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.light_front_right','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.light_front_right }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.light_front_right }
                    data: { brightness: 128 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_left','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.garage_left','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.garage_left','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_left }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_left }
                    data: { brightness: 255 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_center','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.garage_center','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.garage_center','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_center }
                        data: { brightness: 255, hs_color: [48, 12] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_center }
                    data: { brightness: 128 }
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ 'hs' in (state_attr('light.garage_right','supported_color_modes') or [])
                             or 'xy' in (state_attr('light.garage_right','supported_color_modes') or [])
                             or 'rgb' in (state_attr('light.garage_right','supported_color_modes') or []) }}
                    sequence:
                      - service: light.turn_on
                        target: { entity_id: light.garage_right }
                        data: { brightness: 255, hs_color: [355, 90] }
                default:
                  - service: light.turn_on
                    target: { entity_id: light.garage_right }
                    data: { brightness: 255 }

# --- Exterior Show (Stop) ---
huskers_exterior_show_stop:
  alias: 'Huskers: Exterior Show (Stop)'
  mode: single
  variables:
    snap_id: huskers_exterior_pre_show
  sequence:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.huskers_exterior_color_show
              state: 'on'
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.huskers_exterior_color_show
    - service: script.turn_off
      target:
        entity_id: script.huskers_exterior_show_start
    - delay: '00:00:01'
    - choose:
        - conditions:
            - condition: template
              value_template: >-
                {{ states('scene.' ~ snap_id) != 'unknown' }}
          sequence:
            - service: scene.turn_on
              target:
                entity_id: 'scene.{{ snap_id }}'
              data:
                transition: 0
            - delay: '00:00:01'
            - service: scene.delete
              data:
                entity_id: 'scene.{{ snap_id }}'
      default:
        - service: light.turn_off
          target:
            entity_id:
              - light.light_front_left
              - light.light_front_right
              - light.garage_left
              - light.garage_center
              - light.garage_right

# --- Bursts ---
huskers_touchdown_burst:
  alias: 'Huskers: Theater Touchdown Burst'
  mode: restart
  sequence:
    - service: light.turn_on
      target:
        entity_id:
          - light.light_theater_left
          - light.light_theater_right
      data: { flash: short }

huskers_exterior_touchdown_burst:
  alias: 'Huskers: Exterior Touchdown Burst'
  mode: restart
  sequence:
    - service: light.turn_on
      target:
        entity_id:
          - light.light_front_left
          - light.light_front_right
          - light.garage_left
          - light.garage_center
          - light.garage_right
      data: { flash: short }

# --- Test helper ---
huskers_test_score_update:
  alias: 'Huskers: ðŸ§ª Simulate Score + Burst'
  mode: single
  sequence:
    - service: input_text.set_value
      target:
        entity_id: input_text.huskers_last_score
      data: { value: 'NU TD (test)' }
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_touchdown_burst
          - script.huskers_exterior_touchdown_burst

# --- Game-day LED (set to Gametime) ---
huskers_led_gameday_start:
  alias: 'Huskers: Game-Day LED (Start â†’ LED_Gametime)'
  mode: single
  sequence:
    - service: light.turn_on
      target: { entity_id: light.permanent_outdoor_lights }
      data: { effect: LED_Gametime }

# --- Stop LED Effect (restore to last scene if you use one elsewhere) ---
huskers_led_stop:
  alias: 'Huskers: Stop LED Effect'
  mode: single
  sequence:
    - service: light.turn_on
      target: { entity_id: light.permanent_outdoor_lights }
      data: {}

# --- LED TD Burst â†’ LED_TD_Burst for 30s â†’ back to LED_Gametime ---
huskers_led_td_burst:
  alias: 'Huskers: LED TD Burst (30s then Gametime)'
  mode: restart
  sequence:
    - service: light.turn_on
      target: { entity_id: light.permanent_outdoor_lights }
      data: { effect: LED_TD_Burst }
    - delay: '00:00:30'
    - service: light.turn_on
      target: { entity_id: light.permanent_outdoor_lights }
      data: { effect: LED_Gametime }

# ---------------------------------------------------------
# One-tap â€œRun Allâ€ for pre-game checking
# ---------------------------------------------------------
huskers_all_events_manual:
  alias: 'Huskers: Run All (Manual)'
  mode: single
  sequence:
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_led_gameday_start
          - script.huskers_theater_show_start
          - script.huskers_exterior_show_start
    - delay: '00:00:05'
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_td_burst_bpm_theater
          - script.huskers_td_burst_bpm_exterior
          - script.huskers_led_td_burst

huskers_all_events_manual2:
  alias: 'Huskers: Run All (Manual 2)'
  mode: single
  sequence:
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_theater_show_start
          - script.huskers_exterior_show_start
          - script.huskers_led_gameday_start
    - delay: '00:00:02'
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_td_burst_bpm_theater
          - script.huskers_td_burst_bpm_exterior
          - script.huskers_led_td_burst

# --- BPM Bursts (Theater) ---
huskers_td_burst_bpm_theater:
  alias: 'Huskers: TD Burst BPM (Theater)'
  mode: restart
  variables:
    bpm_val: >-
      {{ states('input_number.huskers_hail_varsity_bpm') | int(120) }}
    beat_s: '{{ (60 / bpm_val) | float }}'
    pulse_ratio: 0.2
    pulse_s: '{{ (beat_s * pulse_ratio) | float }}'
    rest_s: '{{ (beat_s * (1 - pulse_ratio)) | float }}'
    beats: 8
    snap_id: huskers_theater_burst_pre
  sequence:
    - service: scene.create
      data:
        scene_id: '{{ snap_id }}'
        snapshot_entities:
          - light.light_theater_left
          - light.light_theater_right
    - repeat:
        count: '{{ beats }}'
        sequence:
          - choose:
              - conditions: '{{ (repeat.index | int(1)) % 2 == 1 }}'
                sequence:
                  - parallel:
                      - service: light.turn_on
                        target:
                          entity_id: light.light_theater_left
                        data:
                          brightness: 255
                          hs_color: [355, 90]
                      - service: light.turn_on
                        target:
                          entity_id: light.light_theater_right
                        data:
                          brightness: 255
                          hs_color: [48, 12]
            default:
              - parallel:
                  - service: light.turn_on
                    target:
                      entity_id: light.light_theater_left
                    data:
                      brightness: 255
                      hs_color: [48, 12]
                  - service: light.turn_on
                    target:
                      entity_id: light.light_theater_right
                    data:
                      brightness: 255
                      hs_color: [355, 90]
          - delay: '{{ pulse_s }}'
          - service: scene.turn_on
            target:
              entity_id: 'scene.{{ snap_id }}'
          - delay: '{{ rest_s }}'
    - choose:
        - conditions: "{{ states('scene.' ~ snap_id) != 'unknown' }}"
          sequence:
            - service: scene.delete
              data:
                entity_id: 'scene.{{ snap_id }}'

# --- BPM Bursts (Exterior alternating Scarlet/Cream) ---
huskers_td_burst_bpm_exterior:
  alias: 'Huskers: TD Burst BPM (Exterior)'
  mode: restart
  variables:
    bpm_val: >-
      {{ states('input_number.huskers_hail_varsity_bpm') | int(120) }}
    beat_s: '{{ (60 / bpm_val) | float }}'
    pulse_ratio: 0.2
    pulse_s: '{{ (beat_s * pulse_ratio) | float }}'
    rest_s: '{{ (beat_s * (1 - pulse_ratio)) | float }}'
    beats: 8
    snap_id: huskers_exterior_burst_pre
  sequence:
    - service: scene.create
      data:
        scene_id: '{{ snap_id }}'
        snapshot_entities:
          - light.light_front_left
          - light.light_front_right
          - light.garage_left
          - light.garage_center
          - light.garage_right
    - repeat:
        count: '{{ beats }}'
        sequence:
          - parallel:
              - service: light.turn_on
                target: { entity_id: light.light_front_left }
                data:
                  brightness: 255
                  hs_color: >-
                    {% if (repeat.index | int(1)) % 2 == 1 %} [355, 90]
                    {% else %} [48, 12] {% endif %}
              - service: light.turn_on
                target: { entity_id: light.light_front_right }
                data:
                  brightness: 255
                  hs_color: >-
                    {% if (repeat.index | int(1)) % 2 == 1 %} [48, 12]
                    {% else %} [355, 90] {% endif %}
              - service: light.turn_on
                target: { entity_id: light.garage_left }
                data:
                  brightness: 255
                  hs_color: >-
                    {% if (repeat.index | int(1)) % 2 == 1 %} [355, 90]
                    {% else %} [48, 12] {% endif %}
              - service: light.turn_on
                target: { entity_id: light.garage_center }
                data:
                  brightness: 255
                  hs_color: >-
                    {% if (repeat.index | int(1)) % 2 == 1 %} [48, 12]
                    {% else %} [355, 90] {% endif %}
              - service: light.turn_on
                target: { entity_id: light.garage_right }
                data:
                  brightness: 255
                  hs_color: >-
                    {% if (repeat.index | int(1)) % 2 == 1 %} [355, 90]
                    {% else %} [48, 12] {% endif %}
          - delay: '{{ pulse_s }}'
          - service: scene.turn_on
            target: { entity_id: 'scene.{{ snap_id }}' }
          - delay: '{{ rest_s }}'
    - choose:
        - conditions: "{{ states('scene.' ~ snap_id) != 'unknown' }}"
          sequence:
            - service: scene.delete
              data:
                entity_id: 'scene.{{ snap_id }}'
