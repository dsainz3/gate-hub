---
# =========================================================
# CATEGORY: HUSKERS – PERMANENT OUTDOOR LEDs (GAME DAY)
# =========================================================

# PURPOSE: Start Huskers effect on permanent outdoor LEDs.
# UPGRADE: Takes a snapshot first so you can restore cleanly on stop.
huskers_led_gameday_start:
  alias: Start Game-Day Effect
  mode: single
  sequence:
    # Snapshot current state of permanent outdoor lights
    - service: scene.create
      data:
        scene_id: huskers_outdoor_pre_gameday
        snapshot_entities:
          - light.permanent_outdoor_lights

    # Apply Huskers effect (must exist in effect_list)
    - service: light.turn_on
      target:
        entity_id: light.permanent_outdoor_lights
      data:
        effect: LED_Huskers

# PURPOSE: Stop Huskers effect and restore pre-game snapshot if available.
# FALLBACK: If no snapshot exists (first run, HA restart), just turn lights off.
huskers_led_stop:
  alias: Stop Effect (Restore Previous)
  mode: single
  variables:
    snapshot_scene: scene.huskers_outdoor_pre_gameday
  sequence:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states(snapshot_scene) != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              data:
                entity_id: '{{ snapshot_scene }}'
                transition: 1
            - delay: 0.1
            - service: scene.delete
              data:
                entity_id: '{{ snapshot_scene }}'
      default:
        - service: light.turn_off
          target:
            entity_id: light.permanent_outdoor_lights

# PURPOSE: Re-apply your "Monthly" effect explicitly.
# NOTE: Keeps this separate from stop/restore so your midnight scheduler can still run.
huskers_led_revert_monthly:
  alias: Revert to Monthly Effect
  mode: single
  sequence:
    - service: light.turn_on
      target:
        entity_id: light.permanent_outdoor_lights
      data:
        effect: Monthly

# =========================================================
# CATEGORY: HUSKERS – THEATER (BURST & COLOR SHOW)
# =========================================================

# PURPOSE: 12-hit alternating scarlet/cream "touchdown burst" on theater lights.
# FEATURES: Snapshots and restores previous state.
huskers_touchdown_burst:
  alias: 'Huskers: Touchdown Burst (Theater Alternating, Snapshot/Restore)'
  mode: restart
  variables:
    snapshot_scene: scene.huskers_theater_pre_burst
  sequence:
    # 1) Snapshot
    - service: scene.create
      data:
        scene_id: huskers_theater_pre_burst
        snapshot_entities:
          - light.light_theater_left
          - light.light_theater_right

    # 2) Burst variables
    - variables:
        flashes: 6 # total swaps (12 color hits)
        on_time: 0.35
        trans: 0.25

    # 3) Alternate Scarlet <-> Cream
    - repeat:
        count: '{{ flashes }}'
        sequence:
          - service: light.turn_on
            target: { entity_id: light.light_theater_left }
            data: { hs_color: [355, 90], brightness: 255, transition: '{{ trans }}' }
          - service: light.turn_on
            target: { entity_id: light.light_theater_right }
            data: { hs_color: [48, 12], brightness: 255, transition: '{{ trans }}' }
          - delay: '{{ on_time }}'
          - service: light.turn_on
            target: { entity_id: light.light_theater_left }
            data: { hs_color: [48, 12], brightness: 255, transition: '{{ trans }}' }
          - service: light.turn_on
            target: { entity_id: light.light_theater_right }
            data: { hs_color: [355, 90], brightness: 255, transition: '{{ trans }}' }
          - delay: '{{ on_time }}'

    # 4) Restore snapshot (guarded)
    - delay: 0.2
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states(snapshot_scene) != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              data:
                entity_id: '{{ snapshot_scene }}'
                transition: 1.0
            - service: scene.delete
              data:
                entity_id: '{{ snapshot_scene }}'

# PURPOSE: Start an alternating scarlet/cream theater show until turned off.
# CONTROL: Uses input_boolean.huskers_color_show as the run/stop flag.
huskers_theater_show_start:
  alias: 'Huskers: Theater Show (Start)'
  mode: restart
  variables:
    snapshot_scene: scene.huskers_theater_show_restore
  sequence:
    - service: scene.create
      data:
        scene_id: huskers_theater_show_restore
        snapshot_entities:
          - light.light_theater_left
          - light.light_theater_right

    - service: input_boolean.turn_on
      target: { entity_id: input_boolean.huskers_color_show }

    # Seed colors
    - service: light.turn_on
      target: { entity_id: light.light_theater_left }
      data: { hs_color: [48, 12], brightness: 255 }
    - service: light.turn_on
      target: { entity_id: light.light_theater_right }
      data: { hs_color: [355, 90], brightness: 255 }

    # Alternate while the boolean remains on
    - repeat:
        while:
          - condition: state
            entity_id: input_boolean.huskers_color_show
            state: 'on'
        sequence:
          - service: light.turn_on
            target: { entity_id: light.light_theater_left }
            data: { hs_color: [355, 90], brightness: 255, transition: 10 }
          - service: light.turn_on
            target: { entity_id: light.light_theater_right }
            data: { hs_color: [48, 12], brightness: 255, transition: 10 }
          - delay: 10
          - service: light.turn_on
            target: { entity_id: light.light_theater_left }
            data: { hs_color: [48, 12], brightness: 255, transition: 10 }
          - service: light.turn_on
            target: { entity_id: light.light_theater_right }
            data: { hs_color: [355, 90], brightness: 255, transition: 10 }
          - delay: 10

    # Restore and cleanup (guarded)
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states(snapshot_scene) != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              data:
                entity_id: '{{ snapshot_scene }}'
            - service: scene.delete
              data:
                entity_id: '{{ snapshot_scene }}'
    - service: input_boolean.turn_off
      target: { entity_id: input_boolean.huskers_color_show }

# PURPOSE: Stop the theater color show (sets the run/stop flag off).
huskers_theater_show_stop:
  alias: 'Huskers: Theater Show (Stop)'
  mode: single
  sequence:
    - service: input_boolean.turn_off
      target: { entity_id: input_boolean.huskers_color_show }

# =========================================================
# CATEGORY: HUSKERS – TEST & PLACEHOLDERS
# =========================================================

huskers_update_last_score_test:
  alias: Update Last Score (Test)
  mode: single
  sequence:
    - service: input_text.set_value
      target: { entity_id: input_text.huskers_last_score }
      data: { value: 'Test Score Update' }

huskers_hail_varsity_show_start:
  alias: 'Huskers: Hail Varsity Show (Start)'
  mode: restart
  sequence:
    - service: logbook.log
      data: { name: 'Huskers – Hail Varsity', message: 'Start show: TODO implement sequence.' }

huskers_hail_varsity_show_stop:
  alias: 'Huskers: Hail Varsity Show (Stop)'
  mode: restart
  sequence:
    - service: logbook.log
      data: { name: 'Huskers – Hail Varsity', message: 'Stop show: TODO implement sequence.' }

huskers_test_our_score:
  alias: 'Huskers (Test): Our Score'
  mode: single
  sequence:
    - service: logbook.log
      data: { name: 'Huskers – Test', message: 'Our Score: TODO implement action.' }

huskers_test_opponent_score:
  alias: 'Huskers (Test): Opponent Score'
  mode: single
  sequence:
    - service: logbook.log
      data: { name: 'Huskers – Test', message: 'Opponent Score: TODO implement action.' }

# =========================================================
# CATEGORY: HUSKERS – EXTERIOR SCENES HELPERS
# =========================================================
# These helpers apply your exterior alternating scenes with a 5s transition.
# Requires scenes from scenes.yaml:
#   - scene.huskers_alternating_exterior
#   - scene.huskers_alternating_exterior_inverted

huskers_exterior_alternating_start:
  alias: 'Huskers: Exterior Alternating – Start'
  mode: single
  variables:
    scene_id: scene.huskers_alternating_exterior
  sequence:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states(scene_id) != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              data:
                entity_id: '{{ scene_id }}'
                transition: 5
      default:
        - service: logbook.log
          data:
            name: 'Huskers – Exterior Scenes'
            message: 'Scene not found: {{ scene_id }} (did you reload Scenes?)'

huskers_exterior_alternating_inverted_start:
  alias: 'Huskers: Exterior Alternating (Inverted) – Start'
  mode: single
  variables:
    scene_id: scene.huskers_alternating_exterior_inverted
  sequence:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states(scene_id) != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              data:
                entity_id: '{{ scene_id }}'
                transition: 5
      default:
        - service: logbook.log
          data:
            name: 'Huskers – Exterior Scenes'
            message: 'Scene not found: {{ scene_id }} (did you reload Scenes?)'

# OPTIONAL: One-button toggle between normal and inverted exterior scenes.
huskers_exterior_alternating_toggle:
  alias: 'Huskers: Exterior Alternating – Toggle'
  mode: single
  sequence:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states('scene.huskers_alternating_exterior') != 'unknown' }}"
          sequence:
            - service: scene.turn_on
              data:
                entity_id: scene.huskers_alternating_exterior_inverted
                transition: 5
      default:
        - service: scene.turn_on
          data:
            entity_id: scene.huskers_alternating_exterior
            transition: 5
