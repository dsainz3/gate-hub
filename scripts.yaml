# ===============================
# Cream Chase Scripts (Standard 30s + Variable-Speed)
# Order (7): light.light_theater_left, light.light_theater_right, light.light_front_left, light.light_front_right, light.light_garage_left, light.lights_garage_center, light.light_garage_right
# Colors: Scarlet [355,90], Cream [45,20]
# ===============================

huskers_chase30_start:
  alias: 'Huskers: Start 30s Cream Chase'
  description: >
    Sets all target lights to Scarlet, snapshots state, and starts a 30-second
    Cream chase moving through Scarlet in the specified order.
  mode: restart
  sequence:
    - service: scene.create
      data:
        scene_id: huskers_before_chase30
        snapshot_entities:
          - light.light_theater_left
          - light.light_theater_right
          - light.light_front_left
          - light.light_front_right
          - light.light_garage_left
          - light.lights_garage_center
          - light.light_garage_right
    - service: light.turn_on
      target:
        entity_id:
          - light.light_theater_left
          - light.light_theater_right
          - light.light_front_left
          - light.light_front_right
          - light.light_garage_left
          - light.lights_garage_center
          - light.light_garage_right
      data:
        hs_color: [355, 90]
        brightness: 255
        transition: 0.1
    - service: script.turn_on
      target:
        entity_id: script.huskers_chase30_loop

huskers_chase30_loop:
  alias: 'Huskers: 30s Cream Chase LOOP'
  description: >
    Infinite loop: Cream moves through Scarlet across the 7 lights.
    Each step ≈ 4286ms (transition 100ms + hold 4186ms) → total ≈ 30s.
  mode: restart
  sequence:
    - variables:
        lights:
          [
            'light.light_theater_left',
            'light.light_theater_right',
            'light.light_front_left',
            'light.light_front_right',
            'light.light_garage_left',
            'light.lights_garage_center',
            'light.light_garage_right',
          ]
        transition_s: 0.1
        hold_ms: 4186
    - repeat:
        while:
          - condition: template
            value_template: '{{ true }}'
        sequence:
          - repeat:
              for_each: '{{ lights }}'
              sequence:
                - variables:
                    current: '{{ repeat.item }}'
                    prev_index: '{{ (repeat.index - 2) % (lights|count) }}'
                    previous: '{{ lights[prev_index] }}'
                - service: light.turn_on
                  target:
                    entity_id: '{{ previous }}'
                  data:
                    hs_color: [355, 90]
                    brightness: 255
                    transition: '{{ transition_s }}'
                - service: light.turn_on
                  target:
                    entity_id: '{{ current }}'
                  data:
                    hs_color: [45, 20]
                    brightness: 255
                    transition: '{{ transition_s }}'
                - delay:
                    milliseconds: '{{ hold_ms }}'

huskers_chase30_stop:
  alias: 'Huskers: Stop 30s Cream Chase (restore)'
  mode: single
  sequence:
    - service: script.turn_off
      target:
        entity_id: script.huskers_chase30_loop
    - delay:
        milliseconds: 500
    - service: scene.turn_on
      target:
        entity_id: scene.huskers_before_chase30
      continue_on_error: true

huskers_chase_speed_start:
  alias: 'Huskers: Start Variable-Speed Cream Chase'
  description: >
    Sets all target lights to Scarlet, snapshots current state, and starts a variable-speed
    Cream chase. Adjust total cycle time with input_number.huskers_chase_cycle_seconds.
  mode: restart
  sequence:
    - service: scene.create
      data:
        scene_id: huskers_before_chase_speed
        snapshot_entities:
          - light.light_theater_left
          - light.light_theater_right
          - light.light_front_left
          - light.light_front_right
          - light.light_garage_left
          - light.lights_garage_center
          - light.light_garage_right
    - service: light.turn_on
      target:
        entity_id:
          - light.light_theater_left
          - light.light_theater_right
          - light.light_front_left
          - light.light_front_right
          - light.light_garage_left
          - light.lights_garage_center
          - light.light_garage_right
      data:
        hs_color: [355, 90]
        brightness: 255
        transition: 0.1
    - service: script.turn_on
      target:
        entity_id: script.huskers_chase_speed_loop

huskers_chase_speed_loop:
  alias: 'Huskers: Variable-Speed Cream Chase LOOP'
  mode: restart
  sequence:
    - variables:
        transition_s: 0.1
        lights:
          [
            'light.light_theater_left',
            'light.light_theater_right',
            'light.light_front_left',
            'light.light_front_right',
            'light.light_garage_left',
            'light.lights_garage_center',
            'light.light_garage_right',
          ]
        cycle_s: "{{ states('input_number.huskers_chase_cycle_seconds') | float(30) }}"
        step_ms: '{{ ((cycle_s * 1000) / (lights | count)) | round(0) | int }}'
        hold_ms: '{{ (step_ms - (transition_s * 1000)) | round(0) | int }}'
    - repeat:
        while:
          - condition: template
            value_template: '{{ true }}'
        sequence:
          - repeat:
              for_each: '{{ lights }}'
              sequence:
                - variables:
                    current: '{{ repeat.item }}'
                    prev_index: '{{ (repeat.index - 2) % (lights|count) }}'
                    previous: '{{ lights[prev_index] }}'
                - service: light.turn_on
                  target:
                    entity_id: '{{ previous }}'
                  data:
                    hs_color: [355, 90]
                    brightness: 255
                    transition: '{{ transition_s }}'
                - service: light.turn_on
                  target:
                    entity_id: '{{ current }}'
                  data:
                    hs_color: [45, 20]
                    brightness: 255
                    transition: '{{ transition_s }}'
                - delay:
                    milliseconds: '{{ hold_ms }}'

huskers_chase_speed_stop:
  alias: 'Huskers: Stop Variable-Speed Cream Chase (restore)'
  mode: single
  sequence:
    - service: script.turn_off
      target:
        entity_id: script.huskers_chase_speed_loop
    - delay:
        milliseconds: 500
    - service: scene.turn_on
      target:
        entity_id: scene.huskers_before_chase_speed
      continue_on_error: true
