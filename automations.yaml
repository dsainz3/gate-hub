# === AUTOMATIONS (Base / generic) ===

  - id: evening_lights_at_sunset
    alias: 'Lighting: Evening Sunset (Interior)'
    description: >
      Activates evening lighting at sunset. Skips while Husker lighting hold is active.
    mode: single
    trigger:
      - platform: sun
        event: sunset
        offset: '00:05:00'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
      - condition: template
        value_template: "{{ states('binary_sensor.huskers_lighting_hold') != 'on' }}"
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.lighting_evening_sunset_interior
        data:
          transition: 2

  - id: exterior_front_garage_on_sunset
    alias: 'Lighting: Evening Sunset (Exterior)'
    description: >
      Turns on front porch and garage fixtures shortly after sunset unless Husker lighting hold is active.
    mode: single
    trigger:
      - platform: sun
        event: sunset
        offset: '00:05:00'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
      - condition: template
        value_template: "{{ states('binary_sensor.huskers_lighting_hold') != 'on' }}"
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.lighting_evening_sunset_exterior
        data:
          transition: 2

  - id: night_mode_at_midnight
    alias: 'Lighting: Night Mode'
    description: >
      Turns off most interior/accent lights and dims exterior LED to 20%.
    mode: single
    trigger:
      - platform: time
        at: '00:00:00'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.lighting_night_mode
        data:
          transition: 5

  - id: early_morning_lights_0330
    alias: 'Lighting: Early Morning Gentle Wake'
    description: >
      Soft ambient lighting for early risers.
    mode: single
    trigger:
      - platform: time
        at: '03:30:00'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.lighting_early_morning_gentle_wake
        data:
          transition: 3

  - id: interior_lights_sunrise_off
    alias: 'Lighting: Morning Interior Off'
    description: >
      Turns off ambient interior lighting after sunrise unless the Husker light show is running.
    mode: single
    trigger:
      - platform: sun
        event: sunrise
        offset: '00:15:00'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
      - condition: state
        entity_id: binary_sensor.huskers_light_show_active
        state: 'off'
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.lighting_morning_interior_off
        data:
          transition: 10

  - id: exterior_lights_sunrise_off
    alias: 'Lighting: Morning Exterior Off'
    description: >
      Turns off the front porch and garage lights a few minutes after sunrise unless the Husker light show is running.
    mode: single
    trigger:
      - platform: sun
        event: sunrise
        offset: '00:05:00'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
      - condition: state
        entity_id: binary_sensor.huskers_light_show_active
        state: 'off'
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.lighting_morning_exterior_off
        data:
          transition: 10

  - id: exterior_lights_cloudy_daytime
    alias: 'Lighting: Daytime Cloudy Exterior'
    description: >
      Brings exterior lights to a gentle daytime level when heavy clouds roll in and turns them back off as skies clear.
    mode: single
    trigger:
      - platform: numeric_state
        id: cloudy
        entity_id: sensor.openweathermap_cloud_coverage
        above: 80
      - platform: numeric_state
        id: clearing
        entity_id: sensor.openweathermap_cloud_coverage
        below: 80
    condition:
      - condition: sun
        after: sunrise
        before: sunset
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'cloudy' }}"
            sequence:
              - service: scene.turn_on
                target:
                  entity_id: scene.lighting_daytime_cloudy_exterior
                data:
                  transition: 2
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'clearing' }}"
            sequence:
              - service: scene.turn_on
                target:
                  entity_id: scene.lighting_morning_exterior_off
                data:
                  transition: 2

  - id: exterior_led_monthly_effect
    alias: 'LED: Monthly Effect Scheduler'
    description: >
      Sets seasonal/holiday effects on exterior LED strip.
    mode: single
    trigger:
      - platform: time
        at: '00:00:01'
      - platform: homeassistant
        event: start
    variables:
      current_month: '{{ now().month }}'
      monthly_configs:
        1:
          scene: scene.lighting_led_effect_january
          effect: LED-January
        2:
          scene: scene.lighting_led_effect_february
          effect: LED-February
        3:
          scene: scene.lighting_led_effect_march
          effect: LED-March
        4:
          scene: scene.lighting_led_effect_april
          effect: LED-April
        5:
          scene: scene.lighting_led_effect_patriotic
          effect: BSMT-Patriotic
        6:
          scene: scene.lighting_led_effect_patriotic
          effect: BSMT-Patriotic
        7:
          scene: scene.lighting_led_effect_patriotic
          effect: BSMT-Patriotic
        8:
          scene: scene.lighting_led_effect_august
          effect: LED-August
        9:
          scene: scene.lighting_led_effect_august
          effect: LED-August
        10:
          scene: scene.lighting_led_effect_halloween
          effect: Halloween
        11:
          scene: scene.lighting_led_effect_thanksgiving
          effect: LED-Thanksgiving
        12:
          scene: scene.lighting_led_effect_christmas
          effect: Christmas
      target_config: '{{ monthly_configs.get(current_month, {}) }}'
      target_scene: '{{ target_config.get("scene") }}'
      target_effect: '{{ target_config.get("effect") }}'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
    action:
      - alias: 'Wait for permanent outdoor lights to advertise effects after startup'
        wait_template: >-
          {% set available_effects = state_attr('light.permanent_outdoor_lights','effect_list') or [] %}
          {{ target_effect in available_effects }}
        timeout: '00:02:00'
        continue_on_timeout: true
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ target_scene is not none and target_scene != '' }}"
              - condition: template
                value_template: >-
                  {% set available_effects = state_attr('light.permanent_outdoor_lights','effect_list') or [] %}
                  {{ target_effect in available_effects }}
            sequence:
              - if:
                  - condition: template
                    value_template: "{{ has_value('light.permanent_outdoor_lights') }}"
                then:
                  - service: scene.turn_on
                    target:
                      entity_id: '{{ target_scene }}'
                    continue_on_error: true
              - service: logbook.log
                data:
                  name: LED Monthly Effect
                  message: 'Applied {{ target_effect or "unknown effect" }} for month {{ current_month }} via {{ target_scene or "unknown scene" }}'
        default:
          - service: logbook.log
            data:
              name: LED Monthly Effect
              message: >-
                Skipped {{ target_effect or 'unknown effect' }} for month {{ current_month }} -- effect missing after startup wait or scene unavailable

  - id: humidor_plug_temp_control
    alias: 'Climate: Humidor Temperature Control'
    description: >
      Hysteresis control for humidor: ON >74°F, OFF <70°F.
    mode: single
    trigger:
      - platform: numeric_state
        entity_id: sensor.hygrometer_humidor_temperature
        above: 74
        for: {minutes: 2}
      - platform: numeric_state
        entity_id: sensor.hygrometer_humidor_temperature
        below: 70
        for: {minutes: 1}
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
      - condition: template
        value_template: >-
          {% set temp = trigger.to_state.state | float(-999) %}
          {% set on = is_state('switch.plug_humidor','on') %}
          {{ (temp > 74 and not on) or (temp < 70 and on) }}
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.hygrometer_humidor_temperature
                above: 74
            sequence:
              - service: scene.turn_on
                target:
                  entity_id: scene.climate_humidor_cooling_on
              - service: logbook.log
                data:
                  name: Humidor Control
                  message: 'Cooling ON - Temperature: {{ states("sensor.hygrometer_humidor_temperature") }}°F - Humidity: {{ states("sensor.hygrometer_humidor_humidity") }}%'
          - conditions:
              - condition: numeric_state
                entity_id: sensor.hygrometer_humidor_temperature
                below: 70
            sequence:
              - service: scene.turn_on
                target:
                  entity_id: scene.climate_humidor_cooling_off
              - service: logbook.log
                data:
                  name: Humidor Control
                  message: 'Cooling OFF - Temperature: {{ states("sensor.hygrometer_humidor_temperature") }}°F - Humidity: {{ states("sensor.hygrometer_humidor_humidity") }}%'

  - id: burner_plugs_off_2300
    alias: 'Safety: Nightly Burner Plug Shutoff'
    description: >
      Safety shutoff for burner plugs at 11 PM daily.
    mode: single
    trigger:
      - platform: time
        at: '23:00:00'
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: binary_sensor.holiday_mode_active
            state: 'on'
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.safety_burner_plugs_off
        continue_on_error: true
      - service: persistent_notification.create
        data:
          title: 'Safety: Burner Plugs'
          message: 'All burner plugs turned off at 11 PM.'
          notification_id: nightly_burner_shutoff
      - service: logbook.log
        data:
          name: Safety Automation
          message: Nightly burner plug shutoff completed
