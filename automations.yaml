# =========================
# HUSKERS — GAME FLOW
# =========================
# NOTE:
# - Replaces earlier auto-start/stop items like:
#   huskers_theater_show_auto_start/_stop,
#   huskers_exterior_show_auto_start/_stop.
# - Uses sensor.huskers_kickoff_in_effective and
#   sensor.huskers_our_score_effective (template proxies).
# - Test mode: input_boolean.huskers_test_mode lets you rehearse without
#   live sensors.

# T-20 minutes → start theater + exterior shows (+ LED game look)
- id: huskers_pregame_tminus20_showtime
  alias: 'Huskers: Showtime at T-20'
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.huskers_kickoff_in_effective
      above: 19
      below: 21
  condition:
    # Fire if real pregame is on OR you're in Test Mode
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.huskers_pregame_window
          state: 'on'
        - condition: state
          entity_id: input_boolean.huskers_test_mode
          state: 'on'
    # Avoid needless restarts if either show isn't already running
    - condition: template
      value_template: >-
        {{ is_state('script.huskers_theater_show_start','off')
           or is_state('script.huskers_exterior_show_start','off') }}
  action:
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_theater_show_start
          - script.huskers_exterior_show_start
          - script.huskers_led_gameday_start

# Nebraska score increased → BPM scarlet/cream bursts
- id: huskers_td_burst_on_score
  alias: 'Huskers: TD Burst on Score'
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.huskers_our_score_effective
  condition:
    - condition: template
      value_template: >-
        {{ trigger.from_state is not none and
           trigger.to_state is not none and
           (trigger.to_state.state | int(0)) >
           (trigger.from_state.state | int(0)) }}
  action:
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_td_burst_bpm_theater
          - script.huskers_td_burst_bpm_exterior

# Postgame → stop both shows and restore snapshots
- id: huskers_postgame_cleanup
  alias: 'Huskers: Postgame Cleanup'
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.huskers_postgame_window
      from: 'on'
      to: 'off'
  action:
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_theater_show_stop
          - script.huskers_exterior_show_stop
