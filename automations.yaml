# =========================
# HUSKERS — GAME FLOW (effective sensors)
# =========================
# Uses:
# - sensor.huskers_kickoff_in_effective
# - sensor.huskers_our_score_effective
# Test mode via input_boolean.huskers_test_mode.

# T-20 → start theater + exterior shows + LED Gametime
- id: huskers_pregame_tminus20_showtime
  alias: 'Huskers: Showtime at T-20'
  description: >
    When 19–21 minutes remain until kickoff AND Game Mode is ON, start the
    Theater/Exterior alternating shows and set exterior LED to Gametime. Skips
    if either show is already running.
  initial_state: false
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.huskers_kickoff_in_effective
      above: 19
      below: 21
  condition:
    # Master guard
    - condition: state
      entity_id: input_boolean.huskers_game_mode
      state: 'on'
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.huskers_pregame_window
          state: 'on'
        - condition: state
          entity_id: input_boolean.huskers_test_mode
          state: 'on'
    # Only run if BOTH shows are off
    - condition: template
      value_template: >-
        {{ is_state('script.huskers_theater_show_start','off')
           and is_state('script.huskers_exterior_show_start','off') }}
  action:
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_theater_show_start
          - script.huskers_exterior_show_start
          - script.huskers_led_gameday_start

# Nebraska score increased → BPM bursts + LED Huskers burst
- id: huskers_td_burst_on_score
  alias: 'Huskers: TD Burst on Score'
  description: >
    When Nebraska's effective score increases AND Game Mode is ON, run BPM-based
    TD bursts for Theater and Exterior plus the LED TD burst.
  initial_state: false
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.huskers_our_score_effective
  condition:
    # Master guard
    - condition: state
      entity_id: input_boolean.huskers_game_mode
      state: 'on'
    - condition: template
      value_template: >-
        {{ trigger.from_state is not none and
           trigger.to_state is not none and
           (trigger.to_state.state | int(0)) >
           (trigger.from_state.state | int(0)) }}
  action:
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_td_burst_bpm_theater
          - script.huskers_td_burst_bpm_exterior
          - script.huskers_led_td_burst

# Postgame → stop both shows and restore snapshots
- id: huskers_postgame_cleanup
  alias: 'Huskers: Postgame Cleanup'
  description: >
    When the postgame window closes AND Game Mode is ON, stop both shows and
    restore their snapshots.
  initial_state: false
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.huskers_postgame_window
      from: 'on'
      to: 'off'
  condition:
    # Master guard
    - condition: state
      entity_id: input_boolean.huskers_game_mode
      state: 'on'
  action:
    - service: script.turn_on
      target:
        entity_id:
          - script.huskers_theater_show_stop
          - script.huskers_exterior_show_stop

# =========================
# Evening / Night / Early AM (non-Huskers)
# =========================

- id: evening_lights_at_sunset
  alias: 'Evening Lights at Sunset'
  description: >
    At sunset, set main floor lights to 60%, front/garage warm-dim, and exterior
    LED to 50% brightness.
  mode: single
  trigger:
    - platform: sun
      event: sunset
  action:
    - parallel:
        - service: light.turn_on
          target:
            entity_id:
              - light.sunroom_light
              - light.diningroom_light
              - light.livingroom_light
          data:
            brightness_pct: 60
        - service: light.turn_on
          target:
            entity_id:
              - light.front_porch_lights
              - light.garage_left
              - light.garage_center
              - light.garage_right
          data:
            kelvin: 2000
            brightness_pct: 10
        - service: light.turn_on
          target:
            entity_id: light.permanent_outdoor_lights
          data:
            brightness_pct: 50

- id: night_lights_at_midnight
  alias: 'Night Lights at Midnight'
  description: >
    At midnight, turn off interior/front/garage lights and dim exterior LED to
    20% brightness.
  mode: single
  trigger:
    - platform: time
      at: '00:00:00'
  action:
    - parallel:
        - service: light.turn_off
          target:
            entity_id:
              - light.sunroom_light
              - light.diningroom_light
              - light.livingroom_light
              - light.office_light
              - light.theater_lights
        - service: light.turn_off
          target:
            entity_id:
              - light.front_porch_lights
              - light.garage_left
              - light.garage_center
              - light.garage_right
        - service: light.turn_on
          target:
            entity_id: light.permanent_outdoor_lights
          data:
            brightness_pct: 20

- id: early_morning_lights_0330
  alias: 'Early Morning Lights (03:30)'
  description: >
    At 03:30, bring main floor to 10%, warm-dim front/garage to ~10%, and set
    exterior LED to 50% brightness.
  mode: single
  trigger:
    - platform: time
      at: '03:30:00'
  action:
    - parallel:
        - service: light.turn_on
          target:
            entity_id:
              - light.sunroom_light
              - light.diningroom_light
              - light.livingroom_light
          data:
            brightness_pct: 10
        - service: light.turn_on
          target:
            entity_id:
              - light.front_porch_lights
              - light.garage_left
              - light.garage_center
              - light.garage_right
          data:
            kelvin: 2000
            brightness_pct: 10
        - service: light.turn_on
          target:
            entity_id: light.permanent_outdoor_lights
          data:
            brightness_pct: 50

- id: exterior_led_monthly_effect
  alias: 'Exterior LED - Monthly Effect'
  description: >
    At midnight select a month-specific effect for the exterior LED strip if the
    effect exists in its effect_list.
  mode: single
  trigger:
    - platform: time
      at: '00:00:00'
  variables:
    current_month: '{{ now().month }}'
    monthly_effects:
      1: LED-January
      2: LED-February
      3: LED-March
      4: LED-April
      5: BSMT-Patriotic
      6: BSMT-Patriotic
      7: BSMT-Patriotic
      8: LED-August
      9: LED-August
      10: Halloween
      11: LED-Thanksgiving
      12: Christmas
  action:
    - variables:
        target_effect: '{{ monthly_effects[current_month] }}'
    - condition: template
      value_template: >-
        {{ target_effect in (state_attr('light.permanent_outdoor_lights',
        'effect_list') or []) }}
    - service: light.turn_on
      target:
        entity_id: light.permanent_outdoor_lights
      data:
        effect: '{{ target_effect }}'

- id: interior_lights_sunrise_off
  alias: 'Interior Lights Off - 15 Minutes After Sunrise'
  description: >
    Turn off sunroom, living room, and dining room lights 15 minutes after
    sunrise.
  mode: single
  trigger:
    - platform: sun
      event: sunrise
      offset: '00:15:00'
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.sunroom_light
          - light.livingroom_light
          - light.diningroom_light

# =========================
# CORE / ENVIRONMENT (non-Huskers)
# =========================

- id: humidor_plug_temp_control
  alias: 'Humidor Plug – Temperature Control'
  description: >
    Hysteresis: turn ON the humidor plug above 74°F; turn OFF below 68°F.
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.hygrometer_humidor_temperature
      above: 74
    - platform: numeric_state
      entity_id: sensor.hygrometer_humidor_temperature
      below: 68
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.hygrometer_humidor_temperature
              above: 74
          sequence:
            - condition: state
              entity_id: switch.plug_humidor
              state: 'off'
            - service: switch.turn_on
              target:
                entity_id: switch.plug_humidor
        - conditions:
            - condition: numeric_state
              entity_id: sensor.hygrometer_humidor_temperature
              below: 68
          sequence:
            - condition: state
              entity_id: switch.plug_humidor
              state: 'on'
            - service: switch.turn_off
              target:
                entity_id: switch.plug_humidor

- id: burner_plugs_off_2300
  alias: 'Safety: Turn Off Burner Plugs at 11:00 PM'
  description: >
    Safety sweep at 23:00: turn OFF the basement, main floor, and bedroom
    burner plugs.
  mode: single
  trigger:
    - platform: time
      at: '23:00:00'
  action:
    - service: switch.turn_off
      target:
        entity_id:
          - switch.plug_basement_burner
          - switch.plug_mainfloor_burner
          - switch.plug_bedroom_burner

# =========================
# HUSKERS — DEBUG / PLACEHOLDERS
# =========================

- id: huskers_update_last_score_test
  alias: 'Huskers: Update Last Score (Test)'
  description: >
    TEST: When input_text.huskers_last_score changes AND Game Mode is ON, log a
    debug entry. (Replace with real actions later.)
  initial_state: false
  mode: restart
  trigger:
    - platform: state
      entity_id: input_text.huskers_last_score
  condition:
    - condition: state
      entity_id: input_boolean.huskers_game_mode
      state: 'on'
  action:
    - service: logbook.log
      data:
        name: 'Huskers – Update Last Score (Test)'
        message: 'Placeholder: add actions here.'

- id: huskers_react_to_test_score
  alias: 'Huskers: React to Test Score'
  description: >
    TEST: When sensor.huskers_last_score_test changes AND Game Mode is ON, log a
    debug entry. (Replace with real actions later.)
  initial_state: false
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.huskers_last_score_test
  condition:
    - condition: state
      entity_id: input_boolean.huskers_game_mode
      state: 'on'
  action:
    - service: logbook.log
      data:
        name: 'Huskers – React to Test Score'
        message: 'Placeholder: add actions here.'

# =========================
# HUSKERS — Automations (kickoff/postgame glue)
# =========================

- id: huskers_set_led_gametime_on_kickoff
  alias: 'Huskers: Set LED Gametime on Kickoff'
  description: >
    When the team state goes IN (kickoff) AND Game Mode is ON, set exterior LED
    to LED_Gametime effect.
  initial_state: false
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.husker_team
      to: 'IN'
  condition:
    - condition: state
      entity_id: input_boolean.huskers_game_mode
      state: 'on'
  action:
    - service: light.turn_on
      target:
        entity_id: light.permanent_outdoor_lights
      data:
        effect: LED_Gametime

- id: huskers_postgame_monthly_effect_after_20m
  alias: 'Huskers: Postgame → Monthly LED Effect (20m)'
  description: >
    When team state goes POST AND Game Mode is ON, wait 20 minutes, then trigger
    the monthly LED effect automation.
  initial_state: false
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.husker_team
      to: 'POST'
  condition:
    - condition: state
      entity_id: input_boolean.huskers_game_mode
      state: 'on'
  action:
    - delay: '00:20:00'
    - service: automation.trigger
      target:
        entity_id: automation.exterior_led_monthly_effect
