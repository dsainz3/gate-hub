title: Network Dashboard
views:
  - title: Overview
    path: network
    icon: mdi:access-point-network
    cards:
      - type: markdown
        content: >-
          {% macro fmt(value, precision=1, unit='') -%}
            {%- if value in ['unknown', 'unavailable', None] -%}
              –
            {%- else -%}
              {%- set num = (value | float(0)) | round(precision) -%}
              {%- if precision == 0 -%}
                {{ num | int }}{{ ' ' ~ unit if unit else '' }}
              {%- else -%}
                {{ num }}{{ ' ' ~ unit if unit else '' }}
              {%- endif -%}
            {%- endif -%}
          {%- endmacro %}
          {% macro trend(current, reference, unit='') -%}
            {%- if current in ['unknown', 'unavailable', None] or reference in ['unknown', 'unavailable', None] -%}
              –
            {%- else -%}
              {%- set ref = reference | float(0) -%}
              {%- if ref == 0 -%}
                –
              {%- else -%}
                {%- set diff = (current | float(0)) - ref -%}
                {%- if diff > 0 -%}
                  ↑ {{ diff | round(1) }}{{ unit }}
                {%- elif diff < 0 -%}
                  ↓ {{ (diff | abs) | round(1) }}{{ unit }}
                {%- else -%}
                  → 0{{ unit }}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endmacro %}
          {% set last_speedtest = state_attr('sensor.network_status_summary', 'last_speedtest') %}
          {% set last_label = 'pending runs' %}
          {% if last_speedtest not in ['unknown', 'unavailable', None] %}
            {% set dt = as_datetime(last_speedtest) %}
            {% if dt %}
              {% set last_label = as_timestamp(dt) | timestamp_custom('%b %-d, %Y %-I:%M %p %Z', True) %}
            {% endif %}
          {% endif %}
          {% set reachability = is_state('binary_sensor.internet_reachability', 'on') %}
          {% set clients_total = state_attr('sensor.deco_network_health', 'clients_total') %}
          ## Network Snapshot
          **Status:** {{ states('sensor.network_status_summary') }} · {{ states('sensor.network_performance_summary') | title }}

          **Ping:** {{ fmt(states('sensor.internet_latency')) }} ms
          ({{ 'reachable' if reachability else 'unreachable' }}) ·
          {{ trend(states('sensor.internet_latency'),
            states('sensor.internet_latency_24h_avg'),
            ' ms') }}

          **Speedtest:** ↓ {{ fmt(states('sensor.speedtest_download'), 1, 'Mbps') }}
          ({{ trend(states('sensor.speedtest_download'),
            states('sensor.speedtest_download_24h_avg'),
            ' Mbps') }}) · ↑ {{ fmt(states('sensor.speedtest_upload'), 1, 'Mbps') }}
          ({{ trend(states('sensor.speedtest_upload'),
            states('sensor.speedtest_upload_24h_avg'),
            ' Mbps') }}) ·
          Ping {{ fmt(states('sensor.speedtest_ping'), 1, 'ms') }}
          ({{ trend(states('sensor.speedtest_ping'),
            states('sensor.speedtest_ping_24h_avg'),
            ' ms') }})

          **Deco Throughput:** ↓ {{ fmt(states('sensor.deco_total_down_mbps'), 2, 'Mbps') }} ·
          ↑ {{ fmt(states('sensor.deco_total_up_mbps'), 2, 'Mbps') }} ·
          Clients {{ fmt(states('sensor.deco_client_count'), 0) }}
          {% if clients_total is not none %}/ {{ clients_total }}{% endif %}
          ({{ states('sensor.deco_network_health') | title }})

          **Latency averages:** 1h {{ fmt(states('sensor.internet_latency_1h_avg')) }} ·
          24h {{ fmt(states('sensor.internet_latency_24h_avg')) }} ·
          7d {{ fmt(states('sensor.internet_latency_7d_avg')) }} ·
          30d {{ fmt(states('sensor.internet_latency_30d_avg')) }}

          **Last Speed Test:** {{ last_label }}
      - type: grid
        columns: 3
        square: false
        cards:
          - type: tile
            entity: binary_sensor.internet_reachability
            name: Internet online
            color: '#43a047'
          - type: tile
            entity: sensor.network_performance_summary
            name: Performance state
            color: '#fb8c00'
          - type: tile
            entity: sensor.deco_network_health
            name: Deco health
            color: '#1e88e5'
          - type: tile
            entity: sensor.internet_latency
            name: Live latency
            color: '#039be5'
          - type: tile
            entity: sensor.speedtest_download
            name: Download Mbps
            color: '#3949ab'
          - type: tile
            entity: sensor.speedtest_upload
            name: Upload Mbps
            color: '#8d6e63'
          - type: tile
            entity: sensor.speedtest_ping
            name: Speedtest ping
            color: '#ef6c00'
          - type: tile
            entity: sensor.deco_total_down_mbps
            name: Deco down Mbps
            color: '#26a69a'
          - type: tile
            entity: sensor.deco_total_up_mbps
            name: Deco up Mbps
            color: '#7e57c2'
          - type: tile
            entity: sensor.deco_client_count
            name: Clients online
            color: '#5e35b1'
          - type: tile
            entity: sensor.deco_node_count
            name: Nodes online
            color: '#1565c0'
          - type: tile
            entity: sensor.speedtest_last_run
            name: Last speedtest
            color: '#546e7a'
      - type: custom:apexcharts-card
        header:
          title: Latency vs averages (24h)
          show: true
        graph_span: 24h
        span:
          end: hour
        yaxis:
          - min: 0
        apex_config:
          stroke:
            width: 2
          legend:
            show: true
        series:
          - entity: sensor.internet_latency
            name: Current
            color: '#1e88e5'
            float_precision: 1
          - entity: sensor.internet_latency_1h_avg
            name: 1h avg
            color: '#43a047'
            type: line
            float_precision: 1
          - entity: sensor.internet_latency_24h_avg
            name: 24h avg
            color: '#fdd835'
            type: line
            float_precision: 1
      - type: custom:apexcharts-card
        header:
          title: Deco throughput (6h)
          show: true
        graph_span: 6h
        span:
          end: hour
        yaxis:
          - min: 0
        apex_config:
          stroke:
            width: 2
          legend:
            show: true
        series:
          - entity: sensor.deco_total_down_mbps
            name: Down
            color: '#26a69a'
            float_precision: 2
          - entity: sensor.deco_total_up_mbps
            name: Up
            color: '#7e57c2'
            float_precision: 2
      - type: custom:apexcharts-card
        header:
          title: Speedtest results (30d)
          show: true
        graph_span: 30d
        span:
          end: day
        yaxis:
          - min: 0
        apex_config:
          stroke:
            width: 2
          legend:
            show: true
        series:
          - entity: sensor.speedtest_download
            name: Download
            type: line
            color: '#3949ab'
            float_precision: 1
          - entity: sensor.speedtest_upload
            name: Upload
            type: line
            color: '#8d6e63'
            float_precision: 1
          - entity: sensor.speedtest_ping
            name: Ping
            type: line
            color: '#ef6c00'
            float_precision: 1
          - entity: sensor.speedtest_download_7d_avg
            name: Download 7d avg
            type: line
            color: '#5c6bc0'
            float_precision: 1
          - entity: sensor.speedtest_upload_7d_avg
            name: Upload 7d avg
            type: line
            color: '#a1887f'
            float_precision: 1
      - type: custom:apexcharts-card
        header:
          title: Speedtest ping vs averages (7d)
          show: true
        graph_span: 7d
        span:
          end: hour
        yaxis:
          - min: 0
        apex_config:
          stroke:
            width: 2
          legend:
            show: true
        series:
          - entity: sensor.speedtest_ping
            name: Ping
            color: '#ef6c00'
            float_precision: 1
          - entity: sensor.speedtest_ping_24h_avg
            name: 24h avg
            color: '#ffb300'
            type: line
            float_precision: 1
          - entity: sensor.speedtest_ping_7d_avg
            name: 7d avg
            color: '#ffa726'
            type: line
            float_precision: 1
      - type: entities
        title: Live network sensors
        show_header_toggle: false
        entities:
          - binary_sensor.internet_reachability
          - sensor.internet_latency
          - sensor.speedtest_ping
          - sensor.speedtest_download
          - sensor.speedtest_upload
          - sensor.deco_total_down_mbps
          - sensor.deco_total_up_mbps
          - sensor.deco_client_count
          - sensor.deco_node_count
          - sensor.network_performance_summary
          - sensor.speedtest_last_run
      - type: entities
        title: Rolling averages
        show_header_toggle: false
        entities:
          - type: section
            label: Latency (ms)
          - sensor.internet_latency_1h_avg
          - sensor.internet_latency_24h_avg
          - sensor.internet_latency_7d_avg
          - sensor.internet_latency_30d_avg
          - type: section
            label: Download (Mbps)
          - sensor.speedtest_download_1h_avg
          - sensor.speedtest_download_24h_avg
          - sensor.speedtest_download_7d_avg
          - sensor.speedtest_download_30d_avg
          - type: section
            label: Upload (Mbps)
          - sensor.speedtest_upload_1h_avg
          - sensor.speedtest_upload_24h_avg
          - sensor.speedtest_upload_7d_avg
          - sensor.speedtest_upload_30d_avg
          - type: section
            label: Ping (ms)
          - sensor.speedtest_ping_1h_avg
          - sensor.speedtest_ping_24h_avg
          - sensor.speedtest_ping_7d_avg
          - sensor.speedtest_ping_30d_avg
          - type: section
            label: Deco throughput (Mbps)
          - sensor.deco_total_down_mbps_1h_avg
          - sensor.deco_total_down_mbps_24h_avg
          - sensor.deco_total_down_mbps_7d_avg
          - sensor.deco_total_down_mbps_30d_avg
          - sensor.deco_total_up_mbps_1h_avg
          - sensor.deco_total_up_mbps_24h_avg
          - sensor.deco_total_up_mbps_7d_avg
          - sensor.deco_total_up_mbps_30d_avg
      - type: custom:auto-entities
        show_empty: false
        card:
          type: entities
          title: Deco nodes
          show_header_toggle: false
        filter:
          include:
            - domain: device_tracker
              integration: tplink_deco
              attributes:
                device_type: deco
      - type: custom:auto-entities
        show_empty: false
        card:
          type: entities
          title: Ping sensors
          show_header_toggle: false
        filter:
          include:
            - entity_id: sensor.ping_*
      - type: button
        name: Run Speedtest Now
        icon: mdi:speedometer
        tap_action:
          action: call-service
          service: homeassistant.update_entity
          target:
            entity_id:
              - sensor.speedtest_download
              - sensor.speedtest_upload
              - sensor.speedtest_ping
        hold_action:
          action: none
  - title: History
    path: network-history
    icon: mdi:chart-line
    cards:
      - type: custom:apexcharts-card
        header:
          title: Latency trend (7d)
          show: true
        graph_span: 7d
        span:
          end: hour
        yaxis:
          - min: 0
        apex_config:
          stroke:
            width: 2
          legend:
            show: true
        series:
          - entity: sensor.internet_latency
            name: Current
            color: '#1e88e5'
            float_precision: 1
          - entity: sensor.internet_latency_24h_avg
            name: 24h avg
            color: '#fdd835'
            type: line
            float_precision: 1
          - entity: sensor.internet_latency_7d_avg
            name: 7d avg
            color: '#43a047'
            type: line
            float_precision: 1
      - type: custom:apexcharts-card
        header:
          title: Speedtest download vs upload (90d)
          show: true
        graph_span: 90d
        span:
          end: day
        yaxis:
          - min: 0
        apex_config:
          stroke:
            width: 2
          legend:
            show: true
        series:
          - entity: sensor.speedtest_download
            name: Download
            type: line
            color: '#3949ab'
            float_precision: 1
          - entity: sensor.speedtest_upload
            name: Upload
            type: line
            color: '#8d6e63'
            float_precision: 1
          - entity: sensor.speedtest_download_30d_avg
            name: Download 30d avg
            type: line
            color: '#5c6bc0'
            float_precision: 1
          - entity: sensor.speedtest_upload_30d_avg
            name: Upload 30d avg
            type: line
            color: '#a1887f'
            float_precision: 1
      - type: custom:apexcharts-card
        header:
          title: Deco throughput (30d)
          show: true
        graph_span: 30d
        span:
          end: day
        yaxis:
          - min: 0
        apex_config:
          stroke:
            width: 2
          legend:
            show: true
        series:
          - entity: sensor.deco_total_down_mbps
            name: Down
            type: line
            color: '#26a69a'
            float_precision: 2
          - entity: sensor.deco_total_up_mbps
            name: Up
            type: line
            color: '#7e57c2'
            float_precision: 2
          - entity: sensor.deco_total_down_mbps_7d_avg
            name: Down 7d avg
            type: line
            color: '#4db6ac'
            float_precision: 2
          - entity: sensor.deco_total_up_mbps_7d_avg
            name: Up 7d avg
            type: line
            color: '#9575cd'
            float_precision: 2
      - type: custom:apexcharts-card
        header:
          title: Speedtest ping (90d)
          show: true
        graph_span: 90d
        span:
          end: day
        yaxis:
          - min: 0
        apex_config:
          stroke:
            width: 2
          legend:
            show: true
        series:
          - entity: sensor.speedtest_ping
            name: Ping
            type: line
            color: '#ef6c00'
            float_precision: 1
          - entity: sensor.speedtest_ping_30d_avg
            name: Ping 30d avg
            type: line
            color: '#ffb300'
            float_precision: 1
