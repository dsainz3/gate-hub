input_boolean:
  weather_notifications_enabled:
    name: Weather Notifications Enabled
    icon: mdi:bell-alert

group:
  weather_dashboard_all:
    name: Weather Dashboard – All
    entities:
      - weather.kneplatt72
      - sensor.outdoor_temperature_wx
      - sensor.outdoor_humidity_wx
      - sensor.outdoor_wind_speed_wx
      - sensor.outdoor_pressure_wx
      - sensor.outdoor_visibility_wx
      - sensor.outdoor_dew_point_approx
      - sensor.outdoor_feels_like
      - sensor.kneplatt72_uv_index
      - sensor.uv_category_wx
      - sensor.wind_gust
      - binary_sensor.pressure_rising
      - binary_sensor.pressure_falling

template:
  - sensor:
      # Current temperature from weather entity
      - name: 'Outdoor Temperature (wx)'
        unique_id: wx_temp_primary
        state: "{{ state_attr('weather.kneplatt72', 'temperature') }}"
        unit_of_measurement: '°F'
        device_class: temperature
        state_class: measurement
        availability: "{{ state_attr('weather.kneplatt72','temperature') is not none }}"

      # Current humidity
      - name: 'Outdoor Humidity (wx)'
        unique_id: wx_humidity_primary
        state: "{{ state_attr('weather.kneplatt72', 'humidity') }}"
        unit_of_measurement: '%'
        device_class: humidity
        state_class: measurement
        availability: "{{ state_attr('weather.kneplatt72','humidity') is not none }}"

      # Current wind speed
      - name: 'Outdoor Wind Speed (wx)'
        unique_id: wx_wind_primary
        state: "{{ state_attr('weather.kneplatt72', 'wind_speed') }}"
        unit_of_measurement: 'mph'
        icon: mdi:weather-windy
        state_class: measurement
        availability: "{{ state_attr('weather.kneplatt72','wind_speed') is not none }}"

      # Pressure: convert hPa -> inHg (fallback to native sensor if your weather entity lacks pressure)
      - name: 'Outdoor Pressure (wx)'
        unique_id: wx_pressure
        state: >-
          {% set p = state_attr('weather.kneplatt72', 'pressure') | float(0) %}
          {% if p > 0 %}
            {{ (p * 0.02953) | round(2) }}
          {% else %}
            {{ states('sensor.kneplatt72_pressure_24h_change') }}
          {% endif %}
        unit_of_measurement: 'inHg'
        icon: mdi:gauge
        state_class: measurement

      # Visibility: km -> miles from weather entity
      - name: 'Outdoor Visibility (wx)'
        unique_id: wx_visibility
        state: >-
          {% set v = state_attr('weather.kneplatt72','visibility')|float(0) %}
          {% if v > 0 %}
            {{ (v * 0.621371) | round(1) }}
          {% else %}
            unknown
          {% endif %}
        unit_of_measurement: 'mi'
        icon: mdi:eye
        state_class: measurement

      # Dew point (approx) from current Temp/Humidity
      - name: 'Outdoor Dew Point (approx)'
        unique_id: wx_dewpoint
        unit_of_measurement: '°F'
        device_class: temperature
        state_class: measurement
        state: >-
          {% set T = state_attr('weather.kneplatt72','temperature')|float(0) %}
          {% set RH = state_attr('weather.kneplatt72','humidity')|float(0) %}
          {% set Tc = (T - 32) * 5 / 9 %}
          {% set TdC = Tc - ((100 - RH) / 5) %}
          {{ (TdC * 9 / 5 + 32) | round(1) }}

      # Feels like (heat index / wind chill) from current values
      - name: 'Outdoor Feels Like'
        unique_id: wx_feels_like
        unit_of_measurement: '°F'
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer-auto
        state: >-
          {% set T = state_attr('weather.kneplatt72','temperature')|float(0) %}
          {% set RH = state_attr('weather.kneplatt72','humidity')|float(0) %}
          {% set V  = state_attr('weather.kneplatt72','wind_speed')|float(0) %}
          {% if T >= 80 and RH >= 40 %}
            {% set HI = -42.379 + 2.04901523*T + 10.14333127*RH - 0.22475541*T*RH - 0.00683783*T*T - 0.05481717*RH*RH + 0.00122874*T*T*RH + 0.00085282*T*RH*RH - 0.00000199*T*T*RH*RH %}
            {{ HI | round(1) }}
          {% elif T <= 50 and V >= 3 %}
            {% set WC = 35.74 + 0.6215*T - 35.75*(V ** 0.16) + 0.4275*T*(V ** 0.16) %}
            {{ WC | round(1) }}
          {% else %}
            {{ T | round(1) }}
          {% endif %}

      # UV category label from your UV sensor
      - name: 'UV Category (wx)'
        unique_id: wx_uv_category
        state: >-
          {% set u = states('sensor.kneplatt72_uv_index')|int(0) %}
          {% if u <= 2 %}Low{% elif u <= 5 %}Moderate{% elif u <= 7 %}High{% elif u <= 10 %}Very High{% else %}Extreme{% endif %}
        icon: mdi:weather-sunny-alert

binary_sensor:
  - platform: trend
    sensors:
      pressure_rising:
        entity_id: sensor.outdoor_pressure_wx
        friendly_name: Pressure Rising
        sample_duration: 7200 # 2 hours
        min_gradient: 0.002 # ~0.002 inHg per second (tune as desired)
      pressure_falling:
        entity_id: sensor.outdoor_pressure_wx
        friendly_name: Pressure Falling
        sample_duration: 7200
        min_gradient: 0.002
        invert: true

automation:
  # Replace 'sensor.nws_alerts' with your actual weather alert entity when you add one
  - id: weather_alert_notify
    alias: 'Weather: Severe Alert → Notification'
    mode: restart
    trigger:
      - platform: state
        entity_id:
          - sensor.nws_alerts
    condition:
      - condition: state
        entity_id: input_boolean.weather_notifications_enabled
        state: 'on'
    action:
      - service: persistent_notification.create
        data:
          title: 'Weather Alert'
          message: 'Update from {{ trigger.entity_id }}: {{ states(trigger.entity_id) }}'
