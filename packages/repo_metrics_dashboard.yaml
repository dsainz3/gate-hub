# Repository metrics & devices dashboard package
# Auto-generated by assistant to provide overview, lighting, safety, network, and area-focused views.

homeassistant:
  customize:
    sensor.repo_primary_weather:
      friendly_name: Repo Primary Weather
    sensor.repo_next_calendar_event:
      friendly_name: Repo Next Calendar Event


template:
  - trigger:
      - platform: homeassistant
        event: start
      - platform: time_pattern
        minutes: "/5"
    sensor:
      - name: Repo Lights On Total
        unique_id: repo_lights_on_total
        icon: mdi:lightbulb-group
        unit_of_measurement: devices
        state: >-
          {{ states.light | selectattr('state', 'eq', 'on') | list | count }}
      - name: Repo Devices Offline Total
        unique_id: repo_devices_offline_total
        icon: mdi:lan-disconnect
        unit_of_measurement: devices
        state: >-
          {% set tracked_domains = ['binary_sensor', 'sensor', 'switch', 'light', 'climate', 'fan', 'cover', 'device_tracker'] %}
          {{ states | selectattr('domain', 'in', tracked_domains)
                     | selectattr('state', 'in', ['unavailable', 'unknown', 'offline'])
                     | list | count }}
      - name: Repo Stale Sensors Total
        unique_id: repo_stale_sensors_total
        icon: mdi:timer-sand
        unit_of_measurement: sensors
        state: >-
          {% set threshold = now() - timedelta(hours=6) %}
          {% set tracked_domains = ['sensor', 'binary_sensor'] %}
          {{ states | selectattr('domain', 'in', tracked_domains)
                     | selectattr('state', 'not in', ['unavailable', 'unknown'])
                     | selectattr('last_changed', 'lt', threshold)
                     | list | count }}
      - name: Repo Low Battery Total
        unique_id: repo_low_battery_total
        icon: mdi:battery-alert
        unit_of_measurement: devices
        state: >-
          {% set threshold = 30 %}
          {% set counter = namespace(total=0) %}
          {% for ent in states | selectattr('attributes.device_class', 'equalto', 'battery') %}
            {% if ent.state not in ['unavailable', 'unknown', 'None'] %}
              {% if ent.domain == 'binary_sensor' and ent.state == 'on' %}
                {% set counter.total = counter.total + 1 %}
              {% elif ent.domain != 'binary_sensor' and ent.state | float(100) < threshold %}
                {% set counter.total = counter.total + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ counter.total }}
      - name: Repo Updates Available Total
        unique_id: repo_updates_available_total
        icon: mdi:update
        unit_of_measurement: updates
        state: >-
          {{ states.update | selectattr('state', 'eq', 'on') | list | count }}
      - name: Repo Primary Weather
        unique_id: repo_primary_weather
        icon: mdi:weather-partly-cloudy
        state: >-
          {% set weather = states.weather | map(attribute='entity_id') | list | first %}
          {% if weather %}
            {{ states(weather) }}
          {% else %}
            unknown
          {% endif %}
        attributes:
          source_entity: >-
            {% set weather = states.weather | map(attribute='entity_id') | list | first %}
            {{ weather if weather else none }}
          temperature: >-
            {% set weather = states.weather | map(attribute='entity_id') | list | first %}
            {% if weather %}
              {{ state_attr(weather, 'temperature') }}
            {% else %}
              {{ none }}
            {% endif %}
          humidity: >-
            {% set weather = states.weather | map(attribute='entity_id') | list | first %}
            {% if weather %}
              {{ state_attr(weather, 'humidity') }}
            {% else %}
              {{ none }}
            {% endif %}
      - name: Repo Next Calendar Event
        unique_id: repo_next_calendar_event
        icon: mdi:calendar-star
        state: >-
          {% set ns = namespace(next_title=None, next_start=None, next_entity=None) %}
          {% for cal in states.calendar %}
            {% set start = state_attr(cal.entity_id, 'start_time') %}
            {% if start %}
              {% set start_dt = as_datetime(start) %}
              {% if start_dt and start_dt >= now() %}
                {% if ns.next_start is none or start_dt < ns.next_start %}
                  {% set ns.next_start = start_dt %}
                  {% set ns.next_title = state_attr(cal.entity_id, 'message') or cal.name %}
                  {% set ns.next_entity = cal.entity_id %}
                {% endif %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if ns.next_title %}
            {{ ns.next_title }}
          {% else %}
            none
          {% endif %}
        attributes:
          start_time: >-
            {% set ns = namespace(next_start=None) %}
            {% for cal in states.calendar %}
              {% set start = state_attr(cal.entity_id, 'start_time') %}
              {% if start %}
                {% set start_dt = as_datetime(start) %}
                {% if start_dt and start_dt >= now() %}
                  {% if ns.next_start is none or start_dt < ns.next_start %}
                    {% set ns.next_start = start_dt %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if ns.next_start %}
              {{ ns.next_start.isoformat() }}
            {% else %}
              {{ none }}
            {% endif %}
          calendar_entity: >-
            {% set ns = namespace(next_entity=None, next_start=None) %}
            {% for cal in states.calendar %}
              {% set start = state_attr(cal.entity_id, 'start_time') %}
              {% if start %}
                {% set start_dt = as_datetime(start) %}
                {% if start_dt and start_dt >= now() %}
                  {% if ns.next_start is none or start_dt < ns.next_start %}
                    {% set ns.next_start = start_dt %}
                    {% set ns.next_entity = cal.entity_id %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ns.next_entity }}


lovelace:
  dashboards:
    repo_metrics_dashboard:
      mode: storage
      title: Repo Metrics & Devices
      icon: mdi:view-dashboard-outline
      show_in_sidebar: true
      require_admin: false
      url_path: repo
      config:
        title: Repo Metrics & Devices
        views:
          - title: Overview
            path: overview
            icon: mdi:view-dashboard
            theme: default
            badges:
              - entity: sensor.repo_lights_on_total
                name: Lights On
              - entity: sensor.repo_devices_offline_total
                name: Devices Offline
              - entity: sensor.repo_updates_available_total
                name: Updates Available
              - entity: sensor.repo_primary_weather
                name: Weather
              - entity: sensor.repo_next_calendar_event
                name: Next Event
              - entity: sensor.repo_stale_sensors_total
                name: Stale Sensors
            cards:
              - type: markdown
                content: |
                  ## Repo Metrics & Entities — Overview
                  Stay ahead of outages, updates, and environmental signals from a single glance.
              - type: custom:mushroom-chips-card
                alignment: center
                chips:
                  - type: template
                    entity: sensor.repo_lights_on_total
                    icon: mdi:lightbulb-on
                    content: "{{ states('sensor.repo_lights_on_total') }} Lights"
                    tap_action:
                      action: navigate
                      navigation_path: /repo/lighting
                  - type: template
                    entity: sensor.repo_devices_offline_total
                    icon: mdi:lan-disconnect
                    content: "{{ states('sensor.repo_devices_offline_total') }} Offline"
                    tap_action:
                      action: navigate
                      navigation_path: /repo/safety
                  - type: template
                    entity: sensor.repo_low_battery_total
                    icon: mdi:battery-alert
                    content: "{{ states('sensor.repo_low_battery_total') }} Low Batt"
                    tap_action:
                      action: navigate
                      navigation_path: /repo/safety
                  - type: template
                    entity: sensor.repo_updates_available_total
                    icon: mdi:update
                    content: "{{ states('sensor.repo_updates_available_total') }} Updates"
                    tap_action:
                      action: navigate
                      navigation_path: /repo/safety
                  - type: template
                    entity: sensor.speedtest_ping
                    icon: mdi:speedometer
                    content: "Ping {{ states('sensor.speedtest_ping') | default('–') }} ms"
                    tap_action:
                      action: navigate
                      navigation_path: /repo/network
                  - type: template
                    entity: sensor.repo_next_calendar_event
                    icon: mdi:calendar-clock
                    content: >-
                      {% set title = states('sensor.repo_next_calendar_event') %}
                      {% if title not in ['none', 'unknown', 'unavailable'] %}
                        {{ title }}
                      {% else %}
                        No upcoming events
                      {% endif %}
                    tap_action:
                      action: navigate
                      navigation_path: /repo/scenes-scripts
              - type: grid
                columns: 3
                square: false
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.repo_lights_on_total
                    name: Lights On
                    icon: mdi:lightbulb-group
                    tap_action:
                      action: navigate
                      navigation_path: /repo/lighting
                  - type: custom:mushroom-entity-card
                    entity: sensor.repo_devices_offline_total
                    name: Devices Offline
                    icon: mdi:alert-circle
                    tap_action:
                      action: navigate
                      navigation_path: /repo/safety
                  - type: custom:mushroom-entity-card
                    entity: sensor.repo_stale_sensors_total
                    name: Stale Sensors
                    icon: mdi:timer-sand
                    tap_action:
                      action: navigate
                      navigation_path: /repo/safety
                  - type: custom:mushroom-entity-card
                    entity: sensor.repo_low_battery_total
                    name: Low Battery
                    icon: mdi:battery-alert
                    tap_action:
                      action: navigate
                      navigation_path: /repo/safety
                  - type: custom:mushroom-entity-card
                    entity: sensor.repo_updates_available_total
                    name: Updates Available
                    icon: mdi:update
                    tap_action:
                      action: navigate
                      navigation_path: /repo/safety
                  - type: custom:mushroom-template-card
                    primary: >-
                      {% set weather = state_attr('sensor.repo_primary_weather', 'source_entity') %}
                      {% if weather %}
                        {{ states(weather) | title }}
                      {% else %}
                        Weather Unavailable
                      {% endif %}
                    secondary: >-
                      {% set weather = state_attr('sensor.repo_primary_weather', 'source_entity') %}
                      {% if weather %}
                        {{ state_attr(weather, 'temperature') }}° · {{ state_attr(weather, 'humidity') }}% RH
                      {% else %}
                        No weather entity detected
                      {% endif %}
                    icon: mdi:weather-partly-cloudy
                    tap_action:
                      action: more-info
                    multiline_secondary: true
              - type: horizontal-stack
                cards:
                  - type: weather-forecast
                    entity: weather.forecast_home
                    name: Home Forecast
                  - type: custom:apexcharts-card
                    experimental:
                      color_threshold: true
                    header:
                      show: true
                      title: Network Latency
                    series:
                      - entity: sensor.speedtest_ping
                        name: Ping
                        type: line
                        stroke_width: 2
                        show:
                          extremas: true
                    graph_span: 24h
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Recent Activity
                  show_header_toggle: false
                filter:
                  include:
                    - domain: light
                    - domain: switch
                    - domain: sensor
                    - domain: binary_sensor
                    - domain: update
                  exclude:
                    - state: 'unavailable'
                  sort:
                    method: last_changed
                    reverse: true
                show_empty: false
                unique: true
                card_param: entities
                max: 10
          - title: Lighting
            path: lighting
            icon: mdi:lightbulb-multiple
            cards:
              - type: custom:mushroom-title-card
                title: Lighting by Area
                subtitle: Quick controls for groups and individual fixtures.
              - type: grid
                columns: 2
                square: false
                cards:
                  - type: custom:mushroom-light-card
                    entity: light.office_lights
                    name: Office Lights
                  - type: custom:mushroom-light-card
                    entity: light.mainfloor_lights
                    name: Mainfloor Lights
                  - type: custom:mushroom-light-card
                    entity: light.front_porch_lights
                    name: Front Porch
                  - type: custom:mushroom-light-card
                    entity: light.garage_lights
                    name: Garage Lights
                  - type: custom:mushroom-light-card
                    entity: light.permanent_outdoor_lights
                    name: Permanent Outdoor Lights
                  - type: custom:mushroom-light-card
                    entity: light.all_lights
                    name: All Lights
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Office Lighting
                  show_header_toggle: false
                filter:
                  include:
                    - area: Office
                      domain: light
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Living Room Lighting
                  show_header_toggle: false
                filter:
                  include:
                    - area: Living Room
                      domain: light
                    - area: Sunroom
                      domain: light
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Bedroom Lighting
                  show_header_toggle: false
                filter:
                  include:
                    - area: Bedroom
                      domain: light
                    - area: Primary Bedroom
                      domain: light
                    - area: Guest Bedroom
                      domain: light
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Kitchen & Dining Lighting
                  show_header_toggle: false
                filter:
                  include:
                    - area: Kitchen
                      domain: light
                    - area: Dining Room
                      domain: light
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Garage & Exterior Lighting
                  show_header_toggle: false
                filter:
                  include:
                    - area: Garage
                      domain: light
                    - area: Exterior
                      domain: light
                    - area: Front Porch
                      domain: light
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:mushroom-chips-card
                alignment: start
                chips:
                  - type: template
                    icon: mdi:lightbulb-night
                    entity: scene.lighting_night_mode
                    content: Night Mode
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.lighting_night_mode
                  - type: template
                    icon: mdi:weather-sunset
                    entity: scene.lighting_evening_sunset_interior
                    content: Sunset Interior
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.lighting_evening_sunset_interior
                  - type: template
                    icon: mdi:weather-sunset-down
                    entity: scene.lighting_evening_sunset_exterior
                    content: Sunset Exterior
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.lighting_evening_sunset_exterior
          - title: Climate & Environment
            path: climate
            icon: mdi:thermostat
            cards:
              - type: custom:mushroom-title-card
                title: Comfort & Air Quality
                subtitle: Thermostats, temps, humidity, and air sensors.
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Thermostats
                  show_header_toggle: false
                filter:
                  include:
                    - domain: climate
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Temperature Sensors
                  show_header_toggle: false
                filter:
                  include:
                    - domain: sensor
                      device_class: temperature
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Humidity Sensors
                  show_header_toggle: false
                filter:
                  include:
                    - domain: sensor
                      device_class: humidity
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: custom:apexcharts-card
                  header:
                    show: true
                    title: Climate Trends (24h)
                  graph_span: 24h
                  all_series_config:
                    stroke_width: 2
                  series:
                    - entity: sensor.sunroom_temperature
                      name: Sunroom Temp
                    - entity: sensor.living_room_temperature
                      name: Living Room Temp
                    - entity: sensor.outdoor_temperature
                      name: Outdoor Temp
                filter:
                  include:
                    - entity_id: sensor.sunroom_temperature
                    - entity_id: sensor.living_room_temperature
                    - entity_id: sensor.outdoor_temperature
                show_empty: false
          - title: Safety & Power
            path: safety
            icon: mdi:shield-home
            cards:
              - type: custom:mushroom-title-card
                title: Safety, Battery & Update Watch
                subtitle: Keep an eye on offline devices, batteries, and firmware.
              - type: custom:mushroom-entity-card
                entity: sensor.repo_devices_offline_total
                name: Offline Devices
                icon: mdi:lan-disconnect
              - type: custom:mushroom-entity-card
                entity: sensor.repo_low_battery_total
                name: Low Batteries
                icon: mdi:battery-alert
              - type: custom:mushroom-entity-card
                entity: sensor.repo_updates_available_total
                name: Updates Available
                icon: mdi:update
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Offline or Unavailable Devices
                  show_header_toggle: false
                filter:
                  include:
                    - state: 'unavailable'
                    - state: 'unknown'
                    - state: 'offline'
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Low Battery Sensors (< 30%)
                  show_header_toggle: false
                filter:
                  include:
                    - domain: sensor
                      attributes:
                        device_class: battery
                      state: '< 30'
                    - domain: binary_sensor
                      attributes:
                        device_class: battery
                      state: 'on'
                  exclude:
                    - state: 'unknown'
                    - state: 'unavailable'
                    - state: 'None'
                sort:
                  method: state
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Available Updates
                  show_header_toggle: false
                filter:
                  include:
                    - domain: update
                      state: 'on'
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
          - title: Network
            path: network
            icon: mdi:lan
            cards:
              - type: custom:mushroom-title-card
                title: Network Health
                subtitle: Latency, throughput, and connectivity trends.
              - type: custom:mushroom-template-card
                primary: Latency Snapshot
                secondary: >-
                  Ping {{ states('sensor.speedtest_ping') | default('–') }} ms ·
                  Down {{ states('sensor.speedtest_download') | default('–') }} Mbps ·
                  Up {{ states('sensor.speedtest_upload') | default('–') }} Mbps
                icon: mdi:speedometer
                multiline_secondary: true
              - type: custom:apexcharts-card
                header:
                  show: true
                  title: Speedtest – 24h
                graph_span: 24h
                all_series_config:
                  stroke_width: 2
                  type: area
                  fill_raw: last
                series:
                  - entity: sensor.speedtest_download
                    name: Download
                    color: '#42a5f5'
                  - entity: sensor.speedtest_upload
                    name: Upload
                    color: '#66bb6a'
                  - entity: sensor.speedtest_ping
                    name: Ping
                    color: '#ef5350'
                    type: line
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Network Devices
                  show_header_toggle: false
                filter:
                  include:
                    - domain: sensor
                      entity_id: sensor.deco*
                    - domain: binary_sensor
                      entity_id: binary_sensor.deco*
                    - domain: update
                      entity_id: update.tp_link_*
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
          - title: Scenes & Scripts
            path: scenes-scripts
            icon: mdi:play-circle
            cards:
              - type: custom:mushroom-title-card
                title: Scenes & Scripts Hub
                subtitle: Trigger common lighting moods and routines.
              - type: custom:mushroom-chips-card
                alignment: start
                chips:
                  - type: template
                    icon: mdi:party-popper
                    entity: scene.huskers_sunroom_chase
                    content: Huskers Chase
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.huskers_sunroom_chase
                  - type: template
                    icon: mdi:lightbulb-multiple
                    entity: scene.lighting_daytime_cloudy_interior
                    content: Cloudy Interior
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.lighting_daytime_cloudy_interior
                  - type: template
                    icon: mdi:lightbulb-cfl
                    entity: scene.lighting_daytime_cloudy_exterior
                    content: Cloudy Exterior
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.lighting_daytime_cloudy_exterior
                  - type: template
                    icon: mdi:play-circle
                    entity: script.sunroom_segments_chase
                    content: Sunroom Chase Script
                    tap_action:
                      action: call-service
                      service: script.turn_on
                      target:
                        entity_id: script.sunroom_segments_chase
              - type: custom:auto-entities
                card:
                  type: entities
                  title: All Scenes
                  show_header_toggle: false
                filter:
                  include:
                    - domain: scene
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Scripts
                  show_header_toggle: false
                filter:
                  include:
                    - domain: script
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
          - title: Office
            path: office
            icon: mdi:chair-rolling
            cards:
              - type: custom:mushroom-title-card
                title: Office Overview
                subtitle: Lighting, climate, and sensors for the Office.
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Office Entities
                  show_header_toggle: false
                filter:
                  include:
                    - area: Office
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
          - title: Living Room
            path: living-room
            icon: mdi:sofa
            cards:
              - type: custom:mushroom-title-card
                title: Living Room Overview
                subtitle: Lights, climate, and sensors grouped by area.
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Living Room Entities
                  show_header_toggle: false
                filter:
                  include:
                    - area: Living Room
                    - area: Sunroom
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
          - title: Kitchen
            path: kitchen
            icon: mdi:stove
            cards:
              - type: custom:mushroom-title-card
                title: Kitchen Overview
                subtitle: Cooking, lighting, and safety signals.
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Kitchen & Dining Entities
                  show_header_toggle: false
                filter:
                  include:
                    - area: Kitchen
                    - area: Dining Room
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
          - title: Bedroom
            path: bedroom
            icon: mdi:bed-queen
            cards:
              - type: custom:mushroom-title-card
                title: Bedroom Overview
                subtitle: Comfort and nighttime controls.
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Bedroom Entities
                  show_header_toggle: false
                filter:
                  include:
                    - area: Bedroom
                    - area: Primary Bedroom
                    - area: Guest Bedroom
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
          - title: Garage
            path: garage
            icon: mdi:garage-variant
            cards:
              - type: custom:mushroom-title-card
                title: Garage Overview
                subtitle: Doors, lighting, and power monitoring.
              - type: custom:auto-entities
                card:
                  type: entities
                  title: Garage Entities
                  show_header_toggle: false
                filter:
                  include:
                    - area: Garage
                    - area: Exterior
                sort:
                  method: friendly_name
                  ignore_case: true
                show_empty: false
                unique: true
