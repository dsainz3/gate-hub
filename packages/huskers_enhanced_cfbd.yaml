# packages/huskers_enhanced_cfbd.yaml
# Free Nebraska football data using ESPN's public endpoints
rest:
  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard'
    method: GET
    scan_interval: 300
    sensor:
      - name: cfb_scoreboard_espn
        unique_id: cfb_scoreboard_espn
        value_template: >-
          {{ (value_json.events | length) if (value_json is defined and value_json.events is defined) else 0 }}
        json_attributes:
          - events
          - week
          - season
  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/teams/158'
    method: GET
    scan_interval: 3600
    sensor:
      - name: nebraska_team_info_espn
        unique_id: nebraska_team_info_espn
        value_template: >-
          {{ value_json.team.displayName if (value_json is defined and value_json.team is defined) else "Nebraska" }}
        json_attributes:
          - team
  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/teams?group=4'
    method: GET
    scan_interval: 1800
    sensor:
      - name: big_ten_teams_espn
        unique_id: big_ten_teams_espn
        value_template: >-
          {% if value_json is defined and value_json.sports is defined and value_json.sports|length > 0 and value_json.sports[0].leagues is defined and value_json.sports[0].leagues|length > 0 and value_json.sports[0].leagues[0].teams is defined %}
            {{ value_json.sports[0].leagues[0].teams | length }}
          {% else %}0{% endif %}
        json_attributes:
          - sports
  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/teams/158/schedule'
    method: GET
    scan_interval: 1800
    sensor:
      - name: nebraska_schedule_espn
        unique_id: nebraska_schedule_espn
        value_template: >-
          {{ (value_json.events | length) if (value_json is defined and value_json.events is defined) else 0 }}
        json_attributes:
          - events
          - team
          - requestedSeason
  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/rankings'
    method: GET
    scan_interval: 3600
    sensor:
      - name: cfb_rankings_espn
        unique_id: cfb_rankings_espn
        value_template: >-
          {{ (value_json.rankings | length) if (value_json is defined and value_json.rankings is defined) else 0 }}
        json_attributes:
          - rankings
template:
  - sensor:
      - name: huskers_game_status_free
        unique_id: huskers_game_status_free
        state: >-
          {% set events = state_attr('sensor.cfb_scoreboard_espn', 'events') or [] %}
          {% set game = namespace(ev=None) %}
          {% for e in events %}
            {% set comp = (e.competitions | default([])) | first %}
            {% if comp and comp.competitors is defined %}
              {% set has_huskers = comp.competitors | selectattr('team.id', 'equalto', '158') | list | count > 0 %}
              {% if has_huskers %}
                {% set game.ev = e %}
                {% break %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if game.ev %}
            {{ game.ev.status.type.description if (game.ev.status is defined and game.ev.status.type is defined) else 'Scheduled' }}
          {% else %}No game today{% endif %}
        attributes:
          home_team: >-
            {% set events = state_attr('sensor.cfb_scoreboard_espn', 'events') or [] %}
            {% set game = namespace(comp=None) %}
            {% for e in events %}
              {% set comp = (e.competitions | default([])) | first %}
              {% if comp and comp.competitors is defined and (comp.competitors | selectattr('team.id','equalto','158') | list | count) > 0 %}
                {% set game.comp = comp %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if game.comp %}
              {% set home = (game.comp.competitors | selectattr('homeAway','equalto','home') | list | first) %}
              {{ home.team.displayName if home and home.team is defined else '' }}
            {% endif %}
          away_team: >-
            {% set events = state_attr('sensor.cfb_scoreboard_espn', 'events') or [] %}
            {% set game = namespace(comp=None) %}
            {% for e in events %}
              {% set comp = (e.competitions | default([])) | first %}
              {% if comp and comp.competitors is defined and (comp.competitors | selectattr('team.id','equalto','158') | list | count) > 0 %}
                {% set game.comp = comp %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if game.comp %}
              {% set away = (game.comp.competitors | selectattr('homeAway','equalto','away') | list | first) %}
              {{ away.team.displayName if away and away.team is defined else '' }}
            {% endif %}
          home_score: >-
            {% set events = state_attr('sensor.cfb_scoreboard_espn', 'events') or [] %}
            {% set game = namespace(comp=None) %}
            {% for e in events %}
              {% set comp = (e.competitions | default([])) | first %}
              {% if comp and comp.competitors is defined and (comp.competitors | selectattr('team.id','equalto','158') | list | count) > 0 %}
                {% set game.comp = comp %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if game.comp %}
              {% set home = (game.comp.competitors | selectattr('homeAway','equalto','home') | list | first) %}
              {{ (home.score | int(0)) if home is defined and home.score is defined else 0 }}
            {% else %}0{% endif %}
          away_score: >-
            {% set events = state_attr('sensor.cfb_scoreboard_espn', 'events') or [] %}
            {% set game = namespace(comp=None) %}
            {% for e in events %}
              {% set comp = (e.competitions | default([])) | first %}
              {% if comp and comp.competitors is defined and (comp.competitors | selectattr('team.id','equalto','158') | list | count) > 0 %}
                {% set game.comp = comp %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if game.comp %}
              {% set away = (game.comp.competitors | selectattr('homeAway','equalto','away') | list | first) %}
              {{ (away.score | int(0)) if away is defined and away.score is defined else 0 }}
            {% else %}0{% endif %}
          quarter: >-
            {% set events = state_attr('sensor.cfb_scoreboard_espn', 'events')) or [] %}
            {% set game = namespace(ev=None) %}
            {% for e in events %}
              {% set comp = (e.competitions | default([])) | first %}
              {% if comp and comp.competitors is defined and (comp.competitors | selectattr('team.id','equalto','158') | list | count) > 0 %}
                {% set game.ev = e %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if game.ev and game.ev.status is defined %}
              {{ game.ev.status.period if game.ev.status.period is defined else 'N/A' }}
            {% else %}N/A{% endif %}
          clock: >-
            {% set events = state_attr('sensor.cfb_scoreboard_espn', 'events') or [] %}
            {% set game = namespace(ev=None) %}
            {% for e in events %}
              {% set comp = (e.competitions | default([])) | first %}
              {% if comp and comp.competitors is defined and (comp.competitors | selectattr('team.id','equalto','158') | list | count) > 0 %}
                {% set game.ev = e %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if game.ev and game.ev.status is defined %}
              {{ game.ev.status.displayClock if game.ev.status.displayClock is defined else 'N/A' }}
            {% else %}N/A{% endif %}
      - name: huskers_schedule_free
        unique_id: huskers_schedule_free
        state: >-
          {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
          {% if events %}
            ## Nebraska Schedule ({{ now().year }})
            {% for game in events %}
              {% set comp = (game.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set date = (game.date | as_datetime | as_local) if game.date is defined else none %}
              {% set us_home = comp.competitors[0].team.id == '158' if (comp.competitors is defined and comp.competitors|length >= 2) else false %}
              {% set opp = comp.competitors[1].team.displayName if us_home and comp.competitors|length >= 2 else (comp.competitors[0].team.displayName if comp.competitors|length >= 1 else 'TBD') %}
              {% set loc = 'vs' if us_home else 'at' %}
              {% set done = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if done %}
                {% set h = (comp.competitors | selectattr('homeAway','equalto','home') | list | first) %}
                {% set a = (comp.competitors | selectattr('homeAway','equalto','away') | list | first) %}
            - **{{ date.strftime('%b %-d, %-I:%M %p') if date else 'TBD' }}** — {{ loc }} {{ opp }} — **Final** {{ h.score if h and h.score is defined else '?' }}-{{ a.score if a and a.score is defined else '?' }}  # yamllint disable-line rule:line-length
              {% else %}
            - **{{ date.strftime('%b %-d, %-I:%M %p') if date else 'TBD' }}** — {{ loc }} {{ opp }}
              {% endif %}
            {% endfor %}
          {% else %}
            Schedule unavailable
          {% endif %}
      - name: huskers_record_free
        unique_id: huskers_record_free
        state: >-
          {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
          {% set w = 0 %}
          {% set l = 0 %}
          {% for game in events %}
            {% set comp = (game.competitions | default([])) | first %}
            {% if not comp or not (comp.status is defined and comp.status.type is defined and comp.status.type.completed) %}
              {% continue %}
            {% endif %}
            {% set huskers = comp.competitors | selectattr('team.id','equalto','158') | list | first %}
            {% set opp = comp.competitors | rejectattr('team.id','equalto','158') | list | first %}
            {% if huskers and opp and huskers.score is defined and opp.score is defined %}
              {% if (huskers.score | int(0)) > (opp.score | int(0)) %}
                {% set w = w + 1 %}
              {% else %}
                {% set l = l + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ w }}-{{ l }}
        attributes:
          wins: >-
            {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
            {% set w = 0 %}
            {% for game in events %}
              {% set comp = (game.competitions | default([])) | first %}
              {% if comp and comp.status is defined and comp.status.type is defined and comp.status.type.completed %}
                {% set huskers = comp.competitors | selectattr('team.id','equalto','158') | list | first %}
                {% set opp = comp.competitors | rejectattr('team.id','equalto','158') | list | first %}
                {% if huskers and opp and huskers.score is defined and opp.score is defined and (huskers.score | int(0)) > (opp.score | int(0)) %}
                  {% set w = w + 1 %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ w }}
          losses: >-
            {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
            {% set l = 0 %}
            {% for game in events %}
              {% set comp = (game.competitions | default([])) | first %}
              {% if comp and comp.status is defined and comp.status.type is defined and comp.status.type.completed %}
                {% set huskers = comp.competitors | selectattr('team.id','equalto','158') | list | first %}
                {% set opp = comp.competitors | rejectattr('team.id','equalto','158') | list | first %}
                {% if huskers and opp and huskers.score is defined and opp.score is defined and (huskers.score | int(0)) <= (opp.score | int(0)) %}
                  {% set l = l + 1 %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ l }}
          percentage: >-
            {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
            {% set w = 0 %}
            {% set l = 0 %}
            {% for game in events %}
              {% set comp = (game.competitions | default([])) | first %}
              {% if comp and comp.status is defined and comp.status.type is defined and comp.status.type.completed %}
                {% set huskers = comp.competitors | selectattr('team.id','equalto','158') | list | first %}
                {% set opp = comp.competitors | rejectattr('team.id','equalto','158') | list | first %}
                {% if huskers and opp and huskers.score is defined and opp.score is defined %}
                  {% if (huskers.score | int(0)) > (opp.score | int(0)) %}
                    {% set w = w + 1 %}
                  {% else %}
                    {% set l = l + 1 %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% set total = w + l %}
            {{ ('%.3f' % (w / total)) if total > 0 else '0.000' }}
      - name: big_ten_standings_free
        unique_id: big_ten_standings_free
        state: >-
          {% set data = state_attr('sensor.big_ten_teams_espn', 'sports') %}
          {% if data and data|length > 0 and data[0].leagues is defined and data[0].leagues|length > 0 and data[0].leagues[0].teams is defined %}
            {% set teams = data[0].leagues[0].teams %}
            ## Big Ten Standings ({{ now().year }})
            | Rank | Team | Record |
            |------|------|--------|
            {%- for t in teams | sort(attribute='team.standingSummary', reverse=true) -%}
            | {{ loop.index }} | {{ t.team.displayName }} | {{ t.team.standingSummary or 'N/A' }} |
            {%- endfor -%}
          {% else %}
            Big Ten standings unavailable
          {% endif %}
      - name: huskers_rankings_free
        unique_id: huskers_rankings_free
        state: >-
          {% set rankings = state_attr('sensor.cfb_rankings_espn', 'rankings') or [] %}
          {% set rank = 'Unranked' %}
          {% for poll in rankings %}
            {% if poll.name == 'AP Top 25' and poll.ranks is defined %}
              {% for team in poll.ranks %}
                {% if team.team is defined and team.team.id == '158' %}
                  {% set rank = '#' ~ team.current %}
                  {% break %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {{ rank }}
        attributes:
          ap_rank: >-
            {% set rankings = state_attr('sensor.cfb_rankings_espn', 'rankings') or [] %}
            {% set rank = none %}
            {% for poll in rankings %}
              {% if poll.name == 'AP Top 25' and poll.ranks is defined %}
                {% for team in poll.ranks %}
                  {% if team.team is defined and team.team.id == '158' %}
                    {% set rank = team.current %}
                    {% break %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
            {{ rank if rank is not none else '' }}
      - name: huskers_next_game_free
        unique_id: huskers_next_game_free
        state: >-
          {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
          {% set now_ts = now().timestamp() %}
          {% set next = namespace(g=None) %}
          {% for g in events %}
            {% set comp = (g.competitions | default([])) | first %}
            {% if not comp %}{% continue %}{% endif %}
            {% set dt = g.date | as_datetime if g.date is defined else none %}
            {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
            {% if dt and not completed and dt.timestamp() > now_ts and next.g is none %}
              {% set next.g = g %}
            {% endif %}
          {% endfor %}
          {% if next.g %}
            {% set comp = next.g.competitions | first %}
            {% set us_home = comp.competitors[0].team.id == '158' if (comp.competitors is defined and comp.competitors|length >= 2) else false %}
            {% set opponent = comp.competitors[1].team.displayName if us_home and comp.competitors|length >= 2 else (comp.competitors[0].team.displayName if comp.competitors|length >= 1 else 'TBD') %}
            {% set loc = 'vs' if us_home else 'at' %}
            {{ loc }} {{ opponent }}
          {% else %}No upcoming games{% endif %}
        attributes:
          opponent: >-
            {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next = namespace(g=None) %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime if g.date is defined else none %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if dt and not completed and dt.timestamp() > now_ts and next.g is none %}
                {% set next.g = g %}
              {% endif %}
            {% endfor %}
            {% if next.g %}
              {% set comp = next.g.competitions | first %}
              {% set us_home = comp.competitors[0].team.id == '158' if (comp.competitors is defined and comp.competitors|length >= 2) else false %}
              {% set opponent = comp.competitors[1].team.displayName if us_home and comp.competitors|length >= 2 else (comp.competitors[0].team.displayName if comp.competitors|length >= 1 else 'TBD') %}  # yamllint disable-line rule:line-length
              {{ opponent }}
            {% else %}''{% endif %}
          kickoff_time: >-
            {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next = namespace(g=None) %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime if g.date is defined else none %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if dt and not completed and dt.timestamp() > now_ts and next.g is none %}
                {% set next.g = g %}
              {% endif %}
            {% endfor %}
            {% if next.g %}
              {{ next.g.date }}
            {% else %}''{% endif %}
          home_away: >-
            {% set events = state_attr('sensor.nebraska_schedule_espn', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next = namespace(g=None) %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime if g.date is defined else none %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if dt and not completed and dt.timestamp() > now_ts and next.g is none %}
                {% set next.g = g %}
              {% endif %}
            {% endfor %}
            {% if next.g %}
              {% set comp = next.g.competitions | first %}
              {{ 'home' if (comp.competitors is defined and comp.competitors|length >= 2 and comp.competitors[0].team.id == '158') else 'away' }}
            {% else %}''{% endif %}
  - binary_sensor:
      - name: huskers_is_pregame_free
        unique_id: huskers_is_pregame_free
        state: >-
          {% set status = states('sensor.huskers_game_status_free') %}
          {{ status in ['Scheduled', 'Pre-Game', 'Postponed', 'Delayed'] }}
      - name: huskers_is_live_free
        unique_id: huskers_is_live_free
        state: >-
          {% set status = states('sensor.huskers_game_status_free') %}
          {{ status in ['In Progress', 'Halftime', '1st Quarter', '2nd Quarter', '3rd Quarter', '4th Quarter', 'Overtime', 'End Period'] }}
      - name: huskers_is_postgame_free
        unique_id: huskers_is_postgame_free
        state: >-
          {% set status = states('sensor.huskers_game_status_free') %}
          {{ status in ['Final', 'Final/OT'] }}
