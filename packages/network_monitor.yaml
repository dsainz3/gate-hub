# packages/network_monitor.yaml
# Lightweight network monitoring focused on Speedtest data.

template:
  - binary_sensor:
      - name: Internet Reachability
        unique_id: network_monitor_internet_reachability
        device_class: connectivity
        # ONLINE when we have a recent speedtest and non-zero ping & reasonable download
        state: >-
          {% set ping = states('sensor.speedtest_ping') | float(0) %}
          {% set down = states('sensor.speedtest_download') | float(0) %}
          {% set last = states.sensor.speedtest_download.last_changed if states.sensor.speedtest_download is not none else none %}
          {% set age = (now().timestamp() - as_timestamp(last, 0)) %}
          {{ ping > 0 and down > 1 and age < 7200 }}
        attributes:
          ping_ms: "{{ states('sensor.speedtest_ping') | float(0) }}"
          download_mbps: "{{ states('sensor.speedtest_download') | float(0) }}"
          upload_mbps: "{{ states('sensor.speedtest_upload') | float(0) }}"
          last_result_changed: "{{ states.sensor.speedtest_download.last_changed }}"

    sensor:
      - name: Internet Latency
        unique_id: network_monitor_internet_latency
        unit_of_measurement: ms
        device_class: duration
        state_class: measurement
        state: >-
          {% set age_limit = 2 * 3600 %}
          {% set p = states('sensor.speedtest_ping') | float(0) %}
          {% set last = states.sensor.speedtest_ping.last_changed if states.sensor.speedtest_ping is not none else none %}
          {% set age = (now().timestamp() - as_timestamp(last, 0)) %}
          {{ iif(p > 0 and age < age_limit, p | round(1), 'unknown') }}
        availability: >-
          {% set last = states.sensor.speedtest_ping.last_changed if states.sensor.speedtest_ping is not none else none %}
          {% set age = (now().timestamp() - as_timestamp(last, 0)) %}
          {{ (states('sensor.speedtest_ping') | float(0)) > 0 and age < 7200 }}

      - name: Network Status Summary
        unique_id: network_status_summary
        icon: mdi:lan-check
        state: >-
          {% if is_state('binary_sensor.internet_reachability_2', 'on') %}
            Online
          {% elif is_state('binary_sensor.internet_reachability_2', 'off') %}
            Offline
          {% else %}
            Unknown
          {% endif %}
        attributes:
          latency_ms: "{{ states('sensor.internet_latency_2') | float(0) | round(1) }}"
          speedtest_ping_ms: "{{ states('sensor.speedtest_ping') | float(0) | round(1) }}"
          speedtest_download_mbps: "{{ states('sensor.speedtest_download') | float(0) | round(1) }}"
          speedtest_upload_mbps: "{{ states('sensor.speedtest_upload') | float(0) | round(1) }}"
          last_speedtest: >-
            {% set entity = states.sensor.speedtest_download %}
            {% if entity is not none and entity.last_changed %}
              {% set ts = as_timestamp(entity.last_changed) %}
              {% set date = ts | timestamp_custom('%Y-%m-%dT%H:%M:%S', True) %}
              {% set offset = ts | timestamp_custom('%z', True) %}
              {{ date ~ offset[:3] ~ ':' ~ offset[3:] }}
            {% else %}
              unavailable
            {% endif %}

      - name: Speedtest Last Run
        unique_id: network_speedtest_last_run
        device_class: timestamp
        state: >-
          {% set entity = states.sensor.speedtest_download %}
          {% if entity is not none and entity.last_changed %}
            {% set ts = as_timestamp(entity.last_changed) %}
            {% set date = ts | timestamp_custom('%Y-%m-%dT%H:%M:%S', True) %}
            {% set offset = ts | timestamp_custom('%z', True) %}
            {{ date ~ offset[:3] ~ ':' ~ offset[3:] }}
          {% else %}
            unknown
          {% endif %}
