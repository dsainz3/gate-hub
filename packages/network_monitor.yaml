# packages/network_monitor.yaml
# Lightweight network monitoring focused on ping latency and Speedtest data.

binary_sensor:
  - platform: command_line
    name: Internet Reachability
    unique_id: network_monitor_internet_reachability
    command: >-
      curl -o /dev/null -s --max-time 5 https://1.1.1.1 && echo online || echo offline
    payload_on: online
    payload_off: offline
    device_class: connectivity
    scan_interval: 60

sensor:
  - platform: command_line
    name: Internet Latency
    unique_id: network_monitor_internet_latency
    command: >-
      curl -o /dev/null -s -w '%{time_connect}' --max-time 5 https://1.1.1.1 || echo nan
    unit_of_measurement: ms
    device_class: duration
    state_class: measurement
    value_template: >-
      {% set invalid = ['nan', '', 'None'] %}
      {% if value not in invalid %}
        {{ (value | float(default=0) * 1000) | round(1) }}
      {% else %}
        unknown
      {% endif %}
    availability_template: >-
      {{ value not in ['nan', '', 'None'] }}
    scan_interval: 120

template:
  - sensor:
      - name: Network Status Summary
        unique_id: network_status_summary
        icon: mdi:lan-check
        state: >-
          {% if is_state('binary_sensor.internet_reachability', 'on') %}
            Online
          {% elif is_state('binary_sensor.internet_reachability', 'off') %}
            Offline
          {% else %}
            Unknown
          {% endif %}
        attributes:
          latency_ms: >-
            {{ states('sensor.internet_latency') | float(default=0) | round(1) }}
          speedtest_ping_ms: >-
            {{ states('sensor.speedtest_ping') | float(default=0) | round(1) }}
          speedtest_download_mbps: >-
            {{ states('sensor.speedtest_download') | float(default=0) | round(1) }}
          speedtest_upload_mbps: >-
            {{ states('sensor.speedtest_upload') | float(default=0) | round(1) }}
          last_speedtest: >-
            {% set entity = states.sensor.speedtest_download %}
            {% if entity is not none and entity.last_changed %}
              {% set ts = as_timestamp(entity.last_changed) %}
              {% set date = ts | timestamp_custom('%Y-%m-%dT%H:%M:%S', True) %}
              {% set offset = ts | timestamp_custom('%z', True) %}
              {{ date ~ offset[:3] ~ ':' ~ offset[3:] }}
            {% else %}
              unavailable
            {% endif %}
      - name: Speedtest Last Run
        unique_id: network_speedtest_last_run
        device_class: timestamp
        state: >-
          {% set entity = states.sensor.speedtest_download %}
          {% if entity is not none and entity.last_changed %}
            {% set ts = as_timestamp(entity.last_changed) %}
            {% set date = ts | timestamp_custom('%Y-%m-%dT%H:%M:%S', True) %}
            {% set offset = ts | timestamp_custom('%z', True) %}
            {{ date ~ offset[:3] ~ ':' ~ offset[3:] }}
          {% else %}
            unknown
          {% endif %}
