# packages/huskers.yaml
# Single-package setup for Nebraska Huskers:
# - ESPN REST endpoints (raw data)
# - Template sensors (schedule/status/scores/record/standings/kickoff)
# - ESPN phase flags (pre/live/post)
# - Helpers (inputs, groups, scenes)
# - Light show scripts
# - Automations (pregame T-20, TD burst, postgame cleanup)

################################################################################
# RAW DATA (ESPN)
################################################################################
rest:
  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard'
    method: GET
    scan_interval: 300
    timeout: 30
    sensor:
      - name: espn_cfb_scoreboard
        unique_id: espn_cfb_scoreboard
        value_template: >-
          {{ (value_json.events | length) if (value_json is defined and value_json.events is defined) else 0 }}
        json_attributes:
          - events
          - week
          - season
        availability: >-
          {{ value_json is defined }}

  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/teams/158'
    method: GET
    scan_interval: 3600
    timeout: 30
    sensor:
      - name: espn_nebraska_team_info
        unique_id: espn_nebraska_team_info
        value_template: >-
          {{ value_json.team.displayName if (value_json is defined and value_json.team is defined) else 'Nebraska' }}
        json_attributes:
          - team
        availability: >-
          {{ value_json is defined }}

  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/teams/158/schedule'
    method: GET
    scan_interval: 1800
    timeout: 30
    sensor:
      - name: espn_nebraska_schedule
        unique_id: espn_nebraska_schedule
        value_template: >-
          {{ (value_json.events | length) if (value_json is defined and value_json.events is defined) else 0 }}
        json_attributes:
          - events
          - team
          - requestedSeason
        availability: >-
          {{ value_json is defined }}

  - resource: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/rankings'
    method: GET
    scan_interval: 3600
    timeout: 30
    sensor:
      - name: espn_cfb_rankings
        unique_id: espn_cfb_rankings
        value_template: >-
          {{ (value_json.rankings | length) if (value_json is defined and value_json.rankings is defined) else 0 }}
        json_attributes:
          - rankings
        availability: >-
          {{ value_json is defined }}

  - resource_template: >-
      {% set season = state_attr('sensor.espn_nebraska_schedule', 'requestedSeason') %}
      {% if season is mapping %}
        {% set season_year = season['year'] if 'year' in season else now().year %}
        {% set season_type = season['type'] if 'type' in season else 2 %}
      {% else %}
        {% set season_year = now().year %}
        {% set season_type = 2 %}
      {% endif %}
      {% set current_year = now().year %}
      {% set adjusted_year = season_year if season_year <= current_year else current_year %}
      {% if adjusted_year == current_year and now().month < 6 %}
        {% set adjusted_year = adjusted_year - 1 %}
      {% endif %}
      https://sports.core.api.espn.com/v2/sports/football/leagues/college-football/seasons/{{ adjusted_year }}/types/{{ season_type }}/groups/5/standings/0?lang=en&region=us
    method: GET
    scan_interval: 1800
    timeout: 30
    sensor:
      - name: espn_big_ten_teams
        unique_id: espn_big_ten_teams
        value_template: >-
          {% if value_json is defined and value_json.standings is defined %}
            {{ value_json.standings | length }}
          {% else %}0{% endif %}
        json_attributes:
          - standings
          - displayName
        availability: >-
          {{ value_json is defined and value_json.standings is defined and value_json.standings | length > 0 }}

################################################################################
# HELPERS
################################################################################
input_boolean:
  huskers_automations_enabled:
    name: Huskers Automations Enabled
    icon: mdi:flag-checkered
    initial: true

  huskers_game_mode:
    name: Huskers Game Mode
    icon: mdi:stadium

  huskers_test_mode:
    name: Huskers Test Mode
    icon: mdi:flask
    initial: false

  huskers_use_manual_score:
    name: Huskers Use Manual Score
    icon: mdi:tune
    initial: false

  huskers_use_manual_kickoff:
    name: Huskers Use Manual Kickoff
    icon: mdi:timer-cog
    initial: false

  huskers_use_score_delay:
    name: Huskers Use Score Delay
    icon: mdi:clock-alert
    initial: false

  huskers_color_show:
    name: Huskers Color Show Active
    icon: mdi:lightbulb-group
    initial: false

  huskers_theater_show_running:
    name: Huskers Theater Show Running
    icon: mdi:theater
    initial: false

input_number:
  huskers_chase_cycle_seconds:
    name: Chase Cycle Length
    icon: mdi:speedometer
    min: 8
    max: 120
    step: 1
    mode: slider
    unit_of_measurement: s
    initial: 30

  huskers_hail_bpm:
    name: Hail Varsity BPM
    icon: mdi:metronome
    min: 80
    max: 180
    step: 1
    mode: slider
    unit_of_measurement: bpm
    initial: 132

  huskers_hail_varsity_bpm:
    name: Hail Varsity BPM (Alias)
    icon: mdi:metronome
    min: 80
    max: 180
    step: 1
    mode: slider
    unit_of_measurement: bpm
    initial: 132

  huskers_our_score:
    name: Our Score (Auto)
    icon: mdi:scoreboard
    min: 0
    max: 100
    step: 1
    initial: 0

  huskers_our_score_manual:
    name: Our Score (Manual)
    icon: mdi:account-edit
    min: 0
    max: 100
    step: 1
    initial: 0
  huskers_opponent_score_manual:
    name: Opponent Score (Manual)
    icon: mdi:account-multiple
    min: 0
    max: 100
    step: 1
    initial: 0

  huskers_kickoff_in_manual:
    name: Kickoff In (Manual)
    icon: mdi:clock-edit
    min: -300
    max: 300
    step: 1
    unit_of_measurement: min
    initial: 60

################################################################################
# CONNECTIVITY
################################################################################

input_text:
  huskers_last_score:
    name: Huskers Last Score Text
    icon: mdi:text

  huskers_game_clock_manual:
    name: Huskers Game Clock (Manual)
    icon: mdi:timer-outline
    initial: '--:--'

  huskers_quarter_manual:
    name: Huskers Quarter (Manual)
    icon: mdi:numeric
    initial: '1'

################################################################################
# GROUPS
################################################################################
group:
  huskers_eight_lights:
    name: Huskers â€“ All Eight Lights
    entities:
      - light.light_theater_left
      - light.light_theater_right
      - light.light_front_left
      - light.light_front_right
      - light.light_garage_left
      - light.light_garage_center
      - light.light_garage_right
      - light.light_office

################################################################################
# SCRIPTS
################################################################################
script:
  huskers_chase30_start:
    alias: 'Huskers: Start Cream Chase (45s Dual)'
    mode: restart
    sequence:
      - variables:
          permanent_light: light.permanent_outdoor_lights
          husker_effect_name: >-
            {% set effects = state_attr('light.permanent_outdoor_lights', 'effect_list') or [] %}
            {% if 'LED-Gametime' in effects %}
              LED-Gametime
            {% elif 'Husker' in effects %}
              Husker
            {% elif 'Nebraska' in effects %}
              Nebraska
            {% else %}
              ''
            {% endif %}
          scarlet_rgb: [228, 28, 56]
          cream_rgb: [253, 243, 231]
          chase_brightness_pct: 80
          permanent_brightness_pct: 100
      - service: script.turn_off
        target:
          entity_id: script.huskers_chase_speed_loop
        continue_on_error: true
      - service: scene.create
        data:
          scene_id: huskers_before_chase
          snapshot_entities: >-
            {% set base = expand('group.huskers_eight_lights') | map(attribute='entity_id') | list %}
            {% if has_value(permanent_light) %}
              {{ base + [permanent_light] }}
            {% else %}
              {{ base }}
            {% endif %}
      - service: light.turn_on
        target:
          entity_id: group.huskers_eight_lights
        data:
          rgb_color: '{{ scarlet_rgb }}'
          brightness_pct: '{{ chase_brightness_pct }}'
          transition: 0.1
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ has_value(permanent_light) }}"
            sequence:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ husker_effect_name != '' }}"
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: '{{ permanent_light }}'
                        data:
                          effect: '{{ husker_effect_name }}'
                          brightness_pct: '{{ permanent_brightness_pct }}'
                default:
                  - service: light.turn_on
                    target:
                      entity_id: '{{ permanent_light }}'
                    data:
                      rgb_color: '{{ scarlet_rgb }}'
                      brightness_pct: '{{ permanent_brightness_pct }}'
                      transition: 0.1
      - service: script.turn_on
        target:
          entity_id: script.huskers_chase30_loop

  huskers_chase30_loop:
    alias: 'Huskers: Cream Chase LOOP (45s Dual)'
    mode: restart
    sequence:
      - variables:
          lights:
            - light.light_theater_left
            - light.light_theater_right
            - light.light_front_left
            - light.light_front_right
            - light.light_garage_left
            - light.light_garage_center
            - light.light_garage_right
            - light.light_office
          accent_spacing: 3
          cycle_ms: 45000
          step_ms: '{{ (cycle_ms / (lights | count)) | int }}'
          xfade_ms: 2000
          transition_sec: '{{ (xfade_ms / 1000) | float }}'
          scarlet_rgb: [228, 28, 56]
          cream_rgb: [253, 243, 231]
          chase_brightness_pct: 80
          permanent_brightness_pct: 100
          hold_ms: '{{ [ (step_ms - xfade_ms) | int, 250 ] | max }}'
      - repeat:
          while:
            - condition: template
              value_template: '{{ true }}'
          sequence:
            - repeat:
                count: '{{ lights | count }}'
                sequence:
                  - variables:
                      total: '{{ lights | count }}'
                      spacing: '{{ [accent_spacing | int, (lights | count) - 1] | min }}'
                      current_index: '{{ ((repeat.index | int) - 1) % total }}'
                      secondary_index: '{{ (current_index + spacing) % total }}'
                      prev_primary_index: '{{ (current_index - 1) % total }}'
                      prev_secondary_index: '{{ (prev_primary_index + spacing) % total }}'
                      primary_light: '{{ lights[current_index|int] }}'
                      secondary_light: '{{ lights[secondary_index|int] }}'
                      prev_primary_light: '{{ lights[prev_primary_index|int] }}'
                      prev_secondary_light: '{{ lights[prev_secondary_index|int] }}'
                  - service: light.turn_on
                    target:
                      entity_id: '{{ prev_primary_light }}'
                    data:
                      rgb_color: '{{ scarlet_rgb }}'
                      brightness_pct: '{{ chase_brightness_pct }}'
                      transition: '{{ transition_sec }}'
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ prev_secondary_light != prev_primary_light }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: '{{ prev_secondary_light }}'
                            data:
                              rgb_color: '{{ scarlet_rgb }}'
                              brightness_pct: '{{ chase_brightness_pct }}'
                              transition: '{{ transition_sec }}'
                  - service: light.turn_on
                    target:
                      entity_id: '{{ primary_light }}'
                    data:
                      rgb_color: '{{ cream_rgb }}'
                      brightness_pct: '{{ chase_brightness_pct }}'
                      transition: '{{ transition_sec }}'
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ secondary_light != primary_light }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: '{{ secondary_light }}'
                            data:
                              rgb_color: '{{ cream_rgb }}'
                              brightness_pct: '{{ chase_brightness_pct }}'
                              transition: '{{ transition_sec }}'
                  - delay:
                      milliseconds: '{{ hold_ms | int }}'

  huskers_chase30_stop:
    alias: 'Huskers: Stop Cream Chase (restore)'
    mode: single
    sequence:
      - service: script.turn_off
        target:
          entity_id: script.huskers_chase30_loop
      - delay: '00:00:00.5'
      - service: scene.turn_on
        target:
          entity_id: scene.huskers_before_chase
        continue_on_error: true

  huskers_chase_speed_start:
    alias: 'Huskers: Start Cream Chase (Variable-Speed)'
    mode: restart
    sequence:
      - variables:
          permanent_light: light.permanent_outdoor_lights
          husker_effect_name: >-
            {% set effects = state_attr('light.permanent_outdoor_lights', 'effect_list') or [] %}
            {% if 'LED-Gametime' in effects %}
              LED-Gametime
            {% elif 'Husker' in effects %}
              Husker
            {% elif 'Nebraska' in effects %}
              Nebraska
            {% else %}
              ''
            {% endif %}
          scarlet_rgb: [228, 28, 56]
          cream_rgb: [253, 243, 231]
          chase_brightness_pct: 80
      - service: script.turn_off
        target:
          entity_id: script.huskers_chase30_loop
        continue_on_error: true
      - service: scene.create
        data:
          scene_id: huskers_before_chase
          snapshot_entities: >-
            {% set base = expand('group.huskers_eight_lights') | map(attribute='entity_id') | list %}
            {% if has_value(permanent_light) %}
              {{ base + [permanent_light] }}
            {% else %}
              {{ base }}
            {% endif %}
      - service: light.turn_on
        target:
          entity_id: group.huskers_eight_lights
        data:
          rgb_color: '{{ scarlet_rgb }}'
          brightness_pct: '{{ chase_brightness_pct }}'
          transition: 0.1
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ has_value(permanent_light) }}"
            sequence:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ husker_effect_name != '' }}"
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: '{{ permanent_light }}'
                        data:
                          effect: '{{ husker_effect_name }}'
                          brightness_pct: '{{ permanent_brightness_pct }}'
                default:
                  - service: light.turn_on
                    target:
                      entity_id: '{{ permanent_light }}'
                    data:
                      rgb_color: '{{ scarlet_rgb }}'
                      brightness_pct: '{{ permanent_brightness_pct }}'
                      transition: 0.1
      - service: script.turn_on
        target:
          entity_id: script.huskers_chase_speed_loop

  huskers_chase_speed_loop:
    alias: 'Huskers: Cream Chase LOOP (Variable-Speed)'
    mode: restart
    sequence:
      - variables:
          lights:
            - light.light_theater_left
            - light.light_theater_right
            - light.light_front_left
            - light.light_front_right
            - light.light_garage_left
            - light.light_garage_center
            - light.light_garage_right
            - light.light_office
      - repeat:
          while:
            - condition: template
              value_template: '{{ true }}'
          sequence:
            - variables:
                cycle_secs: "{{ states('input_number.huskers_chase_cycle_seconds') | float(30) }}"
                step_ms: '{{ (cycle_secs * 1000 / (lights | count)) | int }}'
                xfade_ms: 300
                hold_ms: '{{ [ (step_ms - xfade_ms) | int, 250 ] | max }}'
            - repeat:
                for_each: '{{ lights }}'
                sequence:
                  - variables:
                      current: '{{ repeat.item }}'
                      prev_index: '{{ (repeat.index - 2) % (lights | count) }}'
                      previous: '{{ lights[prev_index|int] }}'
                  - service: light.turn_on
                    target:
                      entity_id: '{{ previous }}'
                    data:
                      hs_color: [355, 90]
                      brightness: 255
                      transition: 0.3
                  - service: light.turn_on
                    target:
                      entity_id: '{{ current }}'
                    data:
                      hs_color: [45, 20]
                      brightness: 255
                      transition: 0.3
                  - delay:
                      milliseconds: '{{ hold_ms | int }}'

  huskers_chase_speed_stop:
    alias: 'Huskers: Stop Cream Chase (Variable-Speed, restore)'
    mode: single
    sequence:
      - service: script.turn_off
        target:
          entity_id: script.huskers_chase_speed_loop
      - delay: '00:00:00.5'
      - service: scene.turn_on
        target:
          entity_id: scene.huskers_before_chase
        continue_on_error: true

  huskers_hail_burst_8s:
    alias: 'Huskers: Hail Varsity Burst (8s BPM)'
    mode: restart
    sequence:
      - variables:
          permanent_light: light.permanent_outdoor_lights
          husker_effect_name: >-
            {% set effects = state_attr('light.permanent_outdoor_lights', 'effect_list') or [] %}
            {% if 'LED-Gametime' in effects %}
              LED-Gametime
            {% elif 'Husker' in effects %}
              Husker
            {% elif 'Nebraska' in effects %}
              Nebraska
            {% else %}
              ''
            {% endif %}
          scarlet_rgb: [228, 28, 56]
          cream_rgb: [253, 243, 231]
          chase_brightness_pct: 80
          permanent_brightness_pct: 100
      - variables:
          lights:
            - light.light_theater_left
            - light.light_theater_right
            - light.light_front_left
            - light.light_front_right
            - light.light_garage_left
            - light.light_garage_center
            - light.light_garage_right
            - light.light_office
          bpm: "{{ states('input_number.huskers_hail_bpm') | float(132) }}"
          beat_ms: '{{ (60000 / bpm) | int }}'
          total_ms: 8000
          beats: '{{ (total_ms / beat_ms) | round(0) | int }}'
          patterns:
            -   - light.light_theater_left
                - light.light_front_right
            -   - light.light_theater_right
                - light.light_front_left
            -   - light.light_garage_left
                - light.light_office
            -   - light.light_garage_center
                - light.light_garage_right
            -   - light.light_theater_left
                - light.light_garage_left
                - light.light_office
            -   - light.light_theater_right
                - light.light_garage_right
                - light.light_front_right
      - service: scene.create
        data:
          scene_id: huskers_before_burst
          snapshot_entities: >-
            {% set base = expand('group.huskers_eight_lights') | map(attribute='entity_id') | list %}
            {% if has_value(permanent_light) %}
              {{ base + [permanent_light] }}
            {% else %}
              {{ base }}
            {% endif %}
      - service: light.turn_on
        target:
          entity_id: group.huskers_eight_lights
        data:
          rgb_color: '{{ scarlet_rgb }}'
          brightness_pct: '{{ chase_brightness_pct }}'
          transition: 0.05
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ has_value(permanent_light) }}"
            sequence:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ husker_effect_name != '' }}"
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: '{{ permanent_light }}'
                        data:
                          effect: '{{ husker_effect_name }}'
                          brightness_pct: '{{ permanent_brightness_pct }}'
                default:
                  - service: light.turn_on
                    target:
                      entity_id: '{{ permanent_light }}'
                    data:
                      rgb_color: '{{ scarlet_rgb }}'
                      brightness_pct: '{{ permanent_brightness_pct }}'
                      transition: 0.05
      - repeat:
          count: '{{ [beats, 1] | max }}'
          sequence:
            - variables:
                cream_set: '{{ patterns | random }}'
            - service: light.turn_on
              target:
                entity_id: group.huskers_eight_lights
              data:
                rgb_color: '{{ scarlet_rgb }}'
                brightness_pct: '{{ chase_brightness_pct }}'
                transition: 0
            - service: light.turn_on
              target:
                entity_id: '{{ cream_set }}'
              data:
                rgb_color: '{{ cream_rgb }}'
                brightness_pct: '{{ chase_brightness_pct }}'
                transition: 0.05
            - delay:
                milliseconds: '{{ (beat_ms * 0.80) | int }}'
      - service: scene.turn_on
        target:
          entity_id: scene.huskers_before_burst
        continue_on_error: true

  kiosk_stop_all_huskers_shows:
    alias: 'Kiosk: Stop All Huskers Shows'
    mode: single
    sequence:
      - service: script.turn_on
        target:
          entity_id:
            - script.huskers_chase30_stop
            - script.huskers_chase_speed_stop

  # Debug helper routines exposed as scripts rather than automations
  huskers_debug_exterior_brightness:
    alias: '[Huskers Debug] Exterior brightness check'
    mode: single
    variables:
      cloud_cover: "{{ states('sensor.openweathermap_cloud_coverage') | int(50) }}"
      calc_pct: >-
        {% set pct = 100 - (cloud_cover * 0.6) %}
        {{ [10, [pct|round(0), 100]|min]|max }}
    sequence:
      - service: light.turn_on
        target:
          entity_id:
            - light.front_porch_lights
            - light.light_garage_left
            - light.light_garage_center
            - light.light_garage_right
        data:
          brightness_pct: "{{ calc_pct }}"
          transition: 2
      - if:
          - condition: template
            value_template: "{{ has_value('light.permanent_outdoor_lights') }}"
        then:
          - service: light.turn_on
            target:
              entity_id: light.permanent_outdoor_lights
            data:
              brightness_pct: "{{ calc_pct }}"
              transition: 2
            continue_on_error: true
      - service: logbook.log
        data:
          name: Huskers Debug
          message: "Exterior brightness test â†’ {{ calc_pct }}% (cloud: {{ cloud_cover }}%)"

  huskers_debug_script_start:
    alias: '[Huskers Debug] Script start'
    mode: single
    variables:
      start_script: script.huskers_chase30_start
    sequence:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ has_value(start_script) }}"
            sequence:
              - service: script.turn_on
                target:
                  entity_id: "{{ start_script }}"
              - service: logbook.log
                data:
                  name: Huskers Debug
                  message: "Started script: {{ start_script }}"
        default:
          - service: logbook.log
            data:
              name: Huskers Debug
              message: "Script not found: {{ start_script }} (skipped)"

  huskers_debug_script_stop:
    alias: '[Huskers Debug] Script stop'
    mode: single
    variables:
      loops:
        - script.huskers_chase30_loop
        - script.huskers_chase_speed_loop
    sequence:
      - repeat:
          for_each: "{{ loops }}"
          sequence:
            - if:
                - condition: template
                  value_template: "{{ has_value(repeat.item) }}"
              then:
                - service: script.turn_off
                  target:
                    entity_id: "{{ repeat.item }}"
                - service: logbook.log
                  data:
                    name: Huskers Debug
                    message: "Stopped {{ repeat.item }}"
      - service: logbook.log
        data:
          name: Huskers Debug
          message: 'Loop-stop sweep completed'

  huskers_debug_theater_color_change:
    alias: '[Huskers Debug] Theater color change'
    mode: single
    variables:
      test_ct: 370
      test_ct_kelvin: "{{ (1000000 / test_ct) | round(0) | int }}"
      test_brightness: 60
    sequence:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ has_value('light.theater_lights') }}"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.theater_lights
                data:
                  brightness_pct: "{{ test_brightness }}"
                  color_temp_kelvin: "{{ test_ct_kelvin }}"
                  transition: 1
              - delay: '00:00:02'
              - service: light.turn_on
                target:
                  entity_id: light.theater_lights
                data:
                  brightness_pct: 30
                  color_temp_kelvin: 2203
                  transition: 1
              - service: logbook.log
                data:
                  name: Huskers Debug
                  message: 'Theater color debug complete'
        default:
          - service: logbook.log
            data:
              name: Huskers Debug
              message: 'Theater lights entity not found (skipped)'

################################################################################
# TEMPLATE SENSORS & ESPN PHASE FLAGS
################################################################################
template:
  - sensor:
      # Schedule (short state, full text in attribute to avoid 255-char limit)
      - name: huskers_schedule_combined
        unique_id: huskers_schedule_combined
        state: >-
          {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
          {% if events %}{{ events | length }} games scheduled{% else %}No schedule{% endif %}
        attributes:
          markdown: >-
            {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
            {% if events -%}
            ## Nebraska Schedule ({{ now().year }})

            {% set ns = namespace(lines=[]) -%}
            {% set score_unknown = ['?', None, '', 'unknown', 'unavailable'] -%}
            {%- for game in events %}
              {%- set comp = (game.competitions | default([])) | first %}
              {%- if not comp %}{%- continue %}{%- endif %}
              {%- set date = (game.date | as_datetime | as_local) if game.date is defined else none %}
              {%- set us_home = comp.competitors[0].team.id == '158' if (comp.competitors is defined and comp.competitors|length >= 2) else false %}
              {%- set opp = comp.competitors[1].team.displayName if us_home and comp.competitors|length >= 2 else (comp.competitors[0].team.displayName if comp.competitors|length >= 1 else 'TBD') %}
              {%- set loc = 'vs' if us_home else 'at' %}
              {%- set done = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {%- set home = (comp.competitors | selectattr('homeAway','equalto','home') | list | first) %}
              {%- set away = (comp.competitors | selectattr('homeAway','equalto','away') | list | first) %}
              {%- set h_score = (home.score.value if home and home.score is mapping and home.score.value is defined else (home.score if home and home.score is defined else '?')) %}
              {%- set a_score = (away.score.value if away and away.score is mapping and away.score.value is defined else (away.score if away and away.score is defined else '?')) %}
              {%- set date_ts = as_timestamp(date, default=None) if date else none %}
              {%- set date_text = date_ts | timestamp_custom('%b %-d, %-I:%M %p', True) if date_ts is not none else 'TBD' %}
              {%- set h_fmt = h_score if h_score in score_unknown else (h_score | float(0) | round(0) | int) %}
              {%- set a_fmt = a_score if a_score in score_unknown else (a_score | float(0) | round(0) | int) %}
              {%- if done %}
                {%- set line = '- **' ~ date_text ~ '** â€” ' ~ loc ~ ' ' ~ opp ~ ' â€” **Final** ' ~ h_fmt ~ '-' ~ a_fmt %}
              {%- else %}
                {%- set line = '- **' ~ date_text ~ '** â€” ' ~ loc ~ ' ' ~ opp %}
              {%- endif %}
              {%- set ns.lines = ns.lines + [line] %}
            {%- endfor %}
            {{ ns.lines | join('\n') }}
            {%- else %}
            **Schedule unavailable**
            {%- endif %}
      - name: huskers_next_game
        unique_id: huskers_next_game
        icon: mdi:calendar-clock
        state: >-
          {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
          {% set now_ts = now().timestamp() %}
          {% set next = namespace(game=None, comp=None, dt=None) %}
          {% for g in events %}
            {% set comp = (g.competitions | default([])) | first %}
            {% if not comp %}{% continue %}{% endif %}
            {% set dt = g.date | as_datetime %}
            {% if not dt %}{% continue %}{% endif %}
            {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
            {% if not completed and dt.timestamp() >= (now_ts - 21600) %}
              {% set next.game = g %}
              {% set next.comp = comp %}
              {% set next.dt = dt %}
              {% break %}
            {% endif %}
          {% endfor %}
          {% if next.dt %}
            {% set local = next.dt | as_local %}
            {% set local_ts = as_timestamp(local, default=None) %}
            {% set our_team = next.comp.competitors | selectattr('team.id','equalto','158') | list | first %}
            {% set opponent = next.comp.competitors | rejectattr('team.id','equalto','158') | list | first %}
            {% set is_home = our_team.homeAway == 'home' if our_team is defined and our_team.homeAway is defined else false %}
            {% set opp_name = opponent.team.displayName if opponent and opponent.team is defined else 'TBD' %}
            {{ local_ts | timestamp_custom('%b %-d, %Y %-I:%M %p %Z', True) if local_ts is not none else 'TBD' }} â€” {% if is_home %}vs{% else %}@{% endif %} {{ opp_name }}
          {% else %}No upcoming game{% endif %}
        attributes:
          date: >-
            {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next = namespace(dt=None) %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime %}
              {% if not dt %}{% continue %}{% endif %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if not completed and dt.timestamp() >= (now_ts - 21600) %}
                {% set next.dt = dt %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if next.dt %}
              {% set local = next.dt | as_local %}
              {% set local_ts = as_timestamp(local, default=None) %}
              {{ local_ts | timestamp_custom('%b %-d, %Y', True) if local_ts is not none else 'TBD' }}
            {% else %}No upcoming game{% endif %}
          time: >-
            {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next = namespace(dt=None) %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime %}
              {% if not dt %}{% continue %}{% endif %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if not completed and dt.timestamp() >= (now_ts - 21600) %}
                {% set next.dt = dt %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if next.dt %}
              {% set local = next.dt | as_local %}
              {% set local_ts = as_timestamp(local, default=None) %}
              {{ local_ts | timestamp_custom('%-I:%M %p %Z', True) if local_ts is not none else 'TBD' }}
            {% else %}No upcoming game{% endif %}
          location: >-
            {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next = namespace(comp=None) %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime %}
              {% if not dt %}{% continue %}{% endif %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if not completed and dt.timestamp() >= (now_ts - 21600) %}
                {% set next.comp = comp %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if next.comp %}
              {% set venue = next.comp.venue if next.comp.venue is defined else none %}
              {% set parts = [] %}
              {% if venue and venue.fullName is defined and venue.fullName %}
                {% set parts = parts + [venue.fullName] %}
              {% endif %}
              {% if venue and venue.address is defined %}
                {% set city = venue.address.city if venue.address.city is defined else '' %}
                {% set state = venue.address.state if venue.address.state is defined else '' %}
                {% set loc_parts = [] %}
                {% if city %}{% set loc_parts = loc_parts + [city] %}{% endif %}
                {% if state %}{% set loc_parts = loc_parts + [state] %}{% endif %}
                {% if loc_parts %}{% set parts = parts + [loc_parts | join(', ')] %}{% endif %}
              {% endif %}
              {% set base = parts | join(' â€“ ') if parts else 'TBD' %}
              {% set our_team = next.comp.competitors | selectattr('team.id','equalto','158') | list | first %}
              {% set descriptor = 'Home' if our_team and our_team.homeAway is defined and our_team.homeAway == 'home' else 'Away' %}
              {% if base != 'TBD' %}
                {{ base }} ({{ descriptor }})
              {% else %}TBD{% endif %}
            {% else %}No upcoming game{% endif %}
          opponent: >-
            {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next = namespace(comp=None) %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime %}
              {% if not dt %}{% continue %}{% endif %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if not completed and dt.timestamp() >= (now_ts - 21600) %}
                {% set next.comp = comp %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% if next.comp %}
              {% set opponent = next.comp.competitors | rejectattr('team.id','equalto','158') | list | first %}
              {% if opponent and opponent.team is defined %}
                {{ opponent.team.displayName }}
              {% else %}TBD{% endif %}
            {% else %}No upcoming game{% endif %}
      # Todayâ€™s game status (plus basic attributes)
      - name: huskers_game_status_espn
        unique_id: huskers_game_status_espn
        variables:
          game_payload: >-
            {% set scoreboard_events = state_attr('sensor.espn_cfb_scoreboard', 'events') or [] %}
            {% set game = namespace(comp=None, source='none') %}
            {% for ev in scoreboard_events %}
              {% set comp = (ev.competitions | default([])) | first %}
              {% if comp and comp.competitors is defined %}
                {% if comp.competitors | selectattr('team.id','equalto','158') | list | count > 0 %}
                  {% set game.comp = comp %}
                  {% set game.source = 'scoreboard' %}
                  {% break %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {% if game.comp is none %}
              {% set schedule_events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
              {% set now_ts = now().timestamp() %}
              {% set recent = namespace(comp=None, delta=999999) %}
              {% for item in schedule_events %}
                {% set comp = (item.competitions | default([])) | first %}
                {% if not comp or comp.competitors is not defined %}{% continue %}{% endif %}
                {% if comp.competitors | selectattr('team.id','equalto','158') | list | count == 0 %}{% continue %}{% endif %}
                {% set dt = item.date | as_datetime %}
                {% if not dt %}{% continue %}{% endif %}
                {% set ts = as_timestamp(dt, 0) %}
                {% if ts is none %}{% continue %}{% endif %}
                {% if ts > now_ts %}{% continue %}{% endif %}
                {% set delta = now_ts - ts %}
                {% if delta < recent.delta %}
                  {% set recent.comp = comp %}
                  {% set recent.delta = delta %}
                {% endif %}
              {% endfor %}
              {% if recent.comp and recent.delta <= 43200 %}
                {% set game.comp = recent.comp %}
                {% set game.source = 'schedule' %}
              {% endif %}
            {% endif %}

            {% set status = 'No game today' %}
            {% set home_team = '' %}
            {% set away_team = '' %}
            {% set home_score = 0 %}
            {% set away_score = 0 %}

            {% if game.comp %}
              {% set status_obj = game.comp.status if game.comp.status is defined else none %}
              {% set status_type = status_obj.type if status_obj is defined and status_obj.type is defined else none %}
              {% set description = status_type.description if status_type is defined and status_type.description is defined else none %}
              {% set completed = status_type.completed if status_type is defined and status_type.completed is defined else false %}
              {% if description %}
                {% set status = description %}
              {% elif completed %}
                {% set status = 'Final' %}
              {% else %}
                {% set status = 'Scheduled' %}
              {% endif %}

              {% set home = (game.comp.competitors | selectattr('homeAway','equalto','home') | list | first) %}
              {% set away = (game.comp.competitors | selectattr('homeAway','equalto','away') | list | first) %}

              {% if home %}
                {% if home.team is defined and home.team.displayName is defined %}
                  {% set home_team = home.team.displayName %}
                {% endif %}
                {% if home.score is defined %}
                  {% if home.score is mapping %}
                    {% set raw_home_score = home.score.value if home.score.value is defined else home.score.displayValue if home.score.displayValue is defined else 0 %}
                  {% else %}
                    {% set raw_home_score = home.score %}
                  {% endif %}
                  {% set home_score = (raw_home_score | int(0)) %}
                {% endif %}
              {% endif %}

              {% if away %}
                {% if away.team is defined and away.team.displayName is defined %}
                  {% set away_team = away.team.displayName %}
                {% endif %}
                {% if away.score is defined %}
                  {% if away.score is mapping %}
                    {% set raw_away_score = away.score.value if away.score.value is defined else away.score.displayValue if away.score.displayValue is defined else 0 %}
                  {% else %}
                    {% set raw_away_score = away.score %}
                  {% endif %}
                  {% set away_score = (raw_away_score | int(0)) %}
                {% endif %}
              {% endif %}
            {% endif %}

            {{ {
              'has_game': game.comp is not none,
              'source': game.source,
              'status': status,
              'home_team': home_team,
              'away_team': away_team,
              'home_score': home_score | int(0),
              'away_score': away_score | int(0)
            } | tojson }}
        state: >-
          {% set game = game_payload | from_json %}
          {{ game.status }}
        attributes:
          status_source: >-
            {% set game = game_payload | from_json %}
            {{ game.source if game.has_game else 'none' }}
          home_team: >-
            {% set game = game_payload | from_json %}
            {{ game.home_team if game.has_game else '' }}
          away_team: >-
            {% set game = game_payload | from_json %}
            {{ game.away_team if game.has_game else '' }}
          home_score: >-
            {% set game = game_payload | from_json %}
            {{ game.home_score if game.has_game else 0 }}
          away_score: >-
            {% set game = game_payload | from_json %}
            {{ game.away_score if game.has_game else 0 }}

      # Nebraska record
      - name: huskers_record
        unique_id: huskers_record
        state: >-
          {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
          {% set w = 0 %}
          {% set l = 0 %}
          {% for game in events %}
            {% set comp = (game.competitions | default([])) | first %}
            {% if not comp or not (comp.status is defined and comp.status.type is defined and comp.status.type.completed) %}
              {% continue %}
            {% endif %}
            {% set huskers = comp.competitors | selectattr('team.id','equalto','158') | list | first %}
            {% set opp = comp.competitors | rejectattr('team.id','equalto','158') | list | first %}
            {% if huskers and opp and huskers.score is defined and opp.score is defined %}
              {% set huskers_score = huskers.score.value if huskers.score is defined and huskers.score is not none and huskers.score.value is defined else huskers.score %}
              {% set opp_score = opp.score.value if opp.score is defined and opp.score is not none and opp.score.value is defined else opp.score %}
              {% if (huskers_score | int(0)) > (opp_score | int(0)) %}
                {% set w = w + 1 %}
              {% else %}
                {% set l = l + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ w }}-{{ l }}

      - name: huskers_record_dashboard
        unique_id: huskers_record_dashboard
        icon: mdi:trophy-variant
        state: >-
          {% set a = states('sensor.huskers_record') %}
          {% if a not in ['unknown','unavailable','None',''] %}{{ a }}{% else %}N/A{% endif %}

      # Time to next kickoff (minutes) â€” always numeric
      - name: huskers_kickoff_in_2
        unique_id: huskers_kickoff_in_2
        unit_of_measurement: min
        icon: mdi:timer
        state: >-
          {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
          {% set now_ts = now().timestamp() %}
          {% set next_dt = none %}
          {% for g in events %}
            {% set comp = (g.competitions | default([])) | first %}
            {% if not comp %}{% continue %}{% endif %}
            {% set dt = g.date | as_datetime %}
            {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
            {% if dt and not completed and dt.timestamp() > now_ts %}
              {% set next_dt = dt %}
              {% break %}
            {% endif %}
          {% endfor %}
          {% if next_dt %}
            {{ max(0, ((next_dt - now()).total_seconds() / 60) | round(0) | int) }}
          {% else %}
            0
          {% endif %}
        attributes:
          kickoff_iso: >-
            {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next_dt = none %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if dt and not completed and dt.timestamp() > now_ts %}
                {% set next_dt = dt %}
                {% break %}
              {% endif %}
            {% endfor %}
            {{ next_dt.isoformat() if next_dt else '' }}
          has_next_game: >-
            {% set events = state_attr('sensor.espn_nebraska_schedule', 'events') or [] %}
            {% set now_ts = now().timestamp() %}
            {% set next_dt = none %}
            {% for g in events %}
              {% set comp = (g.competitions | default([])) | first %}
              {% if not comp %}{% continue %}{% endif %}
              {% set dt = g.date | as_datetime %}
              {% set completed = comp.status.type.completed if (comp.status is defined and comp.status.type is defined) else false %}
              {% if dt and not completed and dt.timestamp() > now_ts %}
                {% set next_dt = dt %}
                {% break %}
              {% endif %}
            {% endfor %}
            {{ (next_dt is not none) | bool }}

      # Our score (auto) from scoreboard
      - name: huskers_our_score_auto
        unique_id: huskers_our_score_auto
        state: >-
          {% set events = state_attr('sensor.espn_cfb_scoreboard', 'events') or [] %}
          {% set score = none %}
          {% for e in events %}
            {% set comp = (e.competitions | default([])) | first %}
            {% if comp and comp.competitors is defined %}
              {% for c in comp.competitors %}
                {% if c.team is defined and c.team.id == '158' %}
                  {% set score = c.score if c.score is defined else 0 %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {{ (score | int(0)) if score is not none else 0 }}

      # Opponent score (auto) from scoreboard
      - name: huskers_opponent_score_auto
        unique_id: huskers_opponent_score_auto
        state: >-
          {% set events = state_attr('sensor.espn_cfb_scoreboard', 'events') or [] %}
          {% set score = none %}
          {% for e in events %}
            {% set comp = (e.competitions | default([])) | first %}
            {% if comp and comp.competitors is defined %}
              {% for c in comp.competitors %}
                {% if c.team is defined and c.team.id != '158' %}
                  {% set score = c.score if c.score is defined else 0 %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {{ (score | int(0)) if score is not none else 0 }}

      # Effective score (manual override aware)
      - name: huskers_our_score_effective
        unique_id: huskers_our_score_effective
        state: >-
          {% if is_state('input_boolean.huskers_use_manual_score','on') %}
            {{ states('input_number.huskers_our_score_manual') | int(0) }}
          {% elif is_state('input_boolean.huskers_use_score_delay','on') %}
            {{ states('input_number.huskers_our_score_manual') | int(0) }}
          {% else %}
            {{ states('sensor.huskers_our_score_auto') | int(0) }}
          {% endif %}

      # Opponent score (manual override & delay aware)
      - name: huskers_opponent_score_effective
        unique_id: huskers_opponent_score_effective
        state: >-
          {% if is_state('input_boolean.huskers_use_manual_score','on') %}
            {{ states('input_number.huskers_opponent_score_manual') | int(0) }}
          {% elif is_state('input_boolean.huskers_use_score_delay','on') %}
            {{ states('input_number.huskers_opponent_score_manual') | int(0) }}
          {% else %}
            {{ states('sensor.huskers_opponent_score_auto') | int(0) }}
          {% endif %}

      # Kickoff minutes (auto) routed from huskers_kickoff_in_2
      - name: huskers_kickoff_in_auto
        unique_id: huskers_kickoff_in_auto
        unit_of_measurement: min
        state: "{{ states('sensor.huskers_kickoff_in_2') | int(0) }}"
        availability: "{{ states('sensor.huskers_kickoff_in_2') not in ['unknown', 'unavailable'] }}"

      # Effective kickoff minutes (manual override aware)
      - name: huskers_kickoff_in_effective
        unique_id: huskers_kickoff_in_effective
        unit_of_measurement: min
        state: >-
          {% if is_state('input_boolean.huskers_use_manual_kickoff','on') %}
            {{ states('input_number.huskers_kickoff_in_manual') | int(0) }}
          {% else %}
            {{ states('sensor.huskers_kickoff_in_auto') | int(0) }}
          {% endif %}

      # Game quarter (delay aware)
      - name: huskers_quarter_effective
        unique_id: huskers_quarter_effective
        state: >-
          {% set live = state_attr('sensor.husker_team','quarter') %}
          {% set sanitized = live if live not in [None, '', 'unknown', 'unavailable'] else '' %}
          {% if is_state('input_boolean.huskers_use_score_delay','on') %}
            {{ states('input_text.huskers_quarter_manual') if states('input_text.huskers_quarter_manual') not in ['unknown','unavailable', None] else sanitized }}
          {% else %}
            {{ sanitized }}
          {% endif %}

      # Game clock (delay aware)
      - name: huskers_game_clock_effective
        unique_id: huskers_game_clock_effective
        state: >-
          {% set live = state_attr('sensor.husker_team','clock') %}
          {% set sanitized = live if live not in [None, '', 'unknown', 'unavailable'] else '--:--' %}
          {% if is_state('input_boolean.huskers_use_score_delay','on') %}
            {{ states('input_text.huskers_game_clock_manual') if states('input_text.huskers_game_clock_manual') not in ['unknown','unavailable', None, ''] else sanitized }}
          {% else %}
            {{ sanitized }}
          {% endif %}

      # AP ranking
      - name: huskers_ap_ranking_espn
        unique_id: huskers_ap_ranking_espn
        state: >-
          {% set rankings = state_attr('sensor.espn_cfb_rankings', 'rankings') or [] %}
          {% set rank = 'Unranked' %}
          {% for poll in rankings %}
            {% if poll.name == 'AP Top 25' and poll.ranks is defined %}
              {% for team in poll.ranks %}
                {% if team.team is defined and team.team.id == '158' %}
                  {% set rank = '#' ~ team.current %}
                  {% break %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {{ rank }}

      # Big Ten standings (short state + markdown attribute)
      - name: big_ten_standings_espn
        unique_id: big_ten_standings_espn
        icon: mdi:trophy
        state: >-
          {% set standings = state_attr('sensor.espn_big_ten_teams', 'standings') or [] %}
          {% if standings %}
            {{ standings | length }} teams
          {% else %}
            unavailable
          {% endif %}
        attributes:
          markdown: >-
            {% set standings = state_attr('sensor.espn_big_ten_teams', 'standings') or [] %}
            {% set season_meta = state_attr('sensor.espn_nebraska_schedule', 'requestedSeason') %}
            {% if season_meta is mapping and 'year' in season_meta %}
              {% set season_year = season_meta['year'] %}
            {% else %}
              {% set season_year = now().year %}
            {% endif %}
            {% if now().month < 6 %}
              {% set season_year = season_year - 1 %}
            {% endif %}
            {% set team_names = {
              '2483': 'Oregon Ducks',
              '84': 'Indiana Hoosiers',
              '213': 'Penn State Nittany Lions',
              '194': 'Ohio State Buckeyes',
              '356': 'Illinois Fighting Illini',
              '2294': 'Iowa Hawkeyes',
              '130': 'Michigan Wolverines',
              '135': 'Minnesota Golden Gophers',
              '164': 'Rutgers Scarlet Knights',
              '264': 'Washington Huskies',
              '30': 'USC Trojans',
              '158': 'Nebraska Cornhuskers',
              '26': 'UCLA Bruins',
              '127': 'Michigan State Spartans',
              '275': 'Wisconsin Badgers',
              '77': 'Northwestern Wildcats',
              '120': 'Maryland Terrapins',
              '2509': 'Purdue Boilermakers'
            } %}
            {% if standings %}
              {% set ns = namespace(rows=[]) %}
              {%- for entry in standings %}
                {% set team_ref = entry.team['$ref'] if entry.team is mapping and '$ref' in entry.team else '' %}
                {% set team_href = team_ref.split('?')[0] if team_ref else '' %}
                {% set team_id = team_href.rsplit('/', 1)[-1] if team_href else '' %}
                {% set overall_record = (entry.records | selectattr('name','equalto','overall') | list | first) if entry.records is defined else none %}
                {% set conf_record = (entry.records | selectattr('name','equalto','vs. Conf.') | list | first) if entry.records is defined else none %}
                {% set overall_text = '-' %}
                {% if overall_record is mapping %}
                  {% if overall_record.summary is defined %}
                    {% set overall_text = overall_record.summary %}
                  {% elif overall_record.displayValue is defined %}
                    {% set overall_text = overall_record.displayValue %}
                  {% endif %}
                {% endif %}
                {% set conf_text = '-' %}
                {% if conf_record is mapping %}
                  {% if conf_record.summary is defined %}
                    {% set conf_text = conf_record.summary %}
                  {% elif conf_record.displayValue is defined %}
                    {% set conf_text = conf_record.displayValue %}
                  {% endif %}
                {% endif %}
                {% set parts = overall_text.split('-') if overall_text not in ['-', ''] else [] %}
                {% set wins = parts[0] | int(0) if parts | length > 0 else 0 %}
                {% set losses = parts[1] | int(0) if parts | length > 1 else 0 %}
                {% set ns.rows = ns.rows + [{
                  'team': team_names.get(team_id, 'Team ' ~ team_id),
                  'overall': overall_text,
                  'conf': conf_text,
                  'wins': wins,
                  'losses': losses
                }] %}
              {%- endfor %}
              {% set rows = ns.rows | sort(attribute='losses') | sort(attribute='wins', reverse=True) %}
              ## Big Ten Standings ({{ season_year }})
              | Rank | Team | Overall | Conf |
              | --- | --- | --- | --- |
              {%- for row in rows %}
              | {{ loop.index }} | {{ row.team }} | {{ row.overall }} | {{ row.conf }} |
              {%- endfor %}
            {% else %}
              Big Ten standings unavailable
            {% endif %}

  - trigger:
      - platform: homeassistant
        event: start
      - platform: event
        event_type: automation_reloaded
      - platform: time_pattern
        minutes: '/5'
    sensor:
      - name: huskers_automation_status_audit
        unique_id: huskers_automation_status_audit
        icon: mdi:playlist-check
        variables:
          automation_matrix: >-
            {{ [
              {
                "entity_id": "automation.huskers_game_mode_enable_window",
                "expected_mode": "single",
                "triggers": [
                  "sensor.huskers_kickoff_in_effective",
                  "sensor.huskers_kickoff_in_2",
                  "binary_sensor.huskers_is_pregame_espn",
                  "binary_sensor.huskers_is_live_espn",
                  "input_boolean.huskers_automations_enabled",
                  "input_boolean.huskers_game_mode",
                  "input_boolean.huskers_use_manual_kickoff"
                ]
              },
              {
                "entity_id": "automation.huskers_game_mode_disable_window",
                "expected_mode": "single",
                "triggers": [
                  "sensor.huskers_kickoff_in_effective",
                  "binary_sensor.huskers_is_pregame_espn",
                  "binary_sensor.huskers_is_live_espn",
                  "binary_sensor.huskers_is_postgame_espn",
                  "input_boolean.huskers_game_mode"
                ]
              },
              {
                "entity_id": "automation.huskers_showtime_at_t_20",
                "expected_mode": "single",
                "triggers": [
                  "sensor.huskers_kickoff_in_effective",
                  "binary_sensor.huskers_is_pregame_espn",
                  "input_boolean.huskers_automations_enabled",
                  "input_boolean.huskers_game_mode",
                  "input_boolean.huskers_test_mode",
                  "script.huskers_chase30_loop",
                  "script.huskers_chase_speed_loop"
                ]
              },
              {
                "entity_id": "automation.huskers_td_burst_on_score",
                "expected_mode": "single",
                "triggers": [
                  "sensor.huskers_our_score_effective",
                  "input_boolean.huskers_automations_enabled",
                  "input_boolean.huskers_game_mode"
                ]
              },
              {
                "entity_id": "automation.huskers_postgame_cleanup",
                "expected_mode": "single",
                "triggers": [
                  "binary_sensor.huskers_is_postgame_espn",
                  "input_boolean.huskers_game_mode",
                  "binary_sensor.huskers_light_show_active",
                  "script.huskers_chase30_loop",
                  "script.huskers_chase_speed_loop"
                ]
              }
            ] | to_json }}
        state: >-
          {% set matrix = automation_matrix | from_json %}
          {% set disabled = [] %}
          {% set mode_mismatches = [] %}
          {% for entry in matrix %}
            {% if not is_state(entry.entity_id, 'on') %}
              {% set disabled = disabled + [entry.entity_id] %}
            {% endif %}
            {% set actual_mode = state_attr(entry.entity_id, 'mode') %}
            {% if entry.expected_mode and actual_mode != entry.expected_mode %}
              {% set mode_mismatches = mode_mismatches + [entry.entity_id ~ ' (expected ' ~ entry.expected_mode ~ ', actual ' ~ (actual_mode or 'unknown') ~ ')'] %}
            {% endif %}
          {% endfor %}
          {% if disabled or mode_mismatches %}
            issues
          {% else %}
            ok
          {% endif %}
        attributes:
          checked_at: '{{ now().isoformat() }}'
          disabled: >-
            {% set matrix = automation_matrix | from_json %}
            {% set disabled = [] %}
            {% for entry in matrix %}
              {% if not is_state(entry.entity_id, 'on') %}
                {% set disabled = disabled + [entry.entity_id] %}
              {% endif %}
            {% endfor %}
            {{ disabled | to_json }}
          mode_mismatches: >-
            {% set matrix = automation_matrix | from_json %}
            {% set mismatches = [] %}
            {% for entry in matrix %}
              {% set actual_mode = state_attr(entry.entity_id, 'mode') %}
              {% if entry.expected_mode and actual_mode != entry.expected_mode %}
                {% set mismatches = mismatches + [{
                  'entity_id': entry.entity_id,
                  'expected': entry.expected_mode,
                  'actual': actual_mode or 'unknown'
                }] %}
              {% endif %}
            {% endfor %}
            {{ mismatches | to_json }}
          issues_summary: >-
            {% set matrix = automation_matrix | from_json %}
            {% set disabled = [] %}
            {% set mismatches = [] %}
            {% for entry in matrix %}
              {% if not is_state(entry.entity_id, 'on') %}
                {% set disabled = disabled + [entry.entity_id] %}
              {% endif %}
              {% set actual_mode = state_attr(entry.entity_id, 'mode') %}
              {% if entry.expected_mode and actual_mode != entry.expected_mode %}
                {% set mismatches = mismatches + [entry.entity_id ~ ' (expected ' ~ entry.expected_mode ~ ', actual ' ~ (actual_mode or 'unknown') ~ ')'] %}
              {% endif %}
            {% endfor %}
            {% set parts = [] %}
            {% if disabled %}
              {% set parts = parts + ['Disabled: ' ~ disabled | join(', ')] %}
            {% endif %}
            {% if mismatches %}
              {% set parts = parts + ['Mode mismatch: ' ~ mismatches | join('; ')] %}
            {% endif %}
            {{ parts | join(' â€” ') if parts else 'All automations enabled with expected modes' }}
          automations: >-
            {% set matrix = automation_matrix | from_json %}
            {% set snapshots = [] %}
            {% for entry in matrix %}
              {% set trigger_states = [] %}
              {% for trig in entry.triggers %}
                {% set trigger_states = trigger_states + [{
                  'entity_id': trig,
                  'state': states(trig)
                }] %}
              {% endfor %}
              {% set snapshots = snapshots + [{
                'entity_id': entry.entity_id,
                'state': states(entry.entity_id),
                'expected_mode': entry.expected_mode,
                'mode': state_attr(entry.entity_id, 'mode'),
                'last_triggered': state_attr(entry.entity_id, 'last_triggered'),
                'current_runs': state_attr(entry.entity_id, 'current'),
                'triggers': trigger_states
              }] %}
            {% endfor %}
            {{ snapshots | to_json }}
  - binary_sensor:
      - name: huskers_is_pregame_espn
        unique_id: huskers_is_pregame_espn
        state: >-
          {% set status = states('sensor.huskers_game_status_espn') %}
          {{ status in ['Pre-Game', 'Postponed', 'Delayed', 'Warmup'] }}

      - name: huskers_is_live_espn
        unique_id: huskers_is_live_espn
        state: >-
          {% set status = states('sensor.huskers_game_status_espn') %}
          {% set normalized = (status | string).lower() %}
          {% set keywords = [
            'in progress',
            'quarter',
            'halftime',
            'overtime',
            'end period',
            'endperiod',
            'end of',
            'suspended'
          ] %}
          {% set is_live = false %}
          {% if status not in [None, '', 'unknown', 'unavailable'] %}
            {% for marker in keywords %}
              {% if marker in normalized %}
                {% set is_live = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {{ is_live }}

      - name: huskers_is_postgame_espn
        unique_id: huskers_is_postgame_espn
        state: >-
          {% set status = states('sensor.huskers_game_status_espn') %}
          {{ status in ['Final', 'Final/OT'] }}

      - name: huskers_light_show_active
        unique_id: huskers_light_show_active
        device_class: running
        state: >-
          {{ is_state('script.huskers_chase30_loop','on')
             or is_state('script.huskers_chase_speed_loop','on')
             or is_state('script.huskers_hail_burst_8s','on') }}

      - name: huskers_lighting_hold
        unique_id: huskers_lighting_hold
        state: >-
          {% set auto_enabled = is_state('input_boolean.huskers_automations_enabled','on') %}
          {% set game_mode = is_state('input_boolean.huskers_game_mode','on') %}
          {% set manual_kick = is_state('input_boolean.huskers_use_manual_kickoff','on') %}
          {% set has_next = state_attr('sensor.huskers_kickoff_in_2','has_next_game') | default(false) %}
          {% set minutes = states('sensor.huskers_kickoff_in_effective') | float(999) %}
          {% set pre_window = (manual_kick or has_next) and minutes >= 0 and minutes <= 20 %}
          {% set live = is_state('binary_sensor.huskers_is_live_espn','on') %}
          {% set show_active = is_state('binary_sensor.huskers_light_show_active','on') %}
          {% set manual_show = is_state('input_boolean.huskers_color_show','on') %}
          {{ auto_enabled and game_mode and (
            show_active
            or manual_show
          ) }}

################################################################################
# AUTOMATIONS
################################################################################
automation:
  - id: huskers_score_delay_buffer
    alias: 'Huskers: Scoreboard Delay Buffer'
    description: 'Copies TeamTracker scoreboard values into manual helpers after a 30-second buffer when enabled.'
    mode: parallel
    max: 120
    trigger:
      - platform: state
        entity_id: sensor.husker_team
        attribute: team_score
      - platform: state
        entity_id: sensor.husker_team
        attribute: opponent_score
      - platform: state
        entity_id: sensor.husker_team
        attribute: clock
      - platform: state
        entity_id: sensor.husker_team
        attribute: quarter
      - platform: state
        entity_id:
          - sensor.huskers_our_score_auto
          - sensor.huskers_opponent_score_auto
    condition:
      - condition: state
        entity_id: input_boolean.huskers_use_score_delay
        state: 'on'
      - condition: template
        value_template: >-
          {{
            states('sensor.husker_team') not in ['unknown', 'unavailable']
            or states('sensor.huskers_our_score_auto') not in ['unknown', 'unavailable']
            or states('sensor.huskers_opponent_score_auto') not in ['unknown', 'unavailable']
          }}
    action:
      - variables:
          tt_available: "{{ states('sensor.husker_team') not in ['unknown', 'unavailable'] }}"
          team_score: >-
            {% if tt_available %}
              {{ state_attr('sensor.husker_team','team_score') | int(0) }}
            {% else %}
              {{ states('sensor.huskers_our_score_auto') | int(0) }}
            {% endif %}
          opponent_score: >-
            {% if tt_available %}
              {{ state_attr('sensor.husker_team','opponent_score') | int(0) }}
            {% else %}
              {{ states('sensor.huskers_opponent_score_auto') | int(0) }}
            {% endif %}
          quarter: >-
            {% if tt_available %}
              {% set raw = state_attr('sensor.husker_team','quarter') %}
            {% else %}
              {% set raw = states('sensor.huskers_quarter_effective') %}
            {% endif %}
            {{ raw if raw not in [None, '', 'unknown', 'unavailable'] else '' }}
          clock: >-
            {% if tt_available %}
              {% set raw = state_attr('sensor.husker_team','clock') %}
            {% else %}
              {% set raw = states('sensor.huskers_game_clock_effective') %}
            {% endif %}
            {{ raw if raw not in [None, '', 'unknown', 'unavailable'] else '--:--' }}
      - delay: '00:00:30'
      - condition: state
        entity_id: input_boolean.huskers_use_score_delay
        state: 'on'
      - service: input_number.set_value
        target:
          entity_id: input_number.huskers_our_score_manual
        data:
          value: "{{ team_score }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.huskers_opponent_score_manual
        data:
          value: "{{ opponent_score }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.huskers_quarter_manual
        data:
          value: "{{ quarter }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.huskers_game_clock_manual
        data:
          value: "{{ clock }}"

  - id: huskers_score_delay_sync
    alias: 'Huskers: Score Delay Helper Sync'
    description: 'Keeps manual score helpers aligned with live TeamTracker data on startup or when toggling the delay.'
    mode: queued
    trigger:
      - platform: homeassistant
        event: start
      - platform: state
        entity_id: input_boolean.huskers_use_score_delay
    condition:
      - condition: template
        value_template: >-
          {{
            states('sensor.husker_team') not in ['unknown', 'unavailable']
            or states('sensor.huskers_our_score_auto') not in ['unknown', 'unavailable']
            or states('sensor.huskers_opponent_score_auto') not in ['unknown', 'unavailable']
          }}
    action:
      - variables:
          tt_available: "{{ states('sensor.husker_team') not in ['unknown', 'unavailable'] }}"
          team_score: >-
            {% if tt_available %}
              {{ state_attr('sensor.husker_team','team_score') | int(0) }}
            {% else %}
              {{ states('sensor.huskers_our_score_auto') | int(0) }}
            {% endif %}
          opponent_score: >-
            {% if tt_available %}
              {{ state_attr('sensor.husker_team','opponent_score') | int(0) }}
            {% else %}
              {{ states('sensor.huskers_opponent_score_auto') | int(0) }}
            {% endif %}
          quarter: >-
            {% if tt_available %}
              {% set raw = state_attr('sensor.husker_team','quarter') %}
            {% else %}
              {% set raw = states('sensor.huskers_quarter_effective') %}
            {% endif %}
            {{ raw if raw not in [None, '', 'unknown', 'unavailable'] else '' }}
          clock: >-
            {% if tt_available %}
              {% set raw = state_attr('sensor.husker_team','clock') %}
            {% else %}
              {% set raw = states('sensor.huskers_game_clock_effective') %}
            {% endif %}
            {{ raw if raw not in [None, '', 'unknown', 'unavailable'] else '--:--' }}
      - service: input_number.set_value
        target:
          entity_id: input_number.huskers_our_score_manual
        data:
          value: "{{ team_score }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.huskers_opponent_score_manual
        data:
          value: "{{ opponent_score }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.huskers_quarter_manual
        data:
          value: "{{ quarter }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.huskers_game_clock_manual
        data:
          value: "{{ clock }}"

  - id: huskers_game_window_chase_loop
    alias: 'Huskers: Game Window Chase Keeper'
    description: 'Keeps the 45-second chase script running throughout the game window whenever no other shows are active.'
    mode: single
    trigger:
      - platform: state
        entity_id: input_boolean.huskers_game_mode
        to: 'on'
      - platform: state
        entity_id:
          - binary_sensor.huskers_is_pregame_espn
          - binary_sensor.huskers_is_live_espn
        to: 'on'
      - platform: state
        entity_id: script.huskers_chase30_loop
        to: 'off'
      - platform: time_pattern
        minutes: '/5'
    condition:
      - condition: state
        entity_id: input_boolean.huskers_automations_enabled
        state: 'on'
      - condition: state
        entity_id: input_boolean.huskers_game_mode
        state: 'on'
      - condition: state
        entity_id: binary_sensor.huskers_lighting_hold
        state: 'off'
    action:
      - condition: state
        entity_id: script.huskers_chase30_loop
        state: 'off'
      - service: script.turn_on
        target:
          entity_id: script.huskers_chase30_start

  - id: huskers_showtime_at_t_20
    alias: 'Huskers: Pregame Showtime (T-20 Minutes)'
    description: 'Starts the 30s cream chase ~20 minutes before kickoff.'
    initial_state: true
    mode: single
    trigger:
      - id: countdown_window
        platform: numeric_state
        entity_id: sensor.huskers_kickoff_in_effective
        above: 19
        below: 21
        for:
          seconds: 5
      - id: safety_poll
        platform: time_pattern
        minutes: '/1'
    condition:
      - condition: state
        entity_id: input_boolean.huskers_automations_enabled
        state: 'on'
      - condition: state
        entity_id: input_boolean.huskers_game_mode
        state: 'on'
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.huskers_is_pregame_espn
            state: 'on'
          - condition: state
            entity_id: input_boolean.huskers_test_mode
            state: 'on'
      - condition: state
        entity_id: script.huskers_chase30_loop
        state: 'off'
      - condition: state
        entity_id: script.huskers_chase_speed_loop
        state: 'off'
      - condition: template
        value_template: >-
          {% if trigger is defined and trigger.id == 'safety_poll' %}
            {% set minutes = states('sensor.huskers_kickoff_in_effective') | float(99) %}
            {{ 0 <= minutes <= 25 }}
          {% else %}
            true
          {% endif %}
    action:
      - service: script.turn_on
        target:
          entity_id: script.huskers_chase30_start
      - service: logbook.log
        data:
          name: Huskers Automation
          message: "Pregame show started (T-{{ states('sensor.huskers_kickoff_in_effective') }} min)"

  - id: huskers_td_burst_on_score
    alias: 'Huskers: Touchdown Celebration'
    description: 'Fires Hail Varsity BPM burst when Nebraska score increases.'
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.huskers_our_score_effective
    condition:
      - condition: state
        entity_id: input_boolean.huskers_automations_enabled
        state: 'on'
      - condition: state
        entity_id: input_boolean.huskers_game_mode
        state: 'on'
      - condition: template
        value_template: >-
          {{ trigger.from_state is not none and
             trigger.to_state is not none and
             (trigger.to_state.state | int(0)) > (trigger.from_state.state | int(0)) }}
    action:
      - service: script.turn_on
        target:
          entity_id: script.huskers_hail_burst_8s
      - service: logbook.log
        data:
          name: Huskers Celebration
          message: 'Score: {{ trigger.from_state.state }} â†’ {{ trigger.to_state.state }} (Hail burst)'
          entity_id: automation.huskers_td_burst_on_score

  - id: huskers_postgame_cleanup
    alias: 'Huskers: Postgame Cleanup'
    description: 'Stops chase loops and restores lights when postgame window closes.'
    initial_state: true
    mode: single
    trigger:
      - id: postgame_closed
        platform: state
        entity_id: binary_sensor.huskers_is_postgame_espn
        from: 'on'
        to: 'off'
      - id: postgame_unavailable
        platform: state
        entity_id: binary_sensor.huskers_is_postgame_espn
        from: 'on'
        to: 'unavailable'
      - id: postgame_unknown
        platform: state
        entity_id: binary_sensor.huskers_is_postgame_espn
        from: 'on'
        to: 'unknown'
      - id: game_mode_disabled
        platform: state
        entity_id: input_boolean.huskers_game_mode
        from: 'on'
        to: 'off'
      - id: chase_timeout
        platform: time_pattern
        minutes: '/5'
    condition:
      - condition: template
        value_template: >-
          {% if trigger is not defined %}
            true
          {% elif trigger.id in ['postgame_closed', 'postgame_unavailable', 'postgame_unknown'] %}
            {{ is_state('input_boolean.huskers_game_mode', 'on') }}
          {% elif trigger.id == 'game_mode_disabled' %}
            true
          {% elif trigger.id == 'chase_timeout' %}
            {% set now_ts = as_timestamp(now()) %}
            {% set threshold = 900 %}
            {% set chase30_last = as_timestamp(state_attr('script.huskers_chase30_loop', 'last_triggered')) %}
            {% set chase_speed_last = as_timestamp(state_attr('script.huskers_chase_speed_loop', 'last_triggered')) %}
            {% set chase30_expired = is_state('script.huskers_chase30_loop', 'on')
              and chase30_last is not none
              and (now_ts - chase30_last) > threshold %}
            {% set chase_speed_expired = is_state('script.huskers_chase_speed_loop', 'on')
              and chase_speed_last is not none
              and (now_ts - chase_speed_last) > threshold %}
            {{ chase30_expired or chase_speed_expired }}
          {% else %}
            true
          {% endif %}
    action:
      - variables:
          cleanup_required: "{{ is_state('binary_sensor.huskers_light_show_active', 'on') }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ cleanup_required }}"
            sequence:
              - parallel:
                  - service: script.turn_on
                    target:
                      entity_id: script.huskers_chase30_stop
                  - service: script.turn_on
                    target:
                      entity_id: script.huskers_chase_speed_stop
        default:
          - service: scene.turn_on
            target:
              entity_id:
                - scene.huskers_before_chase
                - scene.huskers_before_burst
            continue_on_error: true
      - service: logbook.log
        data:
          name: Huskers Automation
          message: >-
            {% if cleanup_required %}
              Postgame cleanup completed (loops stopped, state restored)
            {% else %}
              Postgame cleanup restored snapshots (no active Husker light show)
            {% endif %}
          entity_id: automation.huskers_postgame_cleanup

  - id: huskers_automation_watchdog_alert
    alias: 'Huskers: Automation Watchdog Alert'
    description: 'Logs when the five-minute audit detects disabled automations or unexpected modes.'
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.huskers_automation_status_audit
        to: 'issues'
    action:
      - service: logbook.log
        data:
          name: Huskers Automation Watchdog
          message: >-
            {{ state_attr('sensor.huskers_automation_status_audit', 'issues_summary') }}
          entity_id: sensor.huskers_automation_status_audit

# packages/huskers_everything.yaml
# â€¦your existing content aboveâ€¦

frontend:
  themes:
    Huskers Cream:
      modes:
        light:
          # Brand palette exported as custom properties for dashboard styling
          --huskers-cream: "#FDF3E7"
          --huskers-scarlet: "#E41C38"
          --huskers-black: "#0B0B0B"
          --huskers-ink: "#111111"
          --huskers-muted: "#5C5C5C"
          --huskers-shadow-primary: "rgba(228, 28, 56, 0.45)"
          --huskers-shadow-secondary: "rgba(13, 13, 13, 0.18)"
          --ha-theme-color-scarlet: "#E41C38"
          --ha-theme-color-cream: "#FDF3E7"
          --ha-theme-color-dark: "#111111"
          --ha-theme-color-gray: "#4C4C4C"

          # Base application surfaces
          primary-background-color: var(--ha-theme-color-cream)
          secondary-background-color: "#FFF8EC"
          card-background-color: "#FFFAF1"
          paper-card-background-color: "#FFFAF1"
          app-header-background-color: var(--huskers-black)
          app-header-text-color: var(--ha-theme-color-cream)
          app-header-icon-color: var(--ha-theme-color-cream)
          app-header-button-text-color: var(--ha-theme-color-cream)
          header-icon-color: var(--ha-theme-color-cream)
          sidebar-background-color: var(--ha-theme-color-cream)
          sidebar-icon-color: var(--ha-theme-color-dark)
          sidebar-text-color: var(--ha-theme-color-dark)
          sidebar-selected-icon-color: var(--ha-theme-color-scarlet)
          sidebar-selected-text-color: var(--ha-theme-color-scarlet)
          divider-color: "rgba(17, 17, 17, 0.1)"

          # Typography & state colors
          primary-text-color: var(--ha-theme-color-dark)
          secondary-text-color: var(--ha-theme-color-gray)
          text-primary-color: var(--ha-theme-color-dark)
          disabled-text-color: "rgba(17, 17, 17, 0.4)"
          state-unavailable-color: "#9B9B9B"

          # Emphasis and accent colours
          primary-color: var(--huskers-black)
          light-primary-color: "#2F2F2F"
          accent-color: var(--huskers-black)
          state-icon-color: var(--huskers-black)
          state-icon-active-color: var(--ha-theme-color-scarlet)
          paper-item-icon-color: var(--huskers-black)
          paper-item-icon-active-color: var(--ha-theme-color-scarlet)

          # Buttons, controls, and MWC theme values
          switch-checked-color: var(--huskers-black)
          switch-unchecked-color: "rgba(17, 17, 17, 0.3)"
          switch-checked-button-color: var(--ha-theme-color-cream)
          switch-unchecked-button-color: var(--ha-theme-color-cream)
          slider-color: var(--huskers-black)
          slider-secondary-color: "rgba(228, 28, 56, 0.25)"
          mdc-theme-primary: var(--huskers-black)
          mdc-theme-secondary: var(--ha-theme-color-scarlet)
          mdc-theme-on-primary: var(--ha-theme-color-cream)
          mdc-theme-on-secondary: var(--ha-theme-color-cream)
          mdc-theme-surface: var(--card-background-color)
          mdc-theme-on-surface: var(--primary-text-color)

          # Cards, layout polish, and gradient shadows
          ha-card-border-radius: "16px"
          ha-card-border-color: "rgba(0, 0, 0, 0.08)"
          ha-card-box-shadow: "0 26px 44px -24px var(--huskers-shadow-primary), 0 18px 28px -22px var(--huskers-shadow-secondary)"
          mush-card-box-shadow: "0 16px 32px -20px var(--huskers-shadow-primary), 0 10px 20px -18px var(--huskers-shadow-secondary)"
          app-header-border-bottom: "1px solid rgba(255, 255, 255, 0.05)"
          label-badge-background-color: "#FFF4E6"
          label-badge-text-color: var(--ha-theme-color-dark)
          markdown-code-background-color: "#FFF2E6"
          table-row-background-color: "#FFF7EC"
          table-row-alternative-background-color: "#FFF2E0"

          # Mushroom cards
          mush-spacing: 12px
          mush-title-font-weight: 600
          mush-card-primary-background: "#FFFAF1"
          mush-card-secondary-background: "#FFF5E6"
          mush-card-primary-text-color: var(--ha-theme-color-dark)
          mush-card-secondary-text-color: var(--ha-theme-color-gray)
          mush-card-border-radius: 16px
          mush-card-border-width: 1px
          mush-card-border-color: "rgba(0, 0, 0, 0.08)"
          mush-icon-border-radius: 12px
          mush-control-border-radius: 12px
          mush-chip-border-radius: 12px
          mush-chip-background: "#F7EBDC"
          mush-chip-text-color: var(--ha-theme-color-dark)
          mush-chip-icon-color: var(--huskers-black)
          mush-rgb-primary: 17, 17, 17
          mush-rgb-accent: 228, 28, 56
          mush-rgb-info: 120, 16, 32
          mush-rgb-success: 34, 102, 68
          mush-rgb-warning: 200, 128, 32
          mush-rgb-danger: 228, 28, 56
          mush-rgb-state-entity: 17, 17, 17
          mush-rgb-state-switch: 228, 28, 56
          mush-rgb-state-media-player: 228, 28, 56

          # Huskers-specific CSS hooks
          --huskers-scoreboard-border: "3px solid var(--ha-theme-color-scarlet)"
          --huskers-scoreboard-shadow: "0 22px 40px -26px var(--huskers-shadow-primary), 0 18px 28px -28px var(--huskers-shadow-secondary)"
          --huskers-score-color: var(--ha-theme-color-scarlet)
          --huskers-text-primary: var(--ha-theme-color-dark)
          --huskers-text-secondary: var(--ha-theme-color-gray)

        dark:
          # Brand palette tuned for dark backgrounds
          --huskers-cream: "#FDF3E7"
          --huskers-scarlet: "#FF2C4A"
          --huskers-black: "#000000"
          --huskers-ink: "#F5F1EA"
          --huskers-muted: "#B8B8B8"
          --huskers-shadow-primary: "rgba(228, 44, 74, 0.55)"
          --huskers-shadow-secondary: "rgba(0, 0, 0, 0.55)"
          --ha-theme-color-scarlet: "#FF2C4A"
          --ha-theme-color-cream: "#FDF3E7"
          --ha-theme-color-dark: "#F5F1EA"
          --ha-theme-color-gray: "#B8B8B8"

          # Base application surfaces
          primary-background-color: "#111111"
          secondary-background-color: "#161616"
          card-background-color: "#1F1A1A"
          paper-card-background-color: "#1F1A1A"
          app-header-background-color: "#000000"
          app-header-text-color: var(--ha-theme-color-cream)
          app-header-icon-color: var(--ha-theme-color-cream)
          app-header-button-text-color: var(--ha-theme-color-cream)
          header-icon-color: var(--ha-theme-color-cream)
          sidebar-background-color: "#111111"
          sidebar-icon-color: var(--ha-theme-color-cream)
          sidebar-text-color: var(--ha-theme-color-cream)
          sidebar-selected-icon-color: var(--ha-theme-color-scarlet)
          sidebar-selected-text-color: var(--ha-theme-color-scarlet)
          divider-color: "rgba(253, 243, 231, 0.08)"

          # Typography & state colors
          primary-text-color: var(--ha-theme-color-cream)
          secondary-text-color: var(--ha-theme-color-gray)
          text-primary-color: var(--ha-theme-color-cream)
          disabled-text-color: "rgba(253, 243, 231, 0.4)"
          state-unavailable-color: "#6B6B6B"

          # Emphasis and accent colours
          primary-color: var(--huskers-cream)
          light-primary-color: "#FDF3E7"
          accent-color: var(--ha-theme-color-scarlet)
          state-icon-color: var(--huskers-cream)
          state-icon-active-color: var(--ha-theme-color-scarlet)
          paper-item-icon-color: var(--huskers-cream)
          paper-item-icon-active-color: var(--ha-theme-color-scarlet)

          # Buttons, controls, and MWC theme values
          switch-checked-color: var(--ha-theme-color-scarlet)
          switch-unchecked-color: "rgba(253, 243, 231, 0.35)"
          switch-checked-button-color: var(--ha-theme-color-cream)
          switch-unchecked-button-color: "rgba(253, 243, 231, 0.6)"
          slider-color: var(--ha-theme-color-scarlet)
          slider-secondary-color: "rgba(228, 44, 74, 0.35)"
          mdc-theme-primary: var(--ha-theme-color-scarlet)
          mdc-theme-secondary: var(--huskers-cream)
          mdc-theme-on-primary: var(--ha-theme-color-cream)
          mdc-theme-on-secondary: "#000000"
          mdc-theme-surface: var(--card-background-color)
          mdc-theme-on-surface: var(--primary-text-color)

          # Cards, layout polish, and gradient shadows
          ha-card-border-radius: "16px"
          ha-card-border-color: "rgba(253, 243, 231, 0.08)"
          ha-card-box-shadow: "0 28px 48px -24px var(--huskers-shadow-primary), 0 20px 32px -26px var(--huskers-shadow-secondary)"
          mush-card-box-shadow: "0 18px 40px -26px var(--huskers-shadow-primary), 0 12px 24px -18px var(--huskers-shadow-secondary)"
          app-header-border-bottom: "1px solid rgba(253, 243, 231, 0.08)"
          label-badge-background-color: "#1C1616"
          label-badge-text-color: var(--ha-theme-color-cream)
          markdown-code-background-color: "#221B1B"
          table-row-background-color: "#1A1515"
          table-row-alternative-background-color: "#1E1717"

          # Mushroom cards
          mush-spacing: 12px
          mush-title-font-weight: 600
          mush-card-primary-background: "#1F1A1A"
          mush-card-secondary-background: "#1A1515"
          mush-card-primary-text-color: var(--ha-theme-color-cream)
          mush-card-secondary-text-color: var(--ha-theme-color-gray)
          mush-card-border-radius: 16px
          mush-card-border-width: 1px
          mush-card-border-color: "rgba(253, 243, 231, 0.08)"
          mush-icon-border-radius: 12px
          mush-control-border-radius: 12px
          mush-chip-border-radius: 12px
          mush-chip-background: "#2A2020"
          mush-chip-text-color: var(--ha-theme-color-cream)
          mush-chip-icon-color: var(--ha-theme-color-scarlet)
          mush-rgb-primary: 253, 243, 231
          mush-rgb-accent: 255, 44, 74
          mush-rgb-info: 196, 36, 54
          mush-rgb-success: 124, 178, 128
          mush-rgb-warning: 230, 168, 64
          mush-rgb-danger: 255, 44, 74
          mush-rgb-state-entity: 253, 243, 231
          mush-rgb-state-switch: 255, 44, 74
          mush-rgb-state-media-player: 255, 44, 74

          # Huskers-specific CSS hooks
          --huskers-scoreboard-border: "3px solid var(--ha-theme-color-scarlet)"
          --huskers-scoreboard-shadow: "0 22px 40px -26px var(--huskers-shadow-primary), 0 18px 28px -28px var(--huskers-shadow-secondary)"
          --huskers-score-color: var(--ha-theme-color-scarlet)
          --huskers-text-primary: var(--ha-theme-color-dark)
          --huskers-text-secondary: var(--ha-theme-color-gray)
