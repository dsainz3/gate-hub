# =========================
# HUSKERS GAME SENSORS - FIXED
# =========================
- sensor:
    # Base score sensors (missing from your config)
    - name: 'Huskers Our Score'
      unique_id: huskers_our_score
      availability: "{{ has_value('sensor.husker_team') }}"
      state: "{{ state_attr('sensor.husker_team', 'team_score') | default(0) }}"
      icon: mdi:scoreboard
      attributes:
        friendly_name: 'Nebraska Score'

    - name: 'Huskers Opponent Score'
      unique_id: huskers_opponent_score
      availability: "{{ has_value('sensor.husker_team') }}"
      state: "{{ state_attr('sensor.husker_team', 'opponent_score') | default(0) }}"
      icon: mdi:scoreboard-outline
      attributes:
        friendly_name: 'Opponent Score'

    - name: 'Huskers Opponent Name'
      unique_id: huskers_opponent_name
      availability: "{{ has_value('sensor.husker_team') }}"
      state: "{{ state_attr('sensor.husker_team', 'opponent_name') | default('Unknown') }}"
      icon: mdi:shield
      attributes:
        friendly_name: 'Opponent Name'

    - name: 'Huskers Quarter'
      unique_id: huskers_quarter
      availability: "{{ has_value('sensor.husker_team') }}"
      state: "{{ state_attr('sensor.husker_team', 'quarter') | default('1') }}"
      icon: mdi:numeric
      attributes:
        friendly_name: 'Current Quarter'

    - name: 'Huskers Game Clock'
      unique_id: huskers_game_clock
      availability: "{{ has_value('sensor.husker_team') }}"
      state: "{{ state_attr('sensor.husker_team', 'clock') | default('15:00') }}"
      icon: mdi:clock-outline
      attributes:
        friendly_name: 'Game Clock'

    # Fixed kickoff timing sensor
    - name: 'Huskers Kickoff In'
      unique_id: huskers_kickoff_in
      device_class: duration
      unit_of_measurement: 'min'
      availability: >-
        {{ has_value('sensor.husker_team') and
           state_attr('sensor.husker_team', 'date') is not none }}
      state: >-
        {% set game_date = state_attr('sensor.husker_team', 'date') %}
        {% set kickoff_dt = as_datetime(game_date) %}
        {% if kickoff_dt %}
          {% set minutes_until = ((kickoff_dt - now()).total_seconds() / 60) | round(0) %}
          {{ [minutes_until, 0] | max }}
        {% else %}
          0
        {% endif %}
      icon: mdi:clock-outline
      attributes:
        friendly_name: 'Minutes Until Kickoff'
        kickoff_datetime: >-
          {% set game_date = state_attr('sensor.husker_team', 'date') %}
          {{ as_datetime(game_date) | as_local if game_date else none }}
        kickoff_formatted: >-
          {% set game_date = state_attr('sensor.husker_team', 'date') %}
          {% set dt = as_datetime(game_date) %}
          {% if dt %}
            {{ as_local(dt).strftime('%b %d, %Y at %I:%M %p %Z') }}
          {% else %}
            Unknown
          {% endif %}
        opponent: "{{ state_attr('sensor.husker_team', 'opponent_name') | default('Unknown') }}"
        location: "{{ state_attr('sensor.husker_team', 'location') | default('Unknown') }}"

    # Fixed game status sensor
    - name: 'Huskers Game Status'
      unique_id: huskers_game_status
      device_class: enum
      availability: "{{ has_value('sensor.huskers_kickoff_in') }}"
      state: >-
        {% set minutes_until = states('sensor.huskers_kickoff_in') | int(-1) %}
        {% if minutes_until < 0 %}
          finished
        {% elif 0 < minutes_until <= 120 %}
          pregame
        {% elif minutes_until > 120 %}
          scheduled
        {% else %}
          in_progress
        {% endif %}
      icon: >-
        {% set status = this.state %}
        {% if status == 'pregame' %}mdi:clock-fast
        {% elif status == 'in_progress' %}mdi:football
        {% elif status == 'finished' %}mdi:flag-checkered
        {% else %}mdi:calendar-clock
        {% endif %}
      attributes:
        friendly_name: 'Game Status'
        minutes_until_kickoff: "{{ states('sensor.huskers_kickoff_in') }}"

    # Fixed next game info
    - name: 'Huskers Next Game Info'
      unique_id: huskers_next_game_info
      availability: "{{ has_value('sensor.husker_team') }}"
      state: "{{ states('sensor.husker_team') }}"
      icon: mdi:football-helmet
      attributes:
        friendly_name: 'Next Game Information'
        game_date: "{{ state_attr('sensor.husker_team', 'date') }}"
        opponent: "{{ state_attr('sensor.husker_team', 'opponent_name') | default('Unknown') }}"
        location: "{{ state_attr('sensor.husker_team', 'venue') | default('Unknown') }}"
        team_rank: "{{ state_attr('sensor.husker_team', 'team_rank') | default('Unranked') }}"
        opponent_rank: "{{ state_attr('sensor.husker_team', 'opponent_rank') | default('Unranked') }}"

    # Next game start time
    - name: 'Huskers Next Game Start'
      unique_id: huskers_next_game_start
      availability: "{{ has_value('sensor.husker_team') }}"
      state: "{{ state_attr('sensor.husker_team', 'date') }}"
      icon: mdi:calendar-start
      attributes:
        friendly_name: 'Next Game Start Time'

    # Next game status
    - name: 'Huskers Next Game Status'
      unique_id: huskers_next_game_status
      availability: "{{ has_value('sensor.husker_team') }}"
      state: "{{ states('sensor.husker_team') }}"
      icon: mdi:information
      attributes:
        friendly_name: 'Next Game Status'

    # Formatted kickoff time in Central timezone
    - name: 'Huskers Kickoff (Central)'
      unique_id: huskers_kickoff_central
      icon: mdi:calendar-clock
      availability: >-
        {{ has_value('sensor.husker_team') and
           state_attr('sensor.husker_team', 'date') is not none }}
      state: >-
        {% set dt = as_datetime(state_attr('sensor.husker_team', 'date')) %}
        {% if dt %}
          {{ as_local(dt).strftime('%b %d, %Y at %I:%M %p %Z') }}
        {% else %}
          Unknown
        {% endif %}
      attributes:
        friendly_name: 'Kickoff Time (Local)'
        iso_format: >-
          {% set dt = as_datetime(state_attr('sensor.husker_team', 'date')) %}
          {{ as_local(dt).isoformat() if dt else none }}

    # Test score sensor for manual testing
    - name: 'Huskers Last Score (test)'
      unique_id: huskers_last_score_test
      availability: "{{ has_value('input_number.huskers_our_score') }}"
      state: "{{ states('input_number.huskers_our_score') | default(0) }}"
      icon: mdi:test-tube
      attributes:
        friendly_name: 'Last Test Score'
