# templates.yaml  (included via: template: !include templates.yaml)
# Do NOT add a top-level "template:" key here. 9

  - sensor:
    ########################################################################
    # WEATHER & ENVIRONMENT — normalized copies with stable units/classes
    ########################################################################
      - name: Relative Humidity
        unique_id: kneplatt72_relative_humidity_fixed
        state: "{{ states('sensor.kneplatt72_relative_humidity') }}"
        unit_of_measurement: '%'
        device_class: humidity

      - name: Solar Radiation
        unique_id: kneplatt72_solar_radiation_fixed
        availability: >-
          {{ states('sensor.kneplatt72_solar_radiation') not in ['', 'unknown', 'unavailable', None] }}
        state: >-
          {{ states('sensor.kneplatt72_solar_radiation') | float(0) }}
        unit_of_measurement: 'W/m²'
        device_class: irradiance
        state_class: measurement
        icon: mdi:weather-sunny
      - name: Temperature
        unique_id: kneplatt72_temperature_fixed
        availability: >-
          {{ states('sensor.kneplatt72_temperature') not in ['', 'unknown', 'unavailable', None] }}
        state: >-
          {{ states('sensor.kneplatt72_temperature') | float(0) }}
        unit_of_measurement: '°F'
        device_class: temperature

      - name: Heat Index
        unique_id: kneplatt72_heat_index_fixed
        availability: >-
          {{ states('sensor.kneplatt72_heat_index') not in ['', 'unknown', 'unavailable', None] }}
        state: >-
          {{ states('sensor.kneplatt72_heat_index') | float(0) }}
        unit_of_measurement: '°F'
        device_class: temperature

      - name: Wind Chill
        unique_id: kneplatt72_wind_chill_fixed
        availability: >-
          {{ states('sensor.kneplatt72_wind_chill') not in ['', 'unknown', 'unavailable', None] }}
        state: >-
          {{ states('sensor.kneplatt72_wind_chill') | float(0) }}
        unit_of_measurement: '°F'
        device_class: temperature

      - name: Dew Point
        unique_id: kneplatt72_dewpoint_fixed
        availability: >-
          {{ states('sensor.kneplatt72_dewpoint') not in ['', 'unknown', 'unavailable', None] }}
        state: >-
          {{ states('sensor.kneplatt72_dewpoint') | float(0) }}
        unit_of_measurement: '°F'
        device_class: temperature

      - name: Wind Speed
        unique_id: kneplatt72_wind_speed_fixed
        availability: >-
          {{ states('sensor.kneplatt72_wind_speed') not in ['', 'unknown', 'unavailable', None] }}
        state: >-
          {{ states('sensor.kneplatt72_wind_speed') | float(0) }}
        unit_of_measurement: 'mph'
        device_class: wind_speed

      - name: Wind Gust
        unique_id: kneplatt72_wind_gust_fixed
        availability: >-
          {{ states('sensor.kneplatt72_wind_gust') not in ['', 'unknown', 'unavailable', None] }}
        state: >-
          {{ states('sensor.kneplatt72_wind_gust') | float(0) }}
        unit_of_measurement: 'mph'
        device_class: wind_speed

    ########################################################################
    # WEATHER DERIVED — trends using existing WU change sensors
    ########################################################################
      - name: KNEPLATT72 Pressure Trend
        unique_id: kneplatt72_pressure_trend
        device_class: enum
        availability: >
          {{ has_value('sensor.kneplatt72_pressure') and has_value('sensor.kneplatt72_pressure_24h_change') }}
        state: >
          {% set unit = state_attr('sensor.kneplatt72_pressure', 'unit_of_measurement') | default('') %}
          {% set change = states('sensor.kneplatt72_pressure_24h_change') | float(0) %}
          {% set delta_inhg = change if unit == 'inHg'
              else (change / 33.8638866667) if unit in ['hPa', 'mbar']
              else change %}
          {% set threshold = 0.02 %}
          {% if delta_inhg >= threshold %}rising
          {% elif delta_inhg <= -threshold %}falling
          {% else %}steady
          {% endif %}
        icon: >
          {% if this.state == 'rising' %}mdi:arrow-up-bold
          {% elif this.state == 'falling' %}mdi:arrow-down-bold
          {% elif this.state == 'steady' %}mdi:swap-horizontal-bold
          {% else %}mdi:help-circle-outline
          {% endif %}
        attributes:
          friendly_name: Pressure Trend (24h)
          raw_change_value: "{{ states('sensor.kneplatt72_pressure_24h_change') }}"
          current_pressure: "{{ states('sensor.kneplatt72_pressure') }}"
          current_unit: "{{ state_attr('sensor.kneplatt72_pressure', 'unit_of_measurement') }}"
          delta_hpa: >
            {% set unit = state_attr('sensor.kneplatt72_pressure', 'unit_of_measurement') | default('') %}
            {% set change = states('sensor.kneplatt72_pressure_24h_change') | float(0) %}
            {{ (change if unit in ['hPa', 'mbar'] else (change * 33.8638866667))  | round(2) }}
          delta_inhg: >
            {% set unit = state_attr('sensor.kneplatt72_pressure', 'unit_of_measurement') | default('') %}
            {% set change = states('sensor.kneplatt72_pressure_24h_change') | float(0) %}
            {{ (change if unit == 'inHg' else (change / 33.8638866667)) | round(3) }}
          threshold_hpa: '0.68'
          threshold_inhg: '0.02'

      - name: KNEPLATT72 Temperature Trend
        unique_id: kneplatt72_temperature_trend
        device_class: enum
        availability: "{{ has_value('sensor.kneplatt72_temperature_24h_change') }}"
        state: >
          {% set change = states('sensor.kneplatt72_temperature_24h_change') | float('nan') %}
          {% if change == change %}
            {% set threshold = 2.0 %}
            {% if change > threshold %}rising
            {% elif change < -threshold %}falling
            {% else %}steady
            {% endif %}
          {% else %}unknown
          {% endif %}
        icon: >
          {% set change = states('sensor.kneplatt72_temperature_24h_change') | float(0) %}
          {% if change > 2.0 %}mdi:thermometer-chevron-up
          {% elif change < -2.0 %}mdi:thermometer-chevron-down
          {% else %}mdi:thermometer
          {% endif %}
        attributes:
          friendly_name: Temperature Trend (24h)
          delta_degf: "{{ states('sensor.kneplatt72_temperature_24h_change') | float(0) | round(1) }}"
          threshold_degf: '2.0'
          current_temperature: "{{ states('sensor.kneplatt72_temperature') }}"

      - name: KNEPLATT72 Humidity Trend
        unique_id: kneplatt72_humidity_trend
        device_class: enum
        availability: "{{ has_value('sensor.kneplatt72_humidity_24h_change') }}"
        state: >
          {% set change = states('sensor.kneplatt72_humidity_24h_change') | float('nan') %}
          {% if change == change %}
            {% set threshold = 5.0 %}
            {% if change > threshold %}rising
            {% elif change < -threshold %}falling
            {% else %}steady
            {% endif %}
          {% else %}unknown
          {% endif %}
        icon: >
          {% set change = states('sensor.kneplatt72_humidity_24h_change') | float(0) %}
          {% if change > 5.0 %}mdi:water-plus
          {% elif change < -5.0 %}mdi:water-minus
          {% else %}mdi:water-percent
          {% endif %}
        attributes:
          friendly_name: Humidity Trend (24h)
          delta_percent: "{{ states('sensor.kneplatt72_humidity_24h_change') | float(0) | round(1) }}"
          threshold_percent: '5.0'
          current_humidity: "{{ states('sensor.kneplatt72_relative_humidity') }}"

    ########################################################################
    # NETWORK / CONNECTIVITY
    ########################################################################
      - name: Network Active Hosts (Nmap)
        unique_id: network_nmap_active_hosts
        icon: mdi:lan
        availability: "{{ integration_entities('nmap_tracker') | length > 0 }}"
        state: >
          {% set nmap_entities = integration_entities('nmap_tracker') | default([]) %}
          {% set active_devices = expand(nmap_entities)
              | selectattr('domain', 'equalto', 'device_tracker')
              | selectattr('state', 'equalto', 'home')
              | list %}
          {{ active_devices | length }}
        attributes:
          friendly_name: Active Network Hosts
          total_tracked: >
            {% set nmap_entities = integration_entities('nmap_tracker') | default([]) %}
            {{ expand(nmap_entities) | selectattr('domain', 'equalto', 'device_tracker') | list | length }}
          integration: nmap_tracker

      - name: Network Clients Online (TP-Link)
        unique_id: network_tplink_clients_online
        icon: mdi:wifi
        availability: "{{ integration_entities('tplink_router') | length > 0 }}"
        state: >
          {% set tplink_entities = integration_entities('tplink_router') | default([]) %}
          {% set online_devices = expand(tplink_entities)
              | selectattr('domain', 'equalto', 'device_tracker')
              | selectattr('state', 'equalto', 'home')
              | list %}
          {{ online_devices | length }}
        attributes:
          friendly_name: TP-Link Clients Online
          integration: tplink_router

      - name: Internet Connectivity Status
        unique_id: internet_connectivity_status
        availability: "{{ has_value('binary_sensor.internet_reachable') }}"
        state: >
          {% if is_state('binary_sensor.internet_reachable', 'on') %}
            {% set latency = states('sensor.internet_reachable_latency') | float(-1) %}
            {% if latency >= 0 %}
              Online ({{ latency | round(0) }}ms)
            {% else %}
              Online
            {% endif %}
          {% else %}
            Offline
          {% endif %}
        icon: >
          {% if is_state('binary_sensor.internet_reachable', 'on') %}mdi:check-network
          {% else %}mdi:close-network
          {% endif %}
        attributes:
          friendly_name: Internet Status
          is_online: "{{ is_state('binary_sensor.internet_reachable', 'on') }}"
          latency_ms: "{{ states('sensor.internet_reachable_latency') | float(-1) | round(0) }}"

    ########################################################################
    # HUSKERS — TeamTracker helpers (kept separate from ESPN package)
    ########################################################################
      - name: husker_team_buffered
        unique_id: husker_team_buffered
        icon: mdi:football-helmet
        availability: "{{ has_value('sensor.husker_team') }}"
        state: "{{ states('sensor.husker_team') }}"
        attributes:
          sport: "{{ state_attr('sensor.husker_team','sport') }}"
          sport_path: "{{ state_attr('sensor.husker_team','sport_path') }}"
          league: "{{ state_attr('sensor.husker_team','league') }}"
          league_path: "{{ state_attr('sensor.husker_team','league_path') }}"
          league_logo: "{{ state_attr('sensor.husker_team','league_logo') }}"
          season: "{{ state_attr('sensor.husker_team','season') }}"
          team_abbr: "{{ state_attr('sensor.husker_team','team_abbr') }}"
          opponent_abbr: "{{ state_attr('sensor.husker_team','opponent_abbr') }}"
          event_name: "{{ state_attr('sensor.husker_team','event_name') }}"
          event_url: "{{ state_attr('sensor.husker_team','event_url') }}"
          date: "{{ state_attr('sensor.husker_team','date') }}"
          kickoff_in: "{{ state_attr('sensor.husker_team','kickoff_in') }}"
          series_summary: "{{ state_attr('sensor.husker_team','series_summary') }}"
          venue: "{{ state_attr('sensor.husker_team','venue') }}"
          location: "{{ state_attr('sensor.husker_team','location') }}"
          tv_network: "{{ state_attr('sensor.husker_team','tv_network') }}"
          odds: "{{ state_attr('sensor.husker_team','odds') }}"
          overunder: "{{ state_attr('sensor.husker_team','overunder') }}"
          team_name: "{{ state_attr('sensor.husker_team','team_name') }}"
          team_long_name: "{{ state_attr('sensor.husker_team','team_long_name') }}"
          team_id: "{{ state_attr('sensor.husker_team','team_id') }}"
          team_record: "{{ state_attr('sensor.husker_team','team_record') }}"
          team_rank: "{{ state_attr('sensor.husker_team','team_rank') }}"
          team_conference_id: "{{ state_attr('sensor.husker_team','team_conference_id') }}"
          team_homeaway: "{{ state_attr('sensor.husker_team','team_homeaway') }}"
          team_logo: "{{ state_attr('sensor.husker_team','team_logo') }}"
          team_url: "{{ state_attr('sensor.husker_team','team_url') }}"
          team_colors: "{{ state_attr('sensor.husker_team','team_colors') }}"
          team_score: "{{ states('sensor.huskers_our_score_effective') | int(0) }}"
          team_win_probability: "{{ state_attr('sensor.husker_team','team_win_probability') }}"
          team_winner: "{{ state_attr('sensor.husker_team','team_winner') }}"
          team_timeouts: "{{ state_attr('sensor.husker_team','team_timeouts') }}"
          opponent_name: "{{ state_attr('sensor.husker_team','opponent_name') }}"
          opponent_long_name: "{{ state_attr('sensor.husker_team','opponent_long_name') }}"
          opponent_id: "{{ state_attr('sensor.husker_team','opponent_id') }}"
          opponent_record: "{{ state_attr('sensor.husker_team','opponent_record') }}"
          opponent_rank: "{{ state_attr('sensor.husker_team','opponent_rank') }}"
          opponent_conference_id: "{{ state_attr('sensor.husker_team','opponent_conference_id') }}"
          opponent_homeaway: "{{ state_attr('sensor.husker_team','opponent_homeaway') }}"
          opponent_logo: "{{ state_attr('sensor.husker_team','opponent_logo') }}"
          opponent_url: "{{ state_attr('sensor.husker_team','opponent_url') }}"
          opponent_colors: "{{ state_attr('sensor.husker_team','opponent_colors') }}"
          opponent_score: "{{ states('sensor.huskers_opponent_score_effective') | int(0) }}"
          opponent_win_probability: "{{ state_attr('sensor.husker_team','opponent_win_probability') }}"
          opponent_winner: "{{ state_attr('sensor.husker_team','opponent_winner') }}"
          opponent_timeouts: "{{ state_attr('sensor.husker_team','opponent_timeouts') }}"
          quarter: "{{ states('sensor.huskers_quarter_effective') }}"
          clock: "{{ states('sensor.huskers_game_clock_effective') }}"
          possession: "{{ state_attr('sensor.husker_team','possession') }}"
          last_play: "{{ state_attr('sensor.husker_team','last_play') }}"
          down_distance_text: "{{ state_attr('sensor.husker_team','down_distance_text') }}"
          outs: "{{ state_attr('sensor.husker_team','outs') }}"
          balls: "{{ state_attr('sensor.husker_team','balls') }}"
          strikes: "{{ state_attr('sensor.husker_team','strikes') }}"
          on_first: "{{ state_attr('sensor.husker_team','on_first') }}"
          on_second: "{{ state_attr('sensor.husker_team','on_second') }}"
          on_third: "{{ state_attr('sensor.husker_team','on_third') }}"
          team_shots_on_target: "{{ state_attr('sensor.husker_team','team_shots_on_target') }}"
          team_total_shots: "{{ state_attr('sensor.husker_team','team_total_shots') }}"
          opponent_shots_on_target: "{{ state_attr('sensor.husker_team','opponent_shots_on_target') }}"
          opponent_total_shots: "{{ state_attr('sensor.husker_team','opponent_total_shots') }}"
          team_sets_won: "{{ state_attr('sensor.husker_team','team_sets_won') }}"
          opponent_sets_won: "{{ state_attr('sensor.husker_team','opponent_sets_won') }}"
          last_update: "{{ state_attr('sensor.husker_team','last_update') }}"
          api_message: "{{ state_attr('sensor.husker_team','api_message') }}"
          api_url: "{{ state_attr('sensor.husker_team','api_url') }}"

      - name: huskers_our_score
        unique_id: huskers_our_score_effective_alias
        state: "{{ states('sensor.huskers_our_score_effective') | int(0) }}"

      - name: huskers_opponent_score
        unique_id: huskers_opponent_score_effective_alias
        state: "{{ states('sensor.huskers_opponent_score_effective') | int(0) }}"

      - name: huskers_team_name
        unique_id: huskers_team_name_tt
        state: "{{ state_attr('sensor.husker_team','team_long_name') or 'Nebraska Cornhuskers' }}"

      - name: huskers_opponent_name
        unique_id: huskers_opponent_name_tt
        state: "{{ state_attr('sensor.husker_team','opponent_long_name') or 'Opponent' }}"

      - name: huskers_team_score
        unique_id: huskers_team_score_tt
        state: "{{ states('sensor.huskers_our_score_effective') | int(0) }}"

      - name: huskers_opponent_score
        unique_id: huskers_opponent_score_tt
        state: "{{ states('sensor.huskers_opponent_score_effective') | int(0) }}"

      - name: Huskers Quarter
        unique_id: huskers_quarter
        availability: "{{ has_value('sensor.husker_team') }}"
        state: "{{ states('sensor.huskers_quarter_effective') or '1' }}"
        icon: mdi:numeric

      - name: huskers_game_clock_ct
        unique_id: huskers_game_clock_ct_tt
        state: "{{ states('sensor.huskers_game_clock_effective') }}"

      - name: huskers_game_clock
        unique_id: huskers_game_clock_effective_alias
        state: "{{ states('sensor.huskers_game_clock_effective') }}"

      - name: huskers_kickoff_time_ct
        unique_id: huskers_kickoff_time_ct_tt
        state: >-
          {% set iso = state_attr('sensor.husker_team','date') %}
          {% if iso not in [None, '', 'unknown', 'unavailable'] %}
            {% set ts = as_timestamp(iso) %}
            {% if ts is not none %}
              {{ ts | timestamp_custom('%-I:%M %p CT', True) }}
            {% else %}
              unknown
            {% endif %}
          {% else %}
            unknown
          {% endif %}

    # Keep this alias so your recorder/dashboard references to sensor.huskers_kickoff_in keep working.
    # It’s always numeric to avoid the "non-numeric 'unknown'" error.
      - name: huskers_kickoff_in
        unique_id: huskers_kickoff_in_alias
        unit_of_measurement: 'min'
        state: "{{ states('sensor.huskers_kickoff_in_effective') | int(0) }}"
      - name: huskers_team_logo
        unique_id: huskers_team_logo_tt
        icon: mdi:shield-football
        availability: "{{ has_value('sensor.husker_team') }}"
        state: "{{ state_attr('sensor.husker_team','team_logo') or '' }}"

      - name: huskers_opponent_logo
        unique_id: huskers_opponent_logo_tt
        icon: mdi:shield-outline
        availability: "{{ has_value('sensor.husker_team') }}"
        state: "{{ state_attr('sensor.husker_team','opponent_logo') or '' }}"

      - name: huskers_team_record
        unique_id: huskers_team_record_tt
        icon: mdi:clipboard-text
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set rec = state_attr('sensor.husker_team','team_record') %}
          {% if rec in [None,'','unknown','unavailable'] %}
            {% set fallback = states('sensor.huskers_record_dashboard') %}
            {% if fallback in ['unknown','unavailable','None',''] %}
              N/A
            {% else %}
              {{ fallback }}
            {% endif %}
          {% else %}
            {{ rec }}
          {% endif %}

      - name: huskers_opponent_record
        unique_id: huskers_opponent_record_tt
        icon: mdi:clipboard-text-outline
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set rec = state_attr('sensor.husker_team','opponent_record') %}
          {% if rec in [None,'','unknown','unavailable'] %}
            N/A
          {% else %}
            {{ rec }}
          {% endif %}

      - name: huskers_team_rank
        unique_id: huskers_team_rank_tt
        icon: mdi:numeric-1-box
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set rank = state_attr('sensor.husker_team','team_rank') %}
          {% if rank in [None,'','unknown','unavailable'] %}
            Unranked
          {% else %}
            #{{ rank }}
          {% endif %}

      - name: huskers_opponent_rank
        unique_id: huskers_opponent_rank_tt
        icon: mdi:numeric-1-box-multiple
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set rank = state_attr('sensor.husker_team','opponent_rank') %}
          {% if rank in [None,'','unknown','unavailable'] %}
            Unranked
          {% else %}
            #{{ rank }}
          {% endif %}

      - name: huskers_event_url
        unique_id: huskers_event_url_tt
        icon: mdi:link-variant
        availability: "{{ has_value('sensor.husker_team') }}"
        state: "{{ state_attr('sensor.husker_team','event_url') or 'https://www.espn.com/college-football/' }}"

      - name: huskers_venue
        unique_id: huskers_venue_tt
        icon: mdi:stadium
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set venue = state_attr('sensor.husker_team','venue') %}
          {% if venue in [None,'','unknown','unavailable'] %}
            Venue TBA
          {% else %}
            {{ venue }}
          {% endif %}

      - name: huskers_location
        unique_id: huskers_location_tt
        icon: mdi:map-marker
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set loc = state_attr('sensor.husker_team','location') %}
          {% if loc in [None,'','unknown','unavailable'] %}
            Location TBA
          {% else %}
            {{ loc }}
          {% endif %}

      - name: huskers_tv_network
        unique_id: huskers_tv_network_tt
        icon: mdi:television-play
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set tv = state_attr('sensor.husker_team','tv_network') %}
          {% if tv in [None,'','unknown','unavailable'] %}
            Network TBA
          {% else %}
            {{ tv }}
          {% endif %}

      - name: huskers_odds
        unique_id: huskers_odds_tt
        icon: mdi:chart-line
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set odds = state_attr('sensor.husker_team','odds') %}
          {% if odds in [None,'','unknown','unavailable'] %}
            Line TBA
          {% else %}
            {{ odds }}
          {% endif %}

      - name: huskers_overunder
        unique_id: huskers_overunder_tt
        icon: mdi:scale-balance
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set ou = state_attr('sensor.husker_team','overunder') %}
          {% if ou in [None,'','unknown','unavailable'] %}
            O/U TBA
          {% else %}
            O/U {{ ou }}
          {% endif %}

      - name: huskers_series_summary
        unique_id: huskers_series_summary_tt
        icon: mdi:history
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set summary = state_attr('sensor.husker_team','series_summary') %}
          {% if summary in [None,'','unknown','unavailable'] %}
            Series history unavailable
          {% else %}
            {{ summary }}
          {% endif %}

      - name: huskers_last_play
        unique_id: huskers_last_play_tt
        icon: mdi:football
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set play = state_attr('sensor.husker_team','last_play') %}
          {% if play in [None,'','unknown','unavailable'] %}
            No recent play
          {% else %}
            {{ play }}
          {% endif %}

      - name: huskers_down_distance
        unique_id: huskers_down_distance_tt
        icon: mdi:numeric
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set info = state_attr('sensor.husker_team','down_distance_text') %}
          {% if info in [None,'','unknown','unavailable'] %}
            N/A
          {% else %}
            {{ info }}
          {% endif %}

      - name: huskers_possession
        unique_id: huskers_possession_tt
        icon: mdi:football-helmet
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set pos = state_attr('sensor.husker_team','possession') %}
          {% set huskers_id = state_attr('sensor.husker_team','team_id') %}
          {% set opp_id = state_attr('sensor.husker_team','opponent_id') %}
          {% if pos in [None,'','unknown','unavailable'] %}
            None
          {% elif pos|string == huskers_id|string %}
            Nebraska
          {% elif pos|string == opp_id|string %}
            {{ state_attr('sensor.husker_team','opponent_long_name') or 'Opponent' }}
          {% else %}
            {{ pos }}
          {% endif %}

      - name: huskers_team_timeouts
        unique_id: huskers_team_timeouts_tt
        icon: mdi:timer-outline
        availability: >-
          {% set to = state_attr('sensor.husker_team','team_timeouts') %}
          {{ to not in [None, '', 'unknown', 'unavailable'] }}
        state: >-
          {% set to = state_attr('sensor.husker_team','team_timeouts') %}
          {{ to | int(0) }}

      - name: huskers_opponent_timeouts
        unique_id: huskers_opponent_timeouts_tt
        icon: mdi:timer-sand
        availability: >-
          {% set to = state_attr('sensor.husker_team','opponent_timeouts') %}
          {{ to not in [None, '', 'unknown', 'unavailable'] }}
        state: >-
          {% set to = state_attr('sensor.husker_team','opponent_timeouts') %}
          {{ to | int(0) }}

      - name: huskers_win_probability
        unique_id: huskers_win_probability_tt
        icon: mdi:percent
        unit_of_measurement: '%'
        availability: >-
          {% set prob = state_attr('sensor.husker_team','team_win_probability') %}
          {{ prob not in [None, '', 'unknown', 'unavailable'] }}
        state: >-
          {% set prob = state_attr('sensor.husker_team','team_win_probability') %}
          {{ (prob | float(0) * 100) | round(1) }}

      - name: huskers_opponent_win_probability
        unique_id: huskers_opponent_win_probability_tt
        icon: mdi:percent-outline
        unit_of_measurement: '%'
        availability: >-
          {% set prob = state_attr('sensor.husker_team','opponent_win_probability') %}
          {{ prob not in [None, '', 'unknown', 'unavailable'] }}
        state: >-
          {% set prob = state_attr('sensor.husker_team','opponent_win_probability') %}
          {{ (prob | float(0) * 100) | round(1) }}

      - name: huskers_game_phase_label
        unique_id: huskers_game_phase_label_tt
        icon: mdi:timeline-clock
        availability: '{{ True }}'
        state: >-
          {% set phase = states('sensor.husker_team') %}
          {% set status = states('sensor.huskers_game_status_espn') %}
          {% set mapping = {'PRE':'Pregame','IN':'Live Game','POST':'Final'} %}
          {% if phase in mapping %}
            {{ mapping[phase] }}
          {% elif status not in ['unknown','unavailable',''] %}
            {{ status }}
          {% else %}
            Game status unavailable
          {% endif %}

      - name: huskers_game_detail
        unique_id: huskers_game_detail_tt
        icon: mdi:information-outline
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set kickoff = states('sensor.huskers_kickoff_time_ct') %}
          {% set tv = state_attr('sensor.husker_team','tv_network') %}
          {% set odds = state_attr('sensor.husker_team','odds') %}
          {% set loc = state_attr('sensor.husker_team','location') %}
          {% set parts = [] %}
          {% if kickoff not in ['unknown','unavailable',''] %}
            {% set parts = parts + [kickoff] %}
          {% endif %}
          {% if tv not in [None,'','unknown','unavailable'] %}
            {% set parts = parts + [tv] %}
          {% endif %}
          {% if odds not in [None,'','unknown','unavailable'] %}
            {% set parts = parts + [odds] %}
          {% endif %}
          {% if loc not in [None,'','unknown','unavailable'] %}
            {% set parts = parts + [loc] %}
          {% endif %}
          {% if parts %}
            {{ parts | join(' | ') }}
          {% else %}
            Details unavailable
          {% endif %}
      - name: huskers_tailgate_countdown
        unique_id: huskers_tailgate_countdown_tt
        icon: mdi:party-popper
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set iso = state_attr('sensor.husker_team', 'date') %}
          {% set kickoff = as_timestamp(iso, default=None) %}
          {% set now_ts = now().timestamp() %}
          {% set live = is_state('binary_sensor.huskers_is_live_espn', 'on') %}
          {% set postgame = is_state('binary_sensor.huskers_is_postgame_espn', 'on') %}
          {% set postgame_age = now_ts - as_timestamp(states.binary_sensor.huskers_is_postgame_espn.last_changed, default=0) %}
          {% set show = False %}
          {% if kickoff is not none %}
            {% if now_ts >= kickoff - 86400 %}
              {% set show = True %}
            {% endif %}
            {% if now_ts > kickoff + 14400 and not live and not postgame %}
              {% set show = False %}
            {% endif %}
            {% if postgame %}
              {% if postgame_age <= 1800 %}
                {% set show = True %}
              {% else %}
                {% set show = False %}
              {% endif %}
            {% endif %}
          {% endif %}
          {% if not show %}
            Idle
          {% elif kickoff is none %}
            Kickoff time TBD
          {% elif now_ts >= kickoff %}
            It's game time!
          {% else %}
            {% set remaining = kickoff - now_ts %}
            {% set total_minutes = (remaining / 60) | int(0) %}
            {% if total_minutes >= 1440 %}
              {% set days = total_minutes // 1440 %}
              {% set rem_minutes = total_minutes % 1440 %}
              {% set hours = rem_minutes // 60 %}
              {% set minutes = rem_minutes % 60 %}
              {{ days }}d {{ '%02d' % hours }}h {{ '%02d' % minutes }}m to kickoff
            {% elif total_minutes >= 60 %}
              {% set hours = total_minutes // 60 %}
              {% set minutes = total_minutes % 60 %}
              {{ hours }}h {{ '%02d' % minutes }}m to kickoff
            {% else %}
              {{ total_minutes }} minutes to kickoff
            {% endif %}
          {% endif %}

      - name: huskers_hype_message
        unique_id: huskers_hype_message_tt
        icon: mdi:bullhorn
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set phase = states('sensor.husker_team') %}
          {% if phase == 'IN' %}
            On your feet—make Memorial Stadium shake!
          {% elif phase == 'PRE' %}
            Tailgate mode: get the speakers blasting and paint the town scarlet.
          {% elif phase == 'POST' %}
            Celebrate the result and light the victory lights!
          {% else %}
            Forever Huskers. GO BIG RED!
          {% endif %}

      - name: huskers_fight_song_verse
        unique_id: huskers_fight_song_verse_tt
        icon: mdi:music-circle
        availability: '{{ True }}'
        state: >-
          There is no place like Nebraska—dear old Nebraska U! We'll all stick together, in all kinds of weather, for dear old Nebraska U!
    ########################################################################
    # HUMIDOR - derived metrics
    ########################################################################
      - name: Humidor Temp Range Today
        unique_id: humidor_temp_range_today
        unit_of_measurement: '°F'
        availability: >-
          {% set max_v = state_attr('sensor.humidor_temp_stats_24h','max_value') %}
          {% set min_v = state_attr('sensor.humidor_temp_stats_24h','min_value') %}
          {{ max_v is number and min_v is number }}
        state: >-
          {% set max_v = state_attr('sensor.humidor_temp_stats_24h','max_value') %}
          {% set min_v = state_attr('sensor.humidor_temp_stats_24h','min_value') %}
          {% set diff = (max_v | float(0)) - (min_v | float(0)) %}
          {{ diff | round(1) }}

      - name: Humidor Humidity Range Today
        unique_id: humidor_humidity_range_today
        unit_of_measurement: '%'
        availability: >-
          {% set max_v = state_attr('sensor.humidor_humidity_stats_24h','max_value') %}
          {% set min_v = state_attr('sensor.humidor_humidity_stats_24h','min_value') %}
          {{ max_v is number and min_v is number }}
        state: >-
          {% set max_v = state_attr('sensor.humidor_humidity_stats_24h','max_value') %}
          {% set min_v = state_attr('sensor.humidor_humidity_stats_24h','min_value') %}
          {% set diff = (max_v | float(0)) - (min_v | float(0)) %}
          {{ diff | round(1) }}

      - name: Humidor Temperature Trend
        unique_id: humidor_temperature_trend
        state: >-
          {% set raw = states('sensor.humidor_temp_change_1h') %}
          {% if raw in ['unknown', 'unavailable', ''] %}
            Unknown
          {% else %}
            {% set delta = raw | float(0) %}
            {% if delta > 0.6 %}
              Rising
            {% elif delta < -0.6 %}
              Falling
            {% else %}
              Stable
            {% endif %}
          {% endif %}
        icon: >-
          {% set delta = states('sensor.humidor_temp_change_1h') | float(0) %}
          {% if delta > 0.6 %}
            mdi:trending-up
          {% elif delta < -0.6 %}
            mdi:trending-down
          {% else %}
            mdi:trending-neutral
          {% endif %}

      - name: Humidor System Status
        unique_id: humidor_system_status
        state: >-
          {% set temp_state = states('sensor.hygrometer_humidor_temperature') %}
          {% set hum_state = states('sensor.hygrometer_humidor_humidity') %}
          {% if temp_state in ['unknown','unavailable',''] or hum_state in ['unknown','unavailable',''] %}
            Data Pending
          {% else %}
            {% set temp = temp_state | float(0) %}
            {% set hum = hum_state | float(0) %}
            {% if 68 <= temp <= 72 and 62 <= hum <= 68 %}
              Optimal
            {% elif 66 <= temp <= 74 and 58 <= hum <= 70 %}
              Acceptable
            {% else %}
              Attention
            {% endif %}
          {% endif %}
        icon: >-
          {% set temp_state = states('sensor.hygrometer_humidor_temperature') %}
          {% set hum_state = states('sensor.hygrometer_humidor_humidity') %}
          {% if temp_state in ['unknown','unavailable',''] or hum_state in ['unknown','unavailable',''] %}
            mdi:help-circle
          {% else %}
            {% set temp = temp_state | float(0) %}
            {% set hum = hum_state | float(0) %}
            {% if 68 <= temp <= 72 and 62 <= hum <= 68 %}
              mdi:checkbox-marked-circle
            {% elif 66 <= temp <= 74 and 58 <= hum <= 70 %}
              mdi:alert-circle-check
            {% else %}
              mdi:alert
            {% endif %}
          {% endif %}
        attributes:
          temperature_f: "{{ states('sensor.hygrometer_humidor_temperature') }}"
          humidity_percent: "{{ states('sensor.hygrometer_humidor_humidity') }}"
          temperature_trend: "{{ states('sensor.humidor_temperature_trend') }}"

      - name: Humidor System Health
        unique_id: humidor_system_health
        unit_of_measurement: '%'
        availability: >-
          {% set status = states('sensor.humidor_system_status') %}
          {{ status not in ['unknown', 'unavailable', ''] }}
        state: >-
          {% set status = states('sensor.humidor_system_status') %}
          {% if status == 'Optimal' %}
            100
          {% elif status == 'Acceptable' %}
            75
          {% elif status == 'Attention' %}
            40
          {% else %}
            0
          {% endif %}
        icon: >-
          {% set status = states('sensor.humidor_system_status') %}
          {% if status == 'Optimal' %}
            mdi:emoticon-happy
          {% elif status == 'Acceptable' %}
            mdi:emoticon-neutral
          {% elif status == 'Attention' %}
            mdi:emoticon-sad
          {% else %}
            mdi:emoticon-question
          {% endif %}

      - name: Support Test Resources Briefing
        unique_id: support_test_resources_briefing
        icon: mdi:account-tie
        availability: "{{ true }}"
        state: >-
          {% set invalid = ['', 'unknown', 'unavailable', none] %}
          {% set humidor_alert = is_state('binary_sensor.kiosk_humidor_out_of_band', 'on') %}
          {% set battery_entities = states | selectattr('attributes.device_class', 'eq', 'battery') | list %}
          {% set low_battery_ns = namespace(items=[]) %}
          {% for ent in battery_entities %}
            {% set state = ent.state | string %}
            {% if ent.domain == 'binary_sensor' %}
              {% if state == 'on' %}
                {% set low_battery_ns.items = low_battery_ns.items + [ent.name] %}
              {% endif %}
            {% else %}
              {% if state not in invalid %}
                {% set pct = state.replace('%', '') | float(100) %}
                {% if pct < 30 %}
                  {% set display = state if '%' in state else state ~ '%' %}
                  {% set low_battery_ns.items = low_battery_ns.items + [ent.name ~ ' (' ~ display ~ ')'] %}
                {% endif %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set network_state = states('sensor.network_status_summary') %}
          {% set network_alert = network_state not in invalid and network_state | lower != 'online' %}
          {% if humidor_alert or (low_battery_ns.items | length > 0) or network_alert %}
            attention
          {% else %}
            ok
          {% endif %}
        attributes:
          greeting: >-
            {% set hour = now().hour %}
            {% if hour < 12 %}
              Good morning
            {% elif hour < 17 %}
              Good afternoon
            {% else %}
              Good evening
            {% endif %}
          report_time: "{{ now().strftime('%-I:%M %p') }}"
          lights_on: >-
            {% set lights_group = expand('group.kiosk_all_lights_core') | default([]) %}
            {{ lights_group | selectattr('state', 'eq', 'on') | map(attribute='name') | list }}
          low_batteries: >-
            {% set invalid = ['', 'unknown', 'unavailable', none] %}
            {% set battery_entities = states | selectattr('attributes.device_class', 'eq', 'battery') | list %}
            {% set low_battery_ns = namespace(items=[]) %}
            {% for ent in battery_entities %}
              {% set state = ent.state | string %}
              {% if ent.domain == 'binary_sensor' %}
                {% if state == 'on' %}
                  {% set low_battery_ns.items = low_battery_ns.items + [ent.name] %}
                {% endif %}
              {% else %}
                {% if state not in invalid %}
                  {% set pct = state.replace('%', '') | float(100) %}
                  {% if pct < 30 %}
                    {% set display = state if '%' in state else (pct | round(0)) ~ '%' %}
                    {% set low_battery_ns.items = low_battery_ns.items + [ent.name ~ ' (' ~ display ~ ')'] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ low_battery_ns.items | unique | list }}
          active_scenes: >-
            {% set active = [] %}
            {% for ent in states.scene %}
              {% if ent.state == 'scening' %}
                {% set age = (now() - ent.last_changed).total_seconds() %}
                {% if age < 21600 %}
                  {% set active = active + [ent.name] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ active }}
          sprinkler_runtime_today: >-
            {% set invalid = ['', 'unknown', 'unavailable', none] %}
            {% set sensors = [
              'sensor.kiosk_sprinklers_south_side_runtime_today',
              'sensor.kiosk_sprinklers_back_south_runtime_today',
              'sensor.kiosk_sprinklers_back_north_runtime_today',
              'sensor.kiosk_sprinklers_front_runtime_today',
              'sensor.kiosk_sprinklers_zone5_runtime_today'
            ] %}
            {% set total = namespace(value=0) %}
            {% for entity_id in sensors %}
              {% set value = states(entity_id) %}
              {% if value not in invalid %}
                {% set total.value = total.value + (value | float(0)) %}
              {% endif %}
            {% endfor %}
            {% if total.value > 0 %}
              {{ (total.value | round(1)) }}
            {% else %}
              {{ none }}
            {% endif %}
          lights_briefing: >-
            {% set hour = now().hour %}
            {% if hour < 12 %}
              {% set greeting = 'Good morning' %}
            {% elif hour < 17 %}
              {% set greeting = 'Good afternoon' %}
            {% else %}
              {% set greeting = 'Good evening' %}
            {% endif %}
            {% set time_readout = now().strftime('%-I:%M %p') %}
            {% set lights_group = expand('group.kiosk_all_lights_core') | default([]) %}
            {% set on_lights = lights_group | selectattr('state', 'eq', 'on') | map(attribute='name') | list %}
            {% if on_lights %}
              {% set line_one = '- Lights currently on:\n  - ' ~ (on_lights | join('\n  - ')) %}
            {% else %}
              {% set line_one = '- All tracked lights are currently off.' %}
            {% endif %}
            {% set automations = states('binary_sensor.kiosk_automations_have_issues') %}
            {% set problem_count = states('sensor.kiosk_automations_problem_count') %}
            {% if automations == 'on' %}
              {% set line_two = '- Automation watchdog has flagged ' ~ (problem_count if problem_count not in ['', 'unknown', 'unavailable', none] else 'an issue') ~ '.' %}
            {% elif automations == 'off' %}
              {% set line_two = '- Automation watchdog reports a clean bill of health.' %}
            {% else %}
              {% set line_two = "- Automation watchdog status isn't available right now." %}
            {% endif %}
            {{ greeting ~ ", here's the lighting status as of " ~ time_readout ~ ":\n\n" ~ line_one ~ "\n" ~ line_two }}
          weather_briefing: >-
            {% set hour = now().hour %}
            {% if hour < 12 %}
              {% set greeting = 'Good morning' %}
            {% elif hour < 17 %}
              {% set greeting = 'Good afternoon' %}
            {% else %}
              {% set greeting = 'Good evening' %}
            {% endif %}
            {% set time_readout = now().strftime('%-I:%M %p') %}
            {% set invalid = ['', 'unknown', 'unavailable', none] %}
            {% set condition = states('weather.forecast_home') %}
            {% set temp = states('sensor.outdoor_temperature_wx') %}
            {% set humidity = states('sensor.outdoor_humidity_wx') %}
            {% set wind = states('sensor.outdoor_wind_speed_wx') %}
            {% set bearing = state_attr('weather.forecast_home', 'wind_bearing') %}
            {% if bearing not in invalid %}
              {% set dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'] %}
              {% set index = ((bearing | float(0) + 22.5) / 45) | int %}
              {% set wind_dir = dirs[index % 8] %}
            {% else %}
              {% set wind_dir = none %}
            {% endif %}
            {% set zones = [
              'switch.sprinkler_south_side_zone',
              'switch.sprinkler_back_south_zone',
              'switch.sprinkler_back_north_zone',
              'switch.sprinkler_front_zone',
              'switch.sprinkler_zone_5_zone'
            ] %}
            {% set running = [] %}
            {% for zone in zones %}
              {% if is_state(zone, 'on') %}
                {% set running = running + [state_attr(zone, 'friendly_name') | default(zone.split('.')[-1] | replace('_', ' ') | title)] %}
              {% endif %}
            {% endfor %}
            {% set schedule_on = is_state('switch.sprinkler_scheduled_program', 'on') %}
            {% set runtime_sensors = [
              'sensor.kiosk_sprinklers_south_side_runtime_today',
              'sensor.kiosk_sprinklers_back_south_runtime_today',
              'sensor.kiosk_sprinklers_back_north_runtime_today',
              'sensor.kiosk_sprinklers_front_runtime_today',
              'sensor.kiosk_sprinklers_zone5_runtime_today'
            ] %}
            {% set runtime_ns = namespace(total=0) %}
            {% for entity_id in runtime_sensors %}
              {% set value = states(entity_id) %}
              {% if value not in invalid %}
                {% set runtime_ns.total = runtime_ns.total + (value | float(0)) %}
              {% endif %}
            {% endfor %}
            {% if runtime_ns.total > 0 %}
              {% set runtime = runtime_ns.total | round(1) %}
            {% else %}
              {% set runtime = none %}
            {% endif %}
            {% if condition not in invalid or temp not in invalid %}
              {% set cond_line = '- Outside is ' ~ (condition | title if condition not in invalid else 'conditions unavailable') %}
              {% if temp not in invalid %}
                {% set cond_line = cond_line ~ ' at ' ~ temp ~ '°F' %}
              {% endif %}
              {% if humidity not in invalid %}
                {% set cond_line = cond_line ~ ' with ' ~ humidity ~ '% humidity' %}
              {% endif %}
              {% set cond_line = cond_line ~ '.' %}
            {% else %}
              {% set cond_line = "- I'm not seeing current outdoor readings." %}
            {% endif %}
            {% if wind not in invalid %}
              {% if wind_dir %}
                {% set wind_line = '- Wind running ' ~ wind ~ ' mph from the ' ~ wind_dir ~ '.' %}
              {% else %}
                {% set wind_line = '- Wind running ' ~ wind ~ ' mph.' %}
              {% endif %}
            {% else %}
              {% set wind_line = '' %}
            {% endif %}
            {% if running %}
              {% set sprinkler_line = '- Irrigation active on ' ~ (running | join(', ')) ~ '.' %}
            {% elif schedule_on %}
              {% set sprinkler_line = '- Irrigation schedule is armed and ready.' %}
            {% else %}
              {% set sprinkler_line = '- Irrigation schedule is idle.' %}
            {% endif %}
            {% if runtime not in [None, ''] %}
              {% set runtime_line = '- Runtime today totals ' ~ (runtime | float(0) | round(1)) ~ ' minutes.' %}
            {% else %}
              {% set runtime_line = '' %}
            {% endif %}
            {{ greeting ~ ", weather and sprinklers check-in at " ~ time_readout ~ ":\n\n" ~ cond_line ~ ("\n" ~ wind_line if wind_line else '') ~ "\n" ~ sprinkler_line ~ ("\n" ~ runtime_line if runtime_line else '') }}
          network_briefing: >-
            {% set hour = now().hour %}
            {% if hour < 12 %}
              {% set greeting = 'Good morning' %}
            {% elif hour < 17 %}
              {% set greeting = 'Good afternoon' %}
            {% else %}
              {% set greeting = 'Good evening' %}
            {% endif %}
            {% set time_readout = now().strftime('%-I:%M %p') %}
            {% set invalid = ['', 'unknown', 'unavailable', none] %}
            {% set network_status = states('sensor.network_status_summary') %}
            {% set performance = states('sensor.network_performance_summary') %}
            {% set download = states('sensor.speedtest_download') %}
            {% set upload = states('sensor.speedtest_upload') %}
            {% set ping = states('sensor.speedtest_ping') %}
            {% if network_status not in invalid %}
              {% if network_status | lower == 'online' %}
                {% set status_line = '- Core network is online and stable.' %}
              {% else %}
                {% set status_line = '- Core network reports ' ~ network_status | lower ~ '.' %}
              {% endif %}
            {% else %}
              {% set status_line = "- Network status isn't available right now." %}
            {% endif %}
            {% if download not in invalid and upload not in invalid and ping not in invalid %}
              {% set speed_line = '- Latest throughput: ↓ ' ~ download ~ ' Mbps · ↑ ' ~ upload ~ ' Mbps · Ping ' ~ ping ~ ' ms.' %}
            {% else %}
              {% set speed_line = "- Throughput metrics are unavailable." %}
            {% endif %}
            {% if performance not in invalid %}
              {% set perf_line = '- Performance watch: ' ~ performance | title ~ '.' %}
            {% else %}
              {% set perf_line = '' %}
            {% endif %}
            {{ greeting ~ ", networking status as of " ~ time_readout ~ ":\n\n" ~ status_line ~ "\n" ~ speed_line ~ ("\n" ~ perf_line if perf_line else '') }}
          sports_briefing: >-
            {% set hour = now().hour %}
            {% if hour < 12 %}
              {% set greeting = 'Good morning' %}
            {% elif hour < 17 %}
              {% set greeting = 'Good afternoon' %}
            {% else %}
              {% set greeting = 'Good evening' %}
            {% endif %}
            {% set time_readout = now().strftime('%-I:%M %p') %}
            {% set invalid = ['', 'unknown', 'unavailable', none] %}
            {% set huskers_team = states('sensor.huskers_team_name') %}
            {% set huskers_phase = states('sensor.huskers_game_phase_label') %}
            {% set huskers_opp = states('sensor.huskers_opponent_name_2') or states('sensor.huskers_opponent_name') %}
            {% set huskers_team_score = states('sensor.huskers_team_score') %}
            {% set huskers_opp_score = states('sensor.huskers_opponent_score_2') or states('sensor.huskers_opponent_score') %}
            {% if huskers_team not in invalid and huskers_phase not in invalid and huskers_opp not in invalid and huskers_team_score not in invalid and huskers_opp_score not in invalid %}
              {% set huskers_line = '- Huskers ' ~ huskers_team ~ ' ' ~ huskers_team_score ~ ' – ' ~ huskers_opp_score ~ ' ' ~ huskers_opp ~ ' · ' ~ huskers_phase ~ '.' %}
            {% else %}
              {% set huskers_line = "- Huskers update isn't available right now." %}
            {% endif %}
            {% set f1_name = states('sensor.f1_next_race_name') %}
            {% set f1_location = states('sensor.f1_next_race_location') %}
            {% set lights_out = states('sensor.f1_lights_out_local') %}
            {% set f1_round = states('sensor.f1_next_race_round') %}
            {% if lights_out not in invalid %}
              {% set lights_out_ts = as_timestamp(lights_out, default=None) %}
            {% else %}
              {% set lights_out_ts = none %}
            {% endif %}
            {% if f1_name not in invalid and f1_location not in invalid %}
              {% set round_readout = f1_round if f1_round not in invalid else 'TBA' %}
              {% if lights_out_ts is not none %}
                {% set lights_out_readable = lights_out_ts | timestamp_custom('%b %-d %-I:%M %p', True) %}
                {% set f1_line = '- Next F1 · ' ~ f1_name ~ ' (Round ' ~ round_readout ~ ') in ' ~ f1_location ~ ' · Lights out ' ~ lights_out_readable ~ '.' %}
              {% else %}
                {% set f1_line = '- Next F1 · ' ~ f1_name ~ ' (Round ' ~ round_readout ~ ') in ' ~ f1_location ~ ' · Lights out time TBA.' %}
              {% endif %}
            {% else %}
              {% set f1_line = "- Formula 1 schedule isn't available right now." %}
            {% endif %}
            {{ greeting ~ ", sports desk briefing at " ~ time_readout ~ ":\n\n" ~ huskers_line ~ "\n" ~ f1_line }}
          scene_briefing: >-
            {% set hour = now().hour %}
            {% if hour < 12 %}
              {% set greeting = 'Good morning' %}
            {% elif hour < 17 %}
              {% set greeting = 'Good afternoon' %}
            {% else %}
              {% set greeting = 'Good evening' %}
            {% endif %}
            {% set time_readout = now().strftime('%-I:%M %p') %}
            {% set active = [] %}
            {% for ent in states.scene %}
              {% if ent.state == 'scening' %}
                {% set age = (now() - ent.last_changed).total_seconds() %}
                {% if age < 21600 %}
                  {% set active = active + [ent.name] %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if active %}
              {% set line = '- Active scenes:\n  - ' ~ (active | join('\n  - ')) %}
            {% else %}
              {% set line = '- No tracked scenes are currently active.' %}
            {% endif %}
            {{ greeting ~ ", scene status checked at " ~ time_readout ~ ":\n\n" ~ line }}
  - binary_sensor:
      - name: huskers_tailgate_window
        unique_id: huskers_tailgate_window_tt
        icon: mdi:clock-start
        availability: "{{ has_value('sensor.husker_team') }}"
        state: >-
          {% set iso = state_attr('sensor.husker_team', 'date') %}
          {% set kickoff = as_timestamp(iso, default=None) %}
          {% set now_ts = now().timestamp() %}
          {% set live = is_state('binary_sensor.huskers_is_live_espn', 'on') %}
          {% set postgame = is_state('binary_sensor.huskers_is_postgame_espn', 'on') %}
          {% set postgame_age = now_ts - as_timestamp(states.binary_sensor.huskers_is_postgame_espn.last_changed, default=0) %}
          {% set show = False %}
          {% if kickoff is not none %}
            {% if now_ts >= kickoff - 86400 %}
              {% set show = True %}
            {% endif %}
            {% if now_ts > kickoff + 14400 and not live and not postgame %}
              {% set show = False %}
            {% endif %}
            {% if postgame %}
              {% if postgame_age <= 1800 %}
                {% set show = True %}
              {% else %}
                {% set show = False %}
              {% endif %}
            {% endif %}
          {% endif %}
          {{ show }}
